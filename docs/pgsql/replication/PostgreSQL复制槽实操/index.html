<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-pgsql/replication/PostgreSQL复制槽实操" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">PostgreSQL复制槽实操 | 编程之路</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://github.com/blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://github.com/blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://github.com/blog/docs/pgsql/replication/PostgreSQL复制槽实操"><meta data-rh="true" property="og:locale" content="zh_CN"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="PostgreSQL复制槽实操 | 编程之路"><meta data-rh="true" name="description" content="1 引言"><meta data-rh="true" property="og:description" content="1 引言"><link data-rh="true" rel="icon" href="/blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://github.com/blog/docs/pgsql/replication/PostgreSQL复制槽实操"><link data-rh="true" rel="alternate" href="https://github.com/blog/docs/pgsql/replication/PostgreSQL复制槽实操" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://github.com/blog/docs/pgsql/replication/PostgreSQL复制槽实操" hreflang="x-default"><link rel="stylesheet" href="/blog/assets/css/styles.38da314a.css">
<script src="/blog/assets/js/runtime~main.7a87f3fa.js" defer="defer"></script>
<script src="/blog/assets/js/main.5655fcd3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/blog/"></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/docs/intro">k8s修仙指南</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/growdu/k8s_god" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/blog/docs/intro">编程之路</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/blog/docs/how_to_learn_program">&lt;center&gt;如何学习编程&lt;/center&gt;</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/alg/B-树如何使查询更快">alg</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/blog/docs/base/">&lt;center&gt;写在前面&lt;/center&gt;</a><button aria-label="展开侧边栏分类 &#x27;&lt;center&gt;写在前面&lt;/center&gt;&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/chatgpt/chatgpt使用">chatgpt</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/cluster/C语言实现分布式自增有序的唯一ID生成算法-snowflake算法">cluster</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/code/JavaScript-work/">code</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/db/postgresql/part1">db</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/docker/docker_communication_with_host">docker</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/dpdk/day1">dpdk</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/edit/docusaurus自定义渲染内容">edit</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/es/Search UI with Elasticsearch  Elastic docs --- 使用 Elasticsearch 的搜索用户界面 弹性文档">es</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/faq/faq汇总">faq</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/blog/docs/go_web/">rest api</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/language/C语言内存使用血与泪教训">language</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/linux/centos搭建离线仓库">linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/mail/email编程">mail</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/network/C语言网络编程库选择">network</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/openguass/opengauss dcf搭建 - 墨天轮">openguass</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/blog/docs/page/">&lt;center&gt;说明&lt;/center&gt;</a><button aria-label="展开侧边栏分类 &#x27;&lt;center&gt;说明&lt;/center&gt;&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/blog/docs/pgsql/PostgreSQL 时间线解析">pgsql</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/PostgreSQL 时间线解析">PostgreSQL 时间线解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/Postgres中postmaster代码解析(--boot和--single)">Postgres中postmaster代码解析(--boot和--single)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/checkpoint机制浅析">checkpoint机制浅析</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/blog/docs/pgsql/debug/code-server调试postgresql">debug</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/blog/docs/pgsql/executor/PostgreSQL的insert语句执行过程分析 - 墨天轮">executor</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/blog/docs/pgsql/extension/pgsql扩展">extension</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/blog/docs/pgsql/ha/repmgr实现原理">ha</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/insert_data">insert data</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/blog/docs/pgsql/kernel/Postgresql触发器详解">kernel</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/blog/docs/pgsql/pg_command/initdb">pg_command</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/pg_complie_and_run">pg编译运行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/pg_io_调优">pg_io_调优</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/pg_replication">pg_replication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/pgsql_main_structure">pgsql架构</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/pg源码对象管理">pg源码对象管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/postgresql——流复制和wal日志（八）">postgresql——流复制和wal日志（八）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/postgresql启动流程">postgresql 启动流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/postgresql基操">postgresql基本操作与基本对象</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/postgresql源码编译">postgresql 源码编译</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/blog/docs/pgsql/process/BgWriter">process</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/blog/docs/pgsql/replication/PostgreSQL 同步流复制原理和代码浅析-阿里云开发者社区">replication</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/PostgreSQL 同步流复制原理和代码浅析-阿里云开发者社区">PostgreSQL 同步流复制原理和代码浅析-阿里云开发者社区</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/blog/docs/pgsql/replication/PostgreSQL复制槽实操">PostgreSQL复制槽实操</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/PostgreSQL数据库复制——后台一等公民进程WalReceiver&amp;startup交互_postgressql walreceive线程_肥叔菌的博客-CSDN博客">PostgreSQL数据库复制——后台一等公民进程WalReceiver&amp;startup交互_postgressql walreceive线程_肥叔菌的博客-CSDN博客</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/PostgreSQL的后台进程walsender分析 - 关系型数据库 - 亿速云">PostgreSQL的后台进程walsender分析 - 关系型数据库 - 亿速云</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/Postgresql存储、索引及系统优化、主备切换">0 Postgresql存储、索引及系统优化、主备切换</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/docker搭建Postgresql主备集群">docker搭建Postgresql主备集群</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/pg_logic_decode">pg_logical_decode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/pg_replication_keepalive">流复制心跳超时问题</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/pg_slot">pg_slot</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/pg_walreceiver">pg_walreceiver</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/pg_walsender">pg_walsender</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/postgresql startup处理 - postgresql内核分析 - SegmentFault 思否">postgresql startup处理 - postgresql内核分析 - SegmentFault 思否</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/postgresql流复制同异步分析">postgresql流复制同异步分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/replication/详解完整恢复及基于时间点的恢复">详解完整恢复及基于时间点的恢复</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/blog/docs/pgsql/repmgr/pgsql_repmgr">repmgr</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/sql_test">sql_test</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/stats/">stats</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/blog/docs/pgsql/storage/PosgreSQL FSM文件解析 – 蛋挞">storage</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/wal机制浅析">wal机制浅析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/pgsql/数据库崩溃恢复">数据库崩溃恢复</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/programmer_self_cultivation/linux生成coredump">programmer_self_cultivation</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/protocol/fib表">protocol</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/road/左耳朵耗子的话——关于技术的一些思考">road</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/storage/nfs详解">storage</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/blog/docs/tools/">readme</a><button aria-label="展开侧边栏分类 &#x27;readme&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/video_work/video">video_work</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/vpp/cdu_nxp2160_ptp1588v2实现方案">vpp</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/blog/docs/vue/5种回到顶部的写法从实现到增强 - 小火柴的蓝色理想 - 博客园">vue</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">pgsql</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">replication</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">PostgreSQL复制槽实操</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>PostgreSQL复制槽实操</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1引言">1 <strong>引言</strong><a href="#1引言" class="hash-link" aria-label="1引言的直接链接" title="1引言的直接链接">​</a></h2>
<p>看下官网的解释，复制槽提供了一种办法确保主库不会“删除”还未发送到备库的WAL日志，也不会删除备库需要的多版本，即使备库掉线。</p>
<p>2 <strong>相关参数</strong></p>
<p>wal_keep_segments：设置为较大值，保证pg_wal目录下保留较多的wal日志，主库上wal日志留存越多，允许备库宕机的时间越长，设置此参数需要注意不要将pg_wal目录撑满。或者在主库上开启归档，如果没有足够的硬盘空间保留wal归档，至少在备库停机维护时临时开启主库归档。如果备库落后主库wal_keep_segments数量的wal，则主库可能会删除备用服务器仍需要的wal，这种情况下，流复制就会中断。</p>
<p>hot_standby_feedback：备库定时将最小活跃事务ID(xmin)告诉master，使得 master在执行vacuum 时对备库还需要的tuple手下留情，但这样可能会导致主库膨胀，在每个wal_receiver_status_interval定义的周期内发送的频率不超过一次，并且此设置不会覆盖在主数据库上的old_snapshot_threshold行为。</p>
<p>max_standby_streaming_delay：通常会将一些执行时间较长的分析任务、统计SQL跑在备库上。在备库上执行长时间的查询，由于涉及的记录有可能在主库上被更新或删除，主库上对更新或删除数据的老版本进行vacuum后，从库上也会执行这个操作，从而与从库上的当前查询产生冲突。此参数默认为30s，当备库执行SQL时，有可能与正在应用的WAL发生冲突，此查询如果30s没有执行完就被中止，注意30s不是备库上单个查询允许的最大执行时间，是指当备库上应用WAL时允许的最大WAL延迟应用时间，因此备库上查询的执行时间有可能不到这个值就被中止了，此参数可以设置为-1，表示当从库上的WAL应用进程与从库上执行的查询冲突时，WAL应用进程一直等待直到从库查询执行完成。</p>
<p><img decoding="async" loading="lazy" src="https://mmbiz.qpic.cn/mmbiz_png/lniadOK6Dzb4Js6Vbw6iaPTWIAUEnmOF4r1RCgMqbobL8nskaNo1Ox1lh3IKZeialGrNjdKdwicG9vkEJQryl9f5Cg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片" class="img_ev3q"></p>
<p>old_snapshot_threshold：单位为min，最大可以设置为60天，当vacuum回收垃圾时，遇到垃圾记录的xmax大于数据库中现存的最早未提交事务xmin时，不会对其进行回收。因此当数据库中存在很久为结束的事务时，可能会导致数据库膨胀。此参数代表强制删除为过老的事务快照保留的死元组。这会导致长事务读取已被删除的tuple时出错。</p>
<p>vacuum_defer_cleanup_age：指定vacuum延迟清理死亡元组的事务数，vacuum会延迟清除无效的记录，延迟的事务个数通过vacuum_defer_cleanup_age进行设置。默认为0，在主库上设置一个稍大的值也可以减少冲突的发生，但是并不太好计量。</p>
<p>max_standby_archive_delay：备机因为处理归档的wal日志产生查询冲突而取消查询之前的等待时间，和上面的参数类似。</p>
<p>recovery_min_apply_delay：延迟备库设置备库延迟重做WAL的时间，而备库依然及时接收主库发送的WAL日志流，只是不是一接收到WAL后就立即应用，而是等待此参数设置的值再应用。使用此功能将延迟hot_standby_feedback，当synchronous_commit设置为remote_apply时，同步复制也会受此设置的影响，每个commit都需要等待。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3为啥要设复制槽">3 <strong>为啥要设复制槽</strong><a href="#3为啥要设复制槽" class="hash-link" aria-label="3为啥要设复制槽的直接链接" title="3为啥要设复制槽的直接链接">​</a></h2>
<p>前面所说的那么多参数，只有在主备关系正常时才能起到作用，而replication slot能够确保在主备断连后主库的wal仍不被清理，因为replication slot的状态信息是持久化保存的，即便从库断掉或主库重启，这些信息仍然不会丢掉或失效。</p>
<p>replication slots 是从postgresql 9.4引入的，主要是提供了一种自动化的方法来确保主库在所有的备库收到wal之前不会移除它们，并且主库也不会移除可能导致恢复冲突的行(需要配合hot_standby_feedback)，即使备库断开也是如此。</p>
<p>在没有启用replication slots的环境中，如果碰到 ERROR: requested WAL segment xxxx has already been removed 的错误，解决办法是要么提前开启了归档，要么重做slave，另外还可以在主库上设置 wal_keep_segments 为更大的值。当然，如果备库停机时间太长，可能主库的WAL日志目录会被撑满，如果设置了复制槽，建议将WAL日志目录放在大容量硬盘上。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4实战演示">4 <strong>实战演示</strong><a href="#4实战演示" class="hash-link" aria-label="4实战演示的直接链接" title="4实战演示的直接链接">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="41hot_standby_feedback">4.1 hot_standby_feedback<a href="#41hot_standby_feedback" class="hash-link" aria-label="4.1 hot_standby_feedback的直接链接" title="4.1 hot_standby_feedback的直接链接">​</a></h2>
<p>流复制搭建就不演示了，此处基于PostgreSQL12搭建的，在此就不再赘述，只是要注意原有的recovery.conf没有了，合到了postgresql.conf里面。</p>
<p>postgres=# select usename,client_addr,backend_xmin,sync_state from pg_stat_replication ;</p>
<p> usename  |   client_addr   | backend_xmin | sync_state</p>
<p>----------+-----------------+--------------+------------</p>
<p> postgres | 192.168.211.166 |              | sync</p>
<p>(1 row)</p>
<p>我把hot_standby_feedback主从都设为了off，查询pg_replication_slots可以看到xmin为空</p>
<p>postgres=# select * from pg_replication_slots ;</p>
<p> slot_name | plugin | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn</p>
<p>-----------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------</p>
<p> slot1     |        | physical  |        |          | f         | t      |       3743 |      |              | 4/38A410E0  |</p>
<p>(1 row)</p>
<p>模拟一下冲突的发生，先创建一张测试表test，插入4千万数据：</p>
<p>postgres=# insert into test values(generate_series(1,40000000));</p>
<p>INSERT 0 40000000</p>
<p>postgres=# analyze test;</p>
<p>ANALYZE</p>
<p>备库上执行一下查询：</p>
<p>postgres=# show hot_standby_feedback ;</p>
<p> hot_standby_feedback</p>
<p>----------------------</p>
<p> off</p>
<p>(1 row)</p>
<p>postgres=# select count(*) from test where id = 6666666;</p>
<p>此处夯住...</p>
<p>主库上删除id为6666666的数据，然后做一下vacuum：</p>
<p>postgres=# delete from test where id = 6666666;</p>
<p>DELETE 2</p>
<p>postgres=# vacuum test;</p>
<p>VACUUM</p>
<p>这个时候再去备库上，查询会报错：</p>
<p>postgres=# select count(*) from test where id = 6666666;</p>
<p>FATAL:  terminating connection due to conflict with recovery</p>
<p>DETAIL:  User query might have needed to see row versions that must be removed.</p>
<p>HINT:  In a moment you should be able to reconnect to the database and repeat your command.</p>
<p>ERROR:  canceling statement due to conflict with recovery</p>
<p>DETAIL:  User query might have needed to see row versions that must be removed.</p>
<p>看下vacuum里的逻辑，</p>
<p>/*</p>
<p> * Deleter committed, but perhaps it was recent enough that some open</p>
<p> * transactions could still see the tuple.</p>
<p> */</p>
<p>if (!TransactionIdPrecedes(HeapTupleHeaderGetRawXmax(tuple), OldestXmin))</p>
<p>return HEAPTUPLE_RECENTLY_DEAD;</p>
<p>/* Otherwise, it&#x27;s dead and removable */</p>
<p>return HEAPTUPLE_DEAD;</p>
<p>}</p>
<p>该函数计算当前tuple的xmax是否大于或等于OldestXmin。xmax是删除这个tuple的事务ID，而OldestXmin由GetOldestXmin函数计算，是所有活跃事务的ID，以及所有事务的xmin 组成的集合中最小的事务ID。所有ID大于这个OldestXmin的事务，都是“新近”开启的事务，其他事务可能需要读取这个旧版本用于查询，所以不能物理删除，则返回HEAPTUPLE_RECENTLY_DEAD，保留此tuple。换句话说，就是产生垃圾tuple的事务号，通常在为垃圾tuple的头信息中的xmax版本号大于或等于vacuum开启时数据库中最小的(backend_xmin, backend_xid)，这条垃圾tuple就不能被回收，我们可以在pg_stat_activity视图中看到这两列，</p>
<p>postgres=# \d pg_stat_activity</p>
<p>                      View &quot;pg_catalog.pg_stat_activity&quot;</p>
<p>      Column      |           Type           | Collation | Nullable | Default</p>
<p>------------------+--------------------------+-----------+----------+---------</p>
<p> backend_xid      | xid                      |           |          |</p>
<p> backend_xmin     | xid                      |           |          |</p>
<p>对于repeatable read与serializable隔离级别的事务来说，每一个查询开始时需要获取一个快照，对于read committed隔离级别的事务来说，事务中每条查询开始都会重新获取一个快照，快照中将包含一个xmin值，表示当前数据库中最小的正在运行的事务号，如果没有，则为最小未分配事务号。快照xmin与事务申请的事务号有别，xid表示该事务申请的事务号。PostgreSQL9.6之后可以通过old_snapshot_threshold来强制删除为过老的事务快照保留的死元组。</p>
<p>了解了vacuum的逻辑后，我们知道假如session 1查询某行数据，session 2删除该数据，然后commit，执行一次vacuum，我们知道这次vacuum并不会删除该行数据，因为session 1的事务还需要使用该元组，所以不会清理该元组。那么如果是主从呢？主库在准备进行vacuum时怎么知道从库还在进行查询，这就是hot_standby_feedback的意义，设置hot_standby_feedback参数之后备库会定期向主库通知最小活跃事务id(xmin)，这样使得主库vacuum进程不会清理大于xmin值的事务。但是假如主备之间的网络突然中断，备库就无法向主库正常发送xmin值，如果时间够长，主库在这段时间内还是会清理无用元组，这样网络恢复后就可能发生上面的冲突ERROR：canceling statement due to confilct with recovery。</p>
<p>把主从的hot_standby_feedback都设为on，再来模拟一下，我们可以看到pg_replication_slots的xmin一列有值了：</p>
<p>postgres=# select * from pg_replication_slots ;</p>
<p> slot_name | plugin | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn</p>
<p>-----------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------</p>
<p> slot1     |        | physical  |        |          | f         | t      |       4034 |  532 |              | 4/38A51988  |</p>
<p>(1 row)</p>
<p>恢复一下环境：</p>
<p>postgres=# drop table test;</p>
<p>DROP TABLE</p>
<p>postgres=# create table test(id int);</p>
<p>CREATE TABLE</p>
<p>postgres=# insert into test values(generate_series(1,40000000));</p>
<p>INSERT 0 40000000</p>
<p>postgres=# analyze test;</p>
<p>ANALYZE</p>
<p>备库上执行一下查询：</p>
<p>postgres=# select count(*) from test where id = 6666666;</p>
<p>此处夯住...</p>
<p>主库上删除id为6666666的数据，然后做一下vacuum：</p>
<p>postgres=# delete from test where id = 6666666;</p>
<p>DELETE 1</p>
<p>postgres=# vacuum test;</p>
<p>VACUUM</p>
<p>再去备库上等待查询完成，时间稍长，可以看到并未发生上面的冲突：</p>
<p>postgres=# select count(*) from test where id = 6666666;</p>
<p> count</p>
<p>-------</p>
<p>     1</p>
<p>(1 row)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="42restart_lsn">4.2 restart_lsn<a href="#42restart_lsn" class="hash-link" aria-label="4.2 restart_lsn的直接链接" title="4.2 restart_lsn的直接链接">​</a></h2>
<p>postgres=# \d pg_replication_slots</p>
<p>             View &quot;pg_catalog.pg_replication_slots&quot;</p>
<p>       Column        |  Type   | Collation | Nullable | Default</p>
<p>...</p>
<p> restart_lsn         | pg_lsn  |           |          |</p>
<p>对于restart_lsn的官方解释是The address (LSN) of oldest WAL which still might be required by the consumer of this slot and thus won&#x27;t be automatically removed during checkpoints. NULL if the LSN of this slot has never been reserved，意思就是主库checkpoint的时候不会删除这之后的wal日志，以及过早的归档出去，为备库保留着。</p>
<p>postgres=# \d pg_replication_slots</p>
<p>             View &quot;pg_catalog.pg_replication_slots&quot;</p>
<p>       Column        |  Type   | Collation | Nullable | Default</p>
<p>...</p>
<p> restart_lsn         | pg_lsn  |           |          |</p>
<p>postgres=# select pg_walfile_name(restart_lsn) from pg_replication_slots ;</p>
<p>     pg_walfile_name      </p>
<p>--------------------------</p>
<p> 00000001000000050000007E</p>
<p>(1 row)</p>
<p>模拟一下，没有复制槽的情况下：</p>
<p>postgres=# select pg_drop_replication_slot(&#x27;slot1&#x27;);</p>
<p> pg_drop_replication_slot</p>
<p>--------------------------</p>
<p>(1 row)</p>
<p>postgres=# select client_addr,sync_state from pg_stat_replication ;</p>
<p>   client_addr   | sync_state</p>
<p>-----------------+------------</p>
<p> 192.168.211.166 | sync</p>
<p>(1 row)</p>
<p>postgres=# select * from pg_replication_slots ;</p>
<p> slot_name | plugin | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn</p>
<p>-----------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------</p>
<p>(0 rows)</p>
<p>关掉备库：</p>
<p>postgres=# select client_addr,sync_state from pg_stat_replication ;</p>
<p> client_addr | sync_state</p>
<p>-------------+------------</p>
<p>(0 rows)</p>
<p>然后主库上频繁的创建表，以及切换WAL日志：</p>
<p>postgres=# create table test2(id int);</p>
<p>^CCancel request sent</p>
<p>WARNING:  canceling wait for synchronous replication due to user request</p>
<p>DETAIL:  The transaction has already committed locally, but might not have been replicated to the standby.</p>
<p>CREATE TABLE</p>
<p>postgres=# select pg_switch_wal();</p>
<p> pg_switch_wal</p>
<p>---------------</p>
<p> 0/3016168</p>
<p>(1 row)</p>
<p>postgres=# create table test3(id int);</p>
<p>^CCancel request sent</p>
<p>WARNING:  canceling wait for synchronous replication due to user request</p>
<p>DETAIL:  The transaction has already committed locally, but might not have been replicated to the standby.</p>
<p>CREATE TABLE</p>
<p>postgres=# select pg_switch_wal();</p>
<p> pg_switch_wal</p>
<p>---------------</p>
<p> 0/4003A50</p>
<p>(1 row)</p>
<p>postgres=# create table test4(id int);</p>
<p>^CCancel request sent</p>
<p>WARNING:  canceling wait for synchronous replication due to user request</p>
<p>DETAIL:  The transaction has already committed locally, but might not have been replicated to the standby.</p>
<p>CREATE TABLE</p>
<p>postgres=# select pg_switch_wal();</p>
<p> pg_switch_wal</p>
<p>---------------</p>
<p> 0/50011A0</p>
<p>(1 row)</p>
<p>postgres=# checkpoint ;</p>
<p>CHECKPOINT</p>
<p>再启动备机，可以看到流复制关系断了，看下日志：</p>
<p>postgres=# select client_addr,sync_state from pg_stat_replication ;</p>
<p> client_addr | sync_state</p>
<p>-------------+------------</p>
<p>(0 rows)</p>
<p>2020-03-24 08:32:30.044 PDT [4178] FATAL:  could not receive data from WAL stream: ERROR:  requested WAL segment 000000010000000000000003 has already been removed</p>
<p>2020-03-24 08:32:30.132 PDT [4179] LOG:  started streaming WAL from primary at 0/3000000 on timeline 1</p>
<p>2020-03-24 08:32:30.132 PDT [4179] FATAL:  could not receive data from WAL stream: ERROR:  requested WAL segment 000000010000000000000003 has already been removed</p>
<p>2020-03-24 08:32:35.077 PDT [4180] LOG:  started streaming WAL from primary at 0/3000000 on timeline 1</p>
<p>2020-03-24 08:32:35.078 PDT [4180] FATAL:  could not receive data from WAL stream: ERROR:  requested WAL segment 000000010000000000000003 has already been removed</p>
<p>2020-03-24 08:32:40.095 PDT [4181] LOG:  started streaming WAL from primary at 0/3000000 on timeline 1</p>
<p>2020-03-24 08:32:40.096 PDT [4181] FATAL:  could not receive data from WAL stream: ERROR:  requested WAL segment 000000010000000000000003 has already been removed</p>
<p>2020-03-24 08:32:45.089 PDT [4182] LOG:  started streaming WAL from primary at 0/3000000 on timeline 1</p>
<p>2020-03-24 08:32:45.089 PDT [4182] FATAL:  could not receive data from WAL stream: ERROR:  requested WAL segment 000000010000000000000003 has already been removed</p>
<p>恢复下环境，使用复制槽，看下情况：</p>
<p>postgres=# select client_addr,sync_state from pg_stat_replication ;</p>
<p>   client_addr   | sync_state</p>
<p>-----------------+------------</p>
<p> 192.168.211.166 | sync</p>
<p>(1 row)</p>
<p>postgres=# select * from pg_replication_slots ;</p>
<p> slot_name | plugin | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn</p>
<p>-----------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------</p>
<p> slot1     |        | physical  |        |          | f         | t      |       4496 |  486 |              | 0/3000060   |</p>
<p>(1 row)</p>
<p>同样的操作，关掉备库：</p>
<p>postgres=# select client_addr,sync_state from pg_stat_replication ;</p>
<p> client_addr | sync_state</p>
<p>-------------+------------</p>
<p>(0 rows)</p>
<p>然后主库上频繁的创建表，以及切换WAL日志：</p>
<p>postgres=# create table test1(id int);</p>
<p>^CCancel request sent</p>
<p>WARNING:  canceling wait for synchronous replication due to user request</p>
<p>DETAIL:  The transaction has already committed locally, but might not have been replicated to the standby.</p>
<p>CREATE TABLE</p>
<p>postgres=# select pg_switch_wal();</p>
<p> pg_switch_wal</p>
<p>---------------</p>
<p> 0/3014FF0</p>
<p>(1 row)</p>
<p>postgres=# create table test2(id int);</p>
<p>^CCancel request sent</p>
<p>WARNING:  canceling wait for synchronous replication due to user request</p>
<p>DETAIL:  The transaction has already committed locally, but might not have been replicated to the standby.</p>
<p>CREATE TABLE</p>
<p>postgres=# select pg_switch_wal();</p>
<p> pg_switch_wal</p>
<p>---------------</p>
<p> 0/40011A0</p>
<p>(1 row)</p>
<p>postgres=# create table test3(id int);</p>
<p>^CCancel request sent</p>
<p>WARNING:  canceling wait for synchronous replication due to user request</p>
<p>DETAIL:  The transaction has already committed locally, but might not have been replicated to the standby.</p>
<p>CREATE TABLE</p>
<p>postgres=# select pg_switch_wal();</p>
<p> pg_switch_wal</p>
<p>---------------</p>
<p> 0/5003A50</p>
<p>(1 row)</p>
<p>postgres=# checkpoint ;</p>
<p>CHECKPOINT</p>
<p>postgres=# select client_addr,sync_state from pg_stat_replication ;</p>
<p>   client_addr   | sync_state</p>
<p>-----------------+------------</p>
<p> 192.168.211.166 | sync</p>
<p>(1 row)</p>
<p>在备库上查一下是否有这些表，可以看到，流复制正常：</p>
<p>postgres=# \d</p>
<p>         List of relations</p>
<p> Schema | Name  | Type  |  Owner   </p>
<p>--------+-------+-------+----------</p>
<p> public | test1 | table | postgres</p>
<p> public | test2 | table | postgres</p>
<p> public | test3 | table | postgres</p>
<p>(3 rows)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5结论">5 <strong>结论</strong><a href="#5结论" class="hash-link" aria-label="5结论的直接链接" title="5结论的直接链接">​</a></h2>
<p>1．复制槽防止备库需要的wal日志在主库被删除，主库会根据备库返回的信息确认哪些wal日志已不再需要，才能进行清理。</p>
<p>2．当允许应用连接从库做只读查询时，复制槽可以与参数hot_standby_feedback配合使用，使主库的vacuum操作不会过早的清掉从库查询需要的记录，而出现如下错误：ERROR: canceling statement due to conflict with recovery</p>
<p>但是也要注意几点：</p>
<p>1．如果收不到从库的reply，复制槽的状态restart lsn会保持不变，造成主库会一直保留本地日志，可能导致日志磁盘满。所以应该实时监控日志磁盘使用情况，并设置较小的wal_sender_timeout，默认为60s，及早发现从库断掉的情况。</p>
<p>2．将hot_standby_feedback设为on时，如果从库长时间有慢查询发生，可能导致发回到主库的xmin变化较慢，主库的vaccum操作停滞，造成主库被频繁更新的表大小暴增，导致严重的表膨胀。</p>
<p>针对措施：</p>
<p>1．可以增加wal日志个数的监控，当wal日志数量超过正常值告警。</p>
<p>2．做好对每个复制槽同步状态的监控，出现某个槽同步状态异常要及时处理，同步异常会造成lsn不向前推进，导致wal堆积。</p>
<p>3．对于业务很空闲但是数据需要同步的库，可以自定义脚本，定期更新无用表，手工推进lsn。</p>
<p>4．如果wal日志已经堆积很多磁盘马上要爆炸的情况下，在考虑应急删掉复制槽之前要评估剩余空间是否还有足够富余，因为即使删掉复制槽，wal日志也不是马上就会清理，删掉后主库vacuum也会产生较多xlog日志，一定要做好评估。</p>
<p>5．增加pg_replication_slot()视图中restart_lsn的监控，对于落后较大和长期不推进的lsn进行告警。</p>
<p>最后引用一下微信群分享的PostgreSQL流复制图片：</p>
<p><img decoding="async" loading="lazy" src="https://mmbiz.qpic.cn/mmbiz_png/lniadOK6Dzb4Js6Vbw6iaPTWIAUEnmOF4rAIepia5Uaj6yeMWF42SIpsEB5KODTdFefnjZ11raicVnib8r7CEentscQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://mmbiz.qpic.cn/mmbiz_png/lniadOK6Dzb4Js6Vbw6iaPTWIAUEnmOF4rNmw1TMDwlpxuxGrS40TCLWHUsKTSYaUUCa82d454iaoBRDEIxfAujqg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/pgsql/replication/PostgreSQL复制槽实操.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/docs/pgsql/replication/PostgreSQL 同步流复制原理和代码浅析-阿里云开发者社区"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">PostgreSQL 同步流复制原理和代码浅析-阿里云开发者社区</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/docs/pgsql/replication/PostgreSQL数据库复制——后台一等公民进程WalReceiver&amp;startup交互_postgressql walreceive线程_肥叔菌的博客-CSDN博客"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">PostgreSQL数据库复制——后台一等公民进程WalReceiver&amp;startup交互_postgressql walreceive线程_肥叔菌的博客-CSDN博客</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1引言" class="table-of-contents__link toc-highlight">1 <strong>引言</strong></a></li><li><a href="#3为啥要设复制槽" class="table-of-contents__link toc-highlight">3 <strong>为啥要设复制槽</strong></a></li><li><a href="#4实战演示" class="table-of-contents__link toc-highlight">4 <strong>实战演示</strong></a></li><li><a href="#41hot_standby_feedback" class="table-of-contents__link toc-highlight">4.1 hot_standby_feedback</a></li><li><a href="#42restart_lsn" class="table-of-contents__link toc-highlight">4.2 restart_lsn</a></li><li><a href="#5结论" class="table-of-contents__link toc-highlight">5 <strong>结论</strong></a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 growdu, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>