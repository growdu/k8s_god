"use strict";(self.webpackChunkk_8_s_god=self.webpackChunkk_8_s_god||[]).push([[6719],{11686:(e,n,c)=>{c.d(n,{A:()=>t});const t=c.p+"assets/images/msg_flow-067d664d56fe68dfd5732c9622167bcb.jpg"},17712:(e,n,c)=>{c.d(n,{A:()=>t});const t=c.p+"assets/images/execute_flow-fe33b9b15d6b25809d6a28e15ac5ae14.jpg"},23727:(e,n,c)=>{c.d(n,{A:()=>t});const t=c.p+"assets/images/channel-9743d68d0f6e00ed7802b6a4bbea2701.jpg"},28453:(e,n,c)=>{c.d(n,{R:()=>s,x:()=>r});var t=c(96540);const _={},i=t.createContext(_);function s(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(_):e.components||_:s(e.components),t.createElement(i.Provider,{value:n},e.children)}},86446:(e,n,c)=>{c.r(n),c.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>l,frontMatter:()=>s,metadata:()=>t,toc:()=>p});const t=JSON.parse('{"id":"cluster/DCF/\u4e00\u6587\u8bfb\u61c2openguass dcf\u7f51\u7edc\u6a21\u5757","title":"\u4e00\u6587\u8bfb\u61c2openguass dcf\u7f51\u7edc\u6a21\u5757","description":"| \u7f16\u5199\u4eba | \u7f16\u5199\u5185\u5bb9 | \u7f16\u5199\u65f6\u95f4       |","source":"@site/docs/cluster/DCF/\u4e00\u6587\u8bfb\u61c2openguass dcf\u7f51\u7edc\u6a21\u5757.md","sourceDirName":"cluster/DCF","slug":"/cluster/DCF/\u4e00\u6587\u8bfb\u61c2openguass dcf\u7f51\u7edc\u6a21\u5757","permalink":"/blog/docs/cluster/DCF/\u4e00\u6587\u8bfb\u61c2openguass dcf\u7f51\u7edc\u6a21\u5757","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/cluster/DCF/\u4e00\u6587\u8bfb\u61c2openguass dcf\u7f51\u7edc\u6a21\u5757.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"openguass dcf\u6e90\u7801\u9605\u8bfb","permalink":"/blog/docs/cluster/DCF/openguass dcf\u6e90\u7801\u9605\u8bfb"},"next":{"title":"\u5e38\u7528\u538b\u7f29\u7b97\u6cd5\u7f16\u7a0b","permalink":"/blog/docs/cluster/DCF/\u5e38\u7528\u538b\u7f29\u7b97\u6cd5\u7f16\u7a0b"}}');var _=c(74848),i=c(28453);const s={},r="\u4e00\u6587\u8bfb\u61c2openguass dcf\u7f51\u7edc\u6a21\u5757",a={},p=[{value:"0. mec\u6982\u8981",id:"0-mec\u6982\u8981",level:2},{value:"1. compress",id:"1-compress",level:2},{value:"2. mec",id:"2-mec",level:2},{value:"2.1 agent",id:"21-agent",level:3},{value:"2.1.1 \u521d\u59cb\u5316agent",id:"211-\u521d\u59cb\u5316agent",level:4},{value:"2.1.2 agent\u6267\u884c",id:"212-agent\u6267\u884c",level:4},{value:"2.2 channel",id:"22-channel",level:3},{value:"2.2.1 \u521d\u59cb\u5316channel",id:"221-\u521d\u59cb\u5316channel",level:4},{value:"2.2.2 \u8fde\u63a5channel",id:"222-\u8fde\u63a5channel",level:4},{value:"2.3 api",id:"23-api",level:3},{value:"2.4 func",id:"24-func",level:3},{value:"2.5 queue",id:"25-queue",level:3},{value:"2.5.1 \u521d\u59cb\u5316",id:"251-\u521d\u59cb\u5316",level:4},{value:"2.5.2 \u8fd0\u884c",id:"252-\u8fd0\u884c",level:4},{value:"2.5.1.1 \u63a5\u6536\u6d88\u606f\u5165\u961f",id:"2511-\u63a5\u6536\u6d88\u606f\u5165\u961f",level:5},{value:"2.5.1.2 \u53d1\u9001\u6d88\u606f\u5165\u961f",id:"2512-\u53d1\u9001\u6d88\u606f\u5165\u961f",level:5},{value:"2.5.3 \u961f\u5217\u6279\u5904\u7406",id:"253-\u961f\u5217\u6279\u5904\u7406",level:4},{value:"2.6 reactor",id:"26-reactor",level:3},{value:"2.6.1 \u6dfb\u52a0pipe",id:"261-\u6dfb\u52a0pipe",level:4},{value:"2.6.2 \u6267\u884cpipe",id:"262-\u6267\u884cpipe",level:4},{value:"3. protocol",id:"3-protocol",level:2},{value:"3.1 listener",id:"31-listener",level:3},{value:"3.1.1 \u7cfb\u7edf\u8c03\u7528accept",id:"311-\u7cfb\u7edf\u8c03\u7528accept",level:4},{value:"3.1.2 \u5e94\u7528\u5c42accept",id:"312-\u5e94\u7528\u5c42accept",level:4},{value:"3.2 packet",id:"32-packet",level:3},{value:"3.3 ssl",id:"33-ssl",level:3},{value:"3.4 pipe",id:"34-pipe",level:3},{value:"3.4.1 pipe\u7684\u8fde\u63a5",id:"341-pipe\u7684\u8fde\u63a5",level:4},{value:"3.4.1.1 \u5ba2\u6237\u7aef",id:"3411-\u5ba2\u6237\u7aef",level:5},{value:"3.4.1.2 \u670d\u52a1\u7aef",id:"3412-\u670d\u52a1\u7aef",level:5},{value:"3.4.2 pipe\u7684\u6267\u884c",id:"342-pipe\u7684\u6267\u884c",level:4},{value:"3.4.2.1 \u53d1\u9001",id:"3421-\u53d1\u9001",level:5},{value:"3.4.2.2 \u63a5\u6536",id:"3422-\u63a5\u6536",level:5},{value:"3.5 tcp",id:"35-tcp",level:3},{value:"4. \u6570\u636e\u6536\u53d1",id:"4-\u6570\u636e\u6536\u53d1",level:2},{value:"4.1 \u6d88\u606f",id:"41-\u6d88\u606f",level:3},{value:"4.2 \u6570\u636e\u53d1\u9001",id:"42-\u6570\u636e\u53d1\u9001",level:3},{value:"4.3 \u6570\u636e\u63a5\u6536",id:"43-\u6570\u636e\u63a5\u6536",level:3},{value:"5. FAQ",id:"5-faq",level:2},{value:"5.1 \u4ee3\u7801\u5c42\u9762\u5982\u4f55\u533a\u5206channel\u4e2d\u9ad8\u4f4e\u4f18\u5148\u7ea7\uff1f",id:"51-\u4ee3\u7801\u5c42\u9762\u5982\u4f55\u533a\u5206channel\u4e2d\u9ad8\u4f4e\u4f18\u5148\u7ea7",level:3},{value:"5.4.1 \u6d88\u606f\u7684\u4f18\u5148\u7ea7",id:"541-\u6d88\u606f\u7684\u4f18\u5148\u7ea7",level:4},{value:"5.1.1 \u63a5\u6536",id:"511-\u63a5\u6536",level:4},{value:"5.1.2 \u53d1\u9001",id:"512-\u53d1\u9001",level:4},{value:"5.2 \u4e94\u5927\u7ec4\u4ef6\u7684\u5173\u7cfb\u56fe\uff1f",id:"52-\u4e94\u5927\u7ec4\u4ef6\u7684\u5173\u7cfb\u56fe",level:3},{value:"5.3 \u6536\u53d1pipe\u662f\u5426\u90fd\u9700\u8981\u6fc0\u6d3b",id:"53-\u6536\u53d1pipe\u662f\u5426\u90fd\u9700\u8981\u6fc0\u6d3b",level:3},{value:"5.4 \u7f51\u7edc\u8d85\u65f6\u65f6\u95f4\u5982\u4f55\u8bbe\u7f6e",id:"54-\u7f51\u7edc\u8d85\u65f6\u65f6\u95f4\u5982\u4f55\u8bbe\u7f6e",level:3},{value:"5.4.1 \u5ba2\u6237\u7aef\uff08\u4e3b\u52a8\u53d1\u8d77\u8fde\u63a5\uff09",id:"541-\u5ba2\u6237\u7aef\u4e3b\u52a8\u53d1\u8d77\u8fde\u63a5",level:4},{value:"5.4.2 \u670d\u52a1\u7aef\uff08\u63a5\u53d7\u8fde\u63a5\u7684\u4e00\u65b9\uff09",id:"542-\u670d\u52a1\u7aef\u63a5\u53d7\u8fde\u63a5\u7684\u4e00\u65b9",level:4},{value:"5.4.3 \u6d88\u606f\u6536\u53d1\u8d85\u65f6",id:"543-\u6d88\u606f\u6536\u53d1\u8d85\u65f6",level:4},{value:"5.5 \u6279\u5904\u7406\u7684\u6d88\u606f\u903b\u8f91\uff0c\u600e\u4e48\u786e\u5b9a\u4e00\u6b21\u5904\u7406\u591a\u5c11\u6761\u6d88\u606f",id:"55-\u6279\u5904\u7406\u7684\u6d88\u606f\u903b\u8f91\u600e\u4e48\u786e\u5b9a\u4e00\u6b21\u5904\u7406\u591a\u5c11\u6761\u6d88\u606f",level:3},{value:"5.6 \u53d1\u9001\u5931\u8d25\u540e\u7684\u8bca\u65ad",id:"56-\u53d1\u9001\u5931\u8d25\u540e\u7684\u8bca\u65ad",level:3},{value:"5.7 \u7f51\u7edc\u6d88\u606f\u5e72\u6270\uff0c\u5982\u4f55\u8bc6\u522b\u975e\u672c\u8282\u70b9\u6d88\u606f",id:"57-\u7f51\u7edc\u6d88\u606f\u5e72\u6270\u5982\u4f55\u8bc6\u522b\u975e\u672c\u8282\u70b9\u6d88\u606f",level:3},{value:"5.8 agent\u6267\u884cjob\u7ed3\u675f\u7684\u6807\u5fd7\uff0c\u63a5\u6536\u591a\u5c11\u6570\u636e\u7ed3\u675f",id:"58-agent\u6267\u884cjob\u7ed3\u675f\u7684\u6807\u5fd7\u63a5\u6536\u591a\u5c11\u6570\u636e\u7ed3\u675f",level:3},{value:"reference",id:"reference",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",header:"header",img:"img",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)(n.header,{children:(0,_.jsx)(n.h1,{id:"\u4e00\u6587\u8bfb\u61c2openguass-dcf\u7f51\u7edc\u6a21\u5757",children:"\u4e00\u6587\u8bfb\u61c2openguass dcf\u7f51\u7edc\u6a21\u5757"})}),"\n",(0,_.jsxs)(n.table,{children:[(0,_.jsx)(n.thead,{children:(0,_.jsxs)(n.tr,{children:[(0,_.jsx)(n.th,{children:"\u7f16\u5199\u4eba"}),(0,_.jsx)(n.th,{children:"\u7f16\u5199\u5185\u5bb9"}),(0,_.jsx)(n.th,{children:"\u7f16\u5199\u65f6\u95f4"})]})}),(0,_.jsxs)(n.tbody,{children:[(0,_.jsxs)(n.tr,{children:[(0,_.jsx)(n.td,{children:"\u6bb5\u5e94\u5bff"}),(0,_.jsx)(n.td,{children:"\u521d\u7a3f"}),(0,_.jsx)(n.td,{children:"2023-02-23"})]}),(0,_.jsxs)(n.tr,{children:[(0,_.jsx)(n.td,{}),(0,_.jsx)(n.td,{}),(0,_.jsx)(n.td,{})]}),(0,_.jsxs)(n.tr,{children:[(0,_.jsx)(n.td,{}),(0,_.jsx)(n.td,{}),(0,_.jsx)(n.td,{})]})]})]}),"\n",(0,_.jsx)(n.p,{children:"[TOC]"}),"\n",(0,_.jsx)(n.h2,{id:"0-mec\u6982\u8981",children:"0. mec\u6982\u8981"}),"\n",(0,_.jsx)(n.p,{children:"\u901a\u4fe1\u6a21\u5757\u4e3b\u8981\u662f\u57fa\u4e8eMEC\u5b9e\u73b0\uff08Message Exchange Component\uff09\uff0c\u63d0\u4f9b\u6574\u4e2aDCF\u7ec4\u4ef6\u5b9e\u4f8b\u95f4\u901a\u4fe1\u80fd\u529b\uff0c\u4ee5\u53ca\u5f02\u6b65\u4e8b\u4ef6\u5904\u7406\u6846\u67b6\u3002\u4e3b\u8981\u529f\u80fd\u6709\uff1a\u53ef\u6269\u5c55\u7684\u591a\u79cd\u901a\u4fe1\u534f\u8bae\uff0c\u5355\u64ad\u3001\u5e7f\u64ad\u3001\u73af\u56de\u7684\u53d1\u9001\u63a5\u53e3\uff0c\u6d88\u606f\u5f02\u6b65\u5904\u7406\u7684\u6846\u67b6\uff0c\u652f\u6301\u591achannel\u673a\u5236\u548c\u591a\u4f18\u5148\u7ea7\u961f\u5217\uff0c\u652f\u6301\u538b\u7f29\u548c\u6279\u91cf\u53d1\u9001\u7b49mec\u4e3b\u8981\u901a\u8fc7channel\u6765\u8fdb\u884c\u901a\u4fe1\uff0c\u8282\u70b9\u4e4b\u95f4\u53ef\u80fd\u5b58\u5728\u591a\u4e2achannel\u901a\u9053\u3002"}),"\n",(0,_.jsx)(n.p,{children:(0,_.jsx)(n.img,{src:c(93529).A+"",width:"1315",height:"442"})}),"\n",(0,_.jsx)(n.p,{children:"channel\u901a\u8fc7\u961f\u5217\u8fdb\u884c\u6d88\u606f\u7684\u6536\u53d1\uff0c\u6d88\u606f\u6536\u53d1\u652f\u6301\u6279\u91cf\u6536\u53d1\u3002channel\u5185\u90e8\u91c7\u7528pipe\u901a\u4fe1\uff0cpipe\u53c8\u5206\u4e3a\u9ad8\u4f18\u5148\u7ea7\u548c\u4f4e\u4f18\u5148\u7ea7\u3002\u6bcf\u4e00\u4e2apipe\u5185\u90e8\u6709\u4e24\u6761tcp\u94fe\u8def\uff0c\u4e00\u6761\u94fe\u8def\u4e13\u95e8\u7528\u4e8e\u53d1\u9001\uff0c\u4e00\u6761\u94fe\u8def\u4e13\u95e8\u7528\u4e8e\u63a5\u6536\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u6536\u53d1\u6d41\u7a0b\u5982\u4e0b\u56fe\u6240\u793a\uff08\u6b64\u5904\u961f\u5217\u53ea\u753b\u51fa\u4e86\u4e00\u4e2a\uff0c\u5b9e\u9645\u6709\u591a\u4e2a\u961f\u5217\uff0c\u9ed8\u8ba416\u4e2a\uff09\uff1a"}),"\n",(0,_.jsx)(n.p,{children:(0,_.jsx)(n.img,{src:c(11686).A+"",width:"1562",height:"498"})}),"\n",(0,_.jsx)(n.p,{children:"mec\u6d88\u606f\u5904\u7406\u91c7\u7528\u591a\u7ebf\u7a0b\u52a0\u961f\u5217\u6765\u5b9e\u73b0\uff0c\u961f\u5217\u7684\u8bbf\u95ee\u91c7\u7528\u9501\u52a0\u4fe1\u53f7\u91cf\u6765\u907f\u514d\u591a\u7ebf\u7a0b\u51b2\u7a81\uff0cmq\u548cagent\u5747\u91c7\u7528\u8fd9\u79cd\u6a21\u5f0f\u6765\u5b9e\u73b0\u3002"}),"\n",(0,_.jsxs)(n.p,{children:["mec\u7f51\u7edc\u901a\u4fe1\u91c7\u7528epoll I/O\u591a\u8def\u590d\u7528\u6765\u5b9e\u73b0\uff0c\u5e76\u4f7f\u7528",(0,_.jsx)(n.a,{href:"https://blog.csdn.net/u013256816/article/details/115388239",children:"reactor\u6a21\u578b"}),"\u6765\u5b9e\u73b0\u670d\u52a1\u7aef\u76d1\u542c\u673a\u5236\u3002\u5176\u67b6\u6784\u4e0e\u4e0b\u56fe\uff08\u56fe\u7247\u6765\u81ea",(0,_.jsx)(n.a,{href:"https://blog.csdn.net/u013256816/article/details/115388239%EF%BC%89%E7%B1%BB%E4%BC%BC%EF%BC%8C%E9%87%87%E7%94%A8%E4%B8%BB%E4%BB%8Ereactor%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%8F%AA%E4%B8%8D%E8%BF%87%E5%9C%A8mec%E4%B8%AD%E5%B0%86mainreactor%E7%A7%B0%E4%BD%9Clistener%EF%BC%88acceptor%EF%BC%89%E3%80%82",children:"https://blog.csdn.net/u013256816/article/details/115388239\uff09\u7c7b\u4f3c\uff0c\u91c7\u7528\u4e3b\u4ecereactor\u591a\u7ebf\u7a0b\u6a21\u578b\u53ea\u4e0d\u8fc7\u5728mec\u4e2d\u5c06mainreactor\u79f0\u4f5clistener\uff08acceptor\uff09\u3002"})]}),"\n",(0,_.jsx)(n.p,{children:(0,_.jsx)(n.img,{src:c(88025).A+"",width:"920",height:"892"})}),"\n",(0,_.jsx)(n.p,{children:"mec\u4f7f\u7528tcp\u76d1\u542c\u94fe\u8def\u6765\u63a5\u6536\u6d88\u606f\uff0c\u6d88\u606f\u63a5\u6536\u91c7\u7528reactor\u6a21\u578b\u5b9e\u73b0\uff0c\u6700\u7ec8\u4ea4\u7ed9agent\u6765\u6267\u884c\u3002\u5b9e\u9645\u6d41\u7a0b\u4e0e\u4e0a\u56fe\u7684reactor\u4e3b\u4ece\u6a21\u578b\u7c7b\u4f3c\uff0c\u6d88\u606f\u63a5\u6536\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.p,{children:(0,_.jsx)(n.img,{src:c(17712).A+"",width:"1401",height:"584"})}),"\n",(0,_.jsx)(n.p,{children:"mec\u7684\u6d88\u606f\u5904\u7406\u4e3b\u8981\u4f9d\u9760\u5982\u4e0b\u56db\u4e2a\u7ec4\u4ef6\u6765\u5b8c\u6210\uff0c\u800cchannel\u4e3b\u8981\u662f\u7528\u6765\u4f20\u8f93\uff0c\u56e0\u800c\u5728\u4e0b\u56fe\u4e2d\u672a\u4f53\u73b0\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec--\x3eacceptor\nmec--\x3ereactor\nmec--\x3eagent\nmec--\x3equeue"}),"\n",(0,_.jsx)(n.mermaid,{value:"sequenceDiagram\nacceptor->>reactor: acceptor\u63a5\u53d7\u4e00\u4e2a\u8fde\u63a5\u540e\u4f1a\u5c06socket\u7ed1\u5b9a\u5230\u4e00\u4e2apipe\u4e0a\u5e76\u4ea4\u7ed9reactor\u76d1\u542c\nreactor->>agent: reactor\u4f7f\u7528epoll\u68c0\u6d4b\u5230socket IO\u4e8b\u4ef6\u65f6\uff0c\u5c06pipe attach\u5230agent\u4e0a\u6267\u884c\uff0c\u5e76\u53d1\u9001\u4fe1\u53f7\u901a\u77e5agent\nagent->>queue: agent\u6267\u884cjob(send\u6216\u8005recv)\uff0c\u4f1a\u5c06\u6d88\u606f\u653e\u5230\u961f\u5217\u91cc\nagent->>reactor: agent\u7ebf\u7a0b\u4f1a\u6267\u884cpipe\u7684job\uff0c\u6267\u884c\u5b8c\u6210\u540e\u5c06pipe deattach agent\uff0creactor\u4f1a\u91cd\u65b0\u76d1\u542cpipe\u7684socket\nqueue--\x3e>queue: queue\u6267\u884c\u7ebf\u7a0b\u4f1a\u4e0d\u505c\u7684\u53d6\u51fa\u6d88\u606f\u53bb\u5904\u7406(\u5373\u5e94\u7528\u5c42\u7684\u6570\u636e\u5904\u7406\u5176\u5b9e\u662f\u5728\u961f\u5217\u7ebf\u7a0b\u91cc\u6267\u884c\u7684)"}),"\n",(0,_.jsx)(n.p,{children:"mec\u91cd\u70b9\u7531\u4e94\u5927\u7ec4\u4ef6\u7ec4\u6210\uff0c\u5206\u522b\u662f\uff1a"}),"\n",(0,_.jsxs)(n.ul,{children:["\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"listener\uff08acceptor\uff09"}),"\n",(0,_.jsx)(n.p,{children:"listener\u8d1f\u8d23\u76d1\u542c\u548c\u63a5\u53d7\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\uff0c\u5145\u5f53epoll\u591a\u8def\u590d\u7528reactor\u6a21\u578b\u4e2d\u7684acceptor\u89d2\u8272\u3002"}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"reactor"}),"\n",(0,_.jsx)(n.p,{children:"\u8d1f\u8d23\u76d1\u542cacceptor\u5efa\u7acb\u597d\u8fde\u63a5\u540e\u6dfb\u52a0\u8fc7\u6765\u7684socket\uff0c\u5f53\u6709\u4e8b\u4ef6\u5230\u6765\u65f6\u4f1a\u5c06\u5bf9\u5e94\u7684socket\u7ed1\u5b9a\u5230agent\u8fd0\u884c\u3002"}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"agent"}),"\n",(0,_.jsx)(n.p,{children:"agent\u662f\u4e00\u4e2a\u7ebf\u7a0b\u6c60\uff0c\u8d1f\u8d23\u6267\u884cchannel\u4e2dpipe\u7684job\u3002"}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"queue"}),"\n",(0,_.jsx)(n.p,{children:"\u961f\u5217\u7528\u4e8e\u5b58\u653e\u63a5\u6536\u548c\u53d1\u9001\u7684\u6d88\u606f\u3002"}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"channel"}),"\n",(0,_.jsx)(n.p,{children:"channel\u662f\u5b9e\u9645\u7684\u901a\u4fe1\u901a\u9053\uff0c\u5176\u5185\u90e8\u7531pipe\u6765\u8fdb\u884c\u901a\u4fe1\uff0cpipe\u5206\u4e3a\u9ad8\u4f18\u5148\u7ea7pipe\u548c\u4f4e\u4f18\u5148\u7ea7pipe\u3002pipe\u5728socket\u5c42\u9762\u53c8\u5206\u4e3a\u53d1\u9001pipe\u548c\u63a5\u6536pipe\u3002\u8282\u70b9\u4e4b\u95f4\u5c31\u662f\u901a\u8fc7channel\u6765\u8fdb\u884c\u6536\u53d1\u5305\uff0c\u53d1\u9001\u65f6\u901a\u8fc7\u53d1\u9001pipe\u53d1\u9001\uff0c\u63a5\u6536\u65f6\u901a\u8fc7\u63a5\u6536pipe\u6765\u63a5\u6536\u3002"}),"\n"]}),"\n"]}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec--\x3echannel\nmec--\x3ereactor\nmec--\x3eagent\nmec--\x3elistener\nmec--\x3equeue"}),"\n",(0,_.jsx)(n.p,{children:"mec\u8fd0\u884c\u521d\u59cb\u5316\u6d41\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_init--\x3e|\u521d\u59cb\u5316\u5185\u5b58\u5206\u914d\u7cfb\u7edf|init_buddy_pool--\x3e|\u521d\u59cb\u5316mec\u914d\u7f6e|init_mec_profile--\x3e|\u521d\u59cb\u5316reactor|mec_init_reactor--\x3e|\u521b\u5efaagent|agent_create_pool--\x3e|\u521b\u5efareactor|reactor_create_pool--\x3emec_init_core\nmec_init_core2--\x3e|\u521d\u59cb\u5316\u52a0\u5bc6|mec_init_ssl--\x3e|\u521d\u59cb\u5316\u6d88\u606f\u961f\u5217|mec_init_mq--\x3e|\u521d\u59cb\u5316channel|mec_init_channels--\x3e|\u521d\u59cb\u5316\u5206\u7247|fragment_ctx_init--\x3e|\u542f\u52a8tcp\u76d1\u542c|mec_start_lsnr--\x3e|\u8fde\u63a5\u5176\u4ed6\u8282\u70b9,\u5b9e\u9645\u662f\u8fde\u63a5\u53d1\u9001pipe|mec_connect_by_profile--\x3e|\u8fd0\u884cmec\u5b88\u62a4\u7ebf\u7a0b|mec_daemon_proc"}),"\n",(0,_.jsx)(n.p,{children:"mec\u6a21\u5757\u7684\u7f51\u7edc\u901a\u4fe1\u91c7\u7528epoll I/O\u591a\u8def\u590d\u7528\u7684reactor\u6a21\u578b\uff0c\u540c\u65f6\u7ed3\u5408\u7ebf\u7a0b\u6c60\u548c\u4ee3\u7406\u6c60\u6765\u5b9e\u73b0\u3002reactor\u8d1f\u8d23\u6d88\u606f\u7684\u901a\u77e5\uff0c\u5206\u4e3a\u9ad8\u4f18\u5148\u7ea7reactor\u548c\u4f4e\u4f18\u5148\u7ea7reactor\u3002\u5185\u90e8\u901a\u4fe1\u91c7\u7528channel\u7684\u6982\u5ff5\uff0cchannel\u5185\u90e8\u91c7\u7528pipe\u6765\u8fdb\u884c\u8fde\u63a5\u901a\u4fe1\u3002\u6bcf\u4e00\u4e2a\u4ee3\u7406\u8fd0\u884c\u5728\u4e00\u4e2a\u7ebf\u7a0b\u4e0a\uff0c\u6bcf\u4e00\u4e2apipe\u4f1a\u9644\u7740\u5230\u4e00\u4e2a\u4ee3\u7406\u4e0a\u8fd0\u884c\u3002acceptor\u63a5\u53d7\u65b0\u7684\u8fde\u63a5\u540e\uff0c\u4f1a\u521b\u5efachannel\uff0c\u5e76\u5c06channel\u6dfb\u52a0\u5230reactor\u6c60\u4e2d\uff0creactor\u8d1f\u8d23\u76d1\u542cI/O\u4e8b\u4ef6\u7684\u5230\u6765\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6bcf\u4e00\u4e2aacceptor\u63a5\u53d7\u5230\u65b0\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u8bf7\u6c42\u540e\uff0c\u63a5\u53d7\u8fde\u63a5\u5e76\u521d\u59cb\u5316pipe\uff0c\u540c\u65f6\u5c06pipe\u6dfb\u52a0\u5230reactor\u4e2d\u3002reactor\u4f1a\u76d1\u542c\u6bcf\u4e2apipe\u662f\u5426\u6709\u4e8b\u4ef6\u5230\u6765\uff0c\u6709\u4e8b\u4ef6\u5230\u6765\u65f6\uff0creactor\u4f1a\u628apipe\u9644\u7740\u5230\u4e00\u4e2aagent\u4e0a\u8fd0\u884c\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6bcf\u4e00\u4e2a\u8282\u70b9\u90fd\u6709\u4e00\u4e2a\u5168\u5c40\u7684\u9759\u6001mec_instance_t\uff0c\u7528\u4e8e\u4fdd\u5b58mec\u76f8\u5173\u7684\u4fe1\u606f\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"static mec_instance_t *g_mec = NULL;\n/// @brief \u6d88\u606f\u4ea4\u6362\u5b9e\u4f8b\ntypedef struct st_mec_instance {\n    mec_profile_t      profile; ///< mec\u4e3b\u8981\u4fe1\u606f\n    mq_context_t       send_mq; ///< \u53d1\u9001\u961f\u5217\n    mq_context_t       recv_mq; ///< \u63a5\u6536\u961f\u5217\n    mec_context_t      mec_ctx; ///< mec\u4e0a\u4e0b\u6587\n    fragment_ctx_t     fragment_ctx; ///< \u5206\u7247\u4e0a\u4e0b\u6587\n    thread_t           daemon_thread;///< \u5b88\u62a4\u7ebf\u7a0bid\n    reactor_pool_t     reactor_pool[PRIV_CEIL]; ///< epoll\u53cd\u5e94\u5806\u6570\u7ec4\n    agent_pool_t       agent_pool[PRIV_CEIL]; ///< \u4ee3\u7406\u6c60\n    ssl_ctx_t         *ssl_acceptor_fd; ///< ssl\u63a5\u53d7\u5668\n    ssl_ctx_t         *ssl_connector_fd;///< ssl\u8fde\u63a5\u5668\n} mec_instance_t;\n"})}),"\n",(0,_.jsx)(n.h2,{id:"1-compress",children:"1. compress"}),"\n",(0,_.jsx)(n.p,{children:"\u538b\u7f29\u6a21\u5757\u4e3b\u8981\u662f\u5bf9\u4f20\u8f93\u6570\u636e\u8fdb\u884c\u538b\u7f29\uff0c\u4ee5\u53ca\u5bf9\u63a5\u6536\u5230\u7684\u6570\u636e\u8fdb\u884c\u89e3\u538b\u7f29\uff0c\u4ee5\u63d0\u9ad8\u7f51\u7edc\u4f20\u8f93\u6570\u91cf\u3002\u5f53\u524d\u652f\u6301zstd\u538b\u7f29\u548clz4\u538b\u7f29\u3002"}),"\n",(0,_.jsx)(n.h2,{id:"2-mec",children:"2. mec"}),"\n",(0,_.jsx)(n.p,{children:"mec\u662fMessage Exchange Component\u6d88\u606f\u4ea4\u6362\u7ec4\u4ef6\u7684\u7b80\u79f0\u3002\u4e3b\u8981\u901a\u8fc7mec.h\u5bf9\u5916\u63d0\u4f9b\u4f7f\u7528\u63a5\u53e3\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"21-agent",children:"2.1 agent"}),"\n",(0,_.jsx)(n.p,{children:"agent\u5b9e\u9645\u4e0a\u662f\u7ebf\u7a0b\u6c60\u6a21\u5f0f\uff0c\u5229\u7528\u4e92\u65a5\u9501\u548c\u4fe1\u53f7\u91cf\u52a0\u961f\u5217\u6765\u5b9e\u73b0\u3002\u4e00\u65e6\u6709\u65b0\u7684pipe\u5230\u6765\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u5524\u9192\u4e00\u4e2a\u7ebf\u7a0b\u53bb\u6267\u884c\u3002\u5982\u679c\u6ca1\u6709\u7a7a\u95f2\u7684agent\uff0c\u5c31\u4f1a\u65b0\u521b\u5efa\u4e00\u4e2aagent\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cagent\u662f\u52a8\u6001\u521b\u5efa\u7684\uff0c\u53ea\u6709agent\u5904\u7406\u4e0d\u8fc7\u6765\u65f6\uff0c\u624d\u4f1a\u521b\u5efa\u65b0\u7684agent\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6240\u6709\u65b0\u52a0\u5165\u7684pipe\u4f1a\u5148\u52a0\u5165\u5230\u961f\u5217\u91cc\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u53bb\u961f\u5217\u91cc\u53d6\u51fa\u4e00\u4e2apipe\u6765\u5904\u7406\u3002"}),"\n",(0,_.jsx)(n.p,{children:"agent\u4e0ereactor\u5bf9\u5e94\uff0c\u4e5f\u5206\u4e3a\u9ad8\u4f18\u5148\u7ea7agent\u548c\u4f4e\u4f18\u5148\u7ea7agent\uff0c\u5e76\u4e0ereactor\u76f8\u5bf9\u5e94\u3002"}),"\n",(0,_.jsx)(n.h4,{id:"211-\u521d\u59cb\u5316agent",children:"2.1.1 \u521d\u59cb\u5316agent"}),"\n",(0,_.jsx)(n.p,{children:"\u521d\u59cb\u5316agent\u4e3b\u8981\u662f\u521d\u59cb\u5316\u4e92\u65a5\u9501\u548c\u4fe1\u53f7\u91cf\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"    evnt->status = CM_FALSE;\n    if (pthread_condattr_init(&evnt->attr) != 0) {\n        (void)pthread_cond_destroy(&evnt->cond);\n        return CM_ERROR;\n    }\n\n    if (pthread_mutex_init(&evnt->lock, 0) != 0) { /// \u521d\u59cb\u5316\u9501\n        (void)pthread_cond_destroy(&evnt->cond);\n        return CM_ERROR;\n    }\n\n    if (pthread_condattr_setclock(&evnt->attr, CLOCK_MONOTONIC) != 0) {\n        (void)pthread_cond_destroy(&evnt->cond);\n        return CM_ERROR;\n    }\n\n    if (pthread_cond_init(&evnt->cond, &evnt->attr) != 0) { /// \u521d\u59cb\u5316\u4fe1\u53f7\u91cf\n        (void)pthread_cond_destroy(&evnt->cond);\n        return CM_ERROR;\n    }\n"})}),"\n",(0,_.jsx)(n.h4,{id:"212-agent\u6267\u884c",children:"2.1.2 agent\u6267\u884c"}),"\n",(0,_.jsx)(n.p,{children:"\u5f53reactor\u76d1\u542c\u5230\u6709pipe\u5c31\u7eea\u65f6\uff0c\u4f1a\u5c06\u8be5pipe\u9644\u7740\u5230agent\u4e0a\u6267\u884c\u3002"}),"\n",(0,_.jsxs)(n.ul,{children:["\n",(0,_.jsx)(n.li,{children:"\u5df2\u6709\u7a7a\u95f2agent"}),"\n"]}),"\n",(0,_.jsx)(n.p,{children:"\u6b64\u65f6\u5148\u770bidle_agents\u662f\u5426\u6709\u7a7a\u95f2\u7684agent\uff0c\u6709\u7684\u8bdd\u76f4\u63a5\u51fa\u961f\u4e00\u4e2aagent\uff0c\u5e76\u628apipe\u7ed1\u5b9a\u5230\u8fd9\u4e2aagent\u4e0a\u6267\u884c\uff0c\u8bbe\u7f6epipe\u662f\u53d1\u9001\u8fd8\u662f\u63a5\u6536\uff0c\u6fc0\u6d3bpipe\u3002"}),"\n",(0,_.jsxs)(n.ul,{children:["\n",(0,_.jsx)(n.li,{children:"\u6ca1\u6709\u7a7a\u95f2agent"}),"\n"]}),"\n",(0,_.jsx)(n.p,{children:"\u5982\u679c\u4e4b\u524d\u8fd8\u6ca1\u6709\u521b\u5efa\u8fc7agent\u6216\u8005\u6ca1\u6709\u7a7a\u95f2\u7684agent\uff0c\u5c31\u9700\u8981\u65b0\u5efa\u4e00\u4e2aagent\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u521b\u5efa\u4e00\u4e2aagent\u4e5f\u662f\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u8fd9\u4e2a\u7ebf\u7a0b\u4f1a\u4e0d\u505c\u7684\u7a7a\u8f6c\u6216\u8005\u6267\u884cpipe\u3002\u521b\u5efa\u65f6\u4f1a\u7528cm_event_init\u521d\u59cb\u5316\u9501\u548c\u4fe1\u53f7\u91cf\uff0c\u7136\u540e\u4f1a\u5728\u7ebf\u7a0b\u4e2d\u7528cm_event_timedwait\u7b49\u5f85\u4fe1\u53f7\u91cf\u5524\u9192agent\u7ebf\u7a0b\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u5728\u521b\u5efapipe\u7684\u65f6\u5019\u4f1a\u521d\u59cb\u5316send_mode\u548crecv_mode\u7684job\uff0c\u5f53\u7ebf\u7a0b\u88ab\u5524\u9192\u5c31\u4f1a\u6267\u884c\u5bf9\u5e94\u7684job\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nattach_agent--\x3etry_attach_agent--\x3etry_create_agent--\x3ecreate_agent--\x3estart_agent--\x3e|agent\u7ebf\u7a0b\u5faa\u73af\u51fd\u6570|agent_entry--\x3etry_process_multi_channels--\x3e|\u7b49\u5f85\u4fe1\u53f7\u5524\u9192\u7ebf\u7a0b|cm_event_timedwait--\x3e|\u6267\u884cpipe\u7684job|job"}),"\n",(0,_.jsx)(n.p,{children:"\u5f53\u8c03\u7528attach_agent\u65f6\uff0c\u5c31\u610f\u5473\u7740\u6709\u4e00\u4e2apipe\u8981\u653e\u5230agent\u91cc\u6765\u8fd0\u884c\u3002\u82e5\u5728attach_agent\u6210\u529f\u540e\uff0c\u540c\u65f6\u8c03\u7528cm_event_notify\uff0c\u5219\u4f1a\u53d1\u9001\u4fe1\u53f7\u7ed9agent\u7ebf\u7a0b\uff0c\u8868\u793a\u6709\u4efb\u52a1\u53ef\u4ee5\u6267\u884c\uff0c\u6b64\u65f6\u4f1a\u5524\u9192\u7ebf\u7a0b\u5e76\u6267\u884cpipe\u7684job\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u5728\u7f51\u7edc\u6a21\u5757\u4e2d\u6709\u4e24\u4e2a\u5730\u65b9\u4f1a\u5c06pipe attach\u5230agent\uff0c\u5206\u522b\u662f\u5ba2\u6237\u7aef\u5728connect\u6210\u529f\u540e\u548creactor\u63a5\u6536\u5230\u4e8b\u4ef6\u4e4b\u540e\u3002"}),"\n",(0,_.jsxs)(n.ul,{children:["\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u5ba2\u6237\u7aefconnect\u6210\u529f"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'if (attach_agent(pipe, get_mec_agent(pipe->priv), SEND_MODE, &agent) != CM_SUCCESS) {\n        LOG_RUN_ERR("[MEC]attached agent failed inst [%u], channel id [%u], priv [%d]",\n                    MEC_INSTANCE_ID(pipe->channel->id), MEC_CHANNEL_ID(pipe->channel->id), pipe->priv);\n        cm_thread_unlock(&pipe->send_lock);\n        return CM_ERROR;\n }\n'})}),"\n",(0,_.jsx)(n.p,{children:"\u6b64\u65f6\u662f\u5c06SEND_MODE\u6a21\u5f0f\u7684pipe attach\u5230agent\u4e0a\u6267\u884c\uff0cattach\u5230agent\u6210\u529f\u540e\u8c03\u7528cm_event_notify\u901a\u77e5agent\u6709\u4efb\u52a1\u53ef\u4ee5\u5904\u7406\u3002\u6b64\u65f6\u6d41\u7a0b\u8fdb\u5165agent_entry\u7684\u5faa\u73af\u91cc\u5e76\u6267\u884c\u52a0\u5165\u7684pipe\uff0c"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"pipe->attach[agent->mode].job((void *)pipe, &is_continue);\n"})}),"\n",(0,_.jsx)(n.p,{children:"agent\u6536\u5230\u4fe1\u53f7\u540e\u5c31\u4f1a\u6267\u884cjob\uff0c\u8fd9\u91cc\u52a0\u5165\u7684pipe\u7684mode\u662fSEND_MODE\uff0cpipe\u7684job\u5728\u521b\u5efachannel\u65f6\u8d4b\u503c\uff0cSEND_MODE\u5bf9\u5e94\u7684job\u662fmec_proc_send_pipe\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6b64\u65f6\u5bf9\u5e94\u7684\u662f\u5ba2\u6237\u7aef\u884c\u4e3a\uff0c\u5728\u8fde\u63a5\u65f6\u5ba2\u6237\u7aef\u662f\u4e3b\u52a8\u53d1\u9001\u6d88\u606f\u7684\u4e00\u65b9\u3002"}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"reactor\u63a5\u6536\u5230\u4e8b\u4ef6"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"status_t status = attach_agent(pipe, reactor->agent_pool, RECV_MODE, &agent);\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u5f53acceptor\u5728\u5efa\u7acb\u597dtcp\u8fde\u63a5\u5e76\u521d\u59cb\u5316\u597dpipe\u540e\u5c31\u4f1a\u5c06pipe\u4ea4\u7ed9reactor\u8fdb\u884c\u5904\u7406\uff0creactor\u4f1a\u9002\u7528epoll_wait\u76d1\u542cpipe\u7684socket\u662f\u5426\u6709\u4e8b\u4ef6\u5230\u6765\u3002\u5f53\u6709socket\u51c6\u5907\u5c31\u7eea\u65f6\uff0c\u5c31\u5c06\u5176\u5bf9\u5e94\u7684pipe attach\u5230agent\u4e0a\u53bb\u6267\u884c\uff0c\u6b64\u65f6\u7684mode\u4e3aRECV_MODE\u3002"}),"\n",(0,_.jsx)(n.p,{children:"agent\u6536\u5230\u4fe1\u53f7\u540e\u5c31\u4f1a\u6267\u884cjob\uff0c\u8fd9\u91cc\u52a0\u5165\u7684pipe\u7684mode\u662fRECV_MODE\uff0cpipe\u7684job\u5728\u521b\u5efachannel\u65f6\u8d4b\u503c\uff0cRECV_MODE\u5bf9\u5e94\u7684job\u662fmec_proc_recv_pipe\u3002"}),"\n"]}),"\n"]}),"\n",(0,_.jsx)(n.h3,{id:"22-channel",children:"2.2 channel"}),"\n",(0,_.jsx)(n.p,{children:"\u8282\u70b9\u4e4b\u95f4\u901a\u8fc7channel\u6765\u901a\u4fe1\uff0c\u4e24\u4e2a\u8282\u70b9\u4e4b\u95f4\u53ef\u4ee5\u5b58\u5728\u591a\u4e2achannel\uff0cchannel\u4e2a\u6570\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u53c2\u6570\u914d\u7f6e\u3002"}),"\n",(0,_.jsx)(n.p,{children:"channel\u662f\u5bf9pipe\u7684\u5c01\u88c5\uff0c\u6bcf\u4e2achannel\u6709\u5b83\u81ea\u5df1\u7684id\u6807\u8bc6\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u4e00\u4e2achannel\u6709\u4e24\u4e2apipe\uff0c\u4e00\u4e2a\u9ad8\u4f18\u5148\u7ea7\uff0c\u4e00\u4e2a\u4f4e\u4f18\u5148\u7ea7\u3002"}),"\n",(0,_.jsx)(n.p,{children:(0,_.jsx)(n.img,{src:c(23727).A+"",width:"1409",height:"591"})}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief channel\ntypedef struct st_mec_channel {\n    uint32        id; ///< id\n    atomic32_t    serial_no;\n    mec_pipe_t    pipe[PRIV_CEIL]; ///< pipe\u6570\u7ec4\uff0c\u9ad8\u4f18\u5148\u7ea7\u548c\u4f4e\u4f18\u5148\u7ea7\n} mec_channel_t;\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u521b\u5efachannel\u65f6\u4f1a\u6839\u636e\u5b9e\u9645\u7684\u5b9e\u4f8b\u4e2a\u6570\uff08\u8282\u70b9\u4e2a\u6570\uff09\u521b\u5efa\u3002"}),"\n",(0,_.jsx)(n.p,{children:"channel\u5b58\u653e\u5728mec\u4e0a\u4e0b\u6587\u91cc\uff0c\u7528\u4e00\u4e2a\u4e8c\u7ef4\u6570\u7ec4\u6765\u5b58\u653e\u3002\u5176\u4e2d\u4e00\u7ef4\u662fnodeid\uff0c\u4e8c\u7ef4\u662fchannel\u7d22\u5f15\u3002\u6bd4\u5982\u4e09\u4e2a\u8282\u70b9\u7684\u96c6\u7fa4\uff0c\u82e5\u6bcf\u4e2a\u8282\u70b9\u4e4b\u95f4\u6709\u4e09\u4e2achannel\uff0c\u5219\u67099\u4e2achannel\uff08\u5b9e\u9645\u4f7f\u7528\u7684\u6ca1\u6709\u90a3\u4e48\u591a\uff0c\u81ea\u5df1\u4e0d\u4f1a\u8fde\u81ea\u5df1\u7684channel\uff09\uff0c\u56e0\u4e3a\u5728\u5206\u5e03\u5f0f\u96c6\u7fa4\u4e2d\uff0c\u5404\u8282\u70b9\u4e92\u76f8\u4e4b\u95f4\u90fd\u9700\u8981\u901a\u4fe1\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"typedef struct st_mec_context {\n    mec_lsnr_t        lsnr;\n    mec_channel_t   **channels; ///< channel\u4e8c\u7ef4\u6570\u7ec4\uff0c\u4e00\u7ef4\u662fnode_id,\u4e8c\u7ef4\u662fchannel\u7d22\u5f15\n    bool8             is_connect[CM_MAX_NODE_COUNT][MEC_MAX_CHANNEL_NUM]; ///< \u8868\u793a\u4e8c\u7ef4\u6570\u7ec4channels\u7684\u6bcf\u4e2achannel\u662f\u5426\u8fde\u63a5\u8fc7\n    mec_cb_t          cb_processer[MEC_CMD_CEIL];\n    shutdown_phase_t  phase;\n} mec_context_t;\n"})}),"\n",(0,_.jsx)(n.h4,{id:"221-\u521d\u59cb\u5316channel",children:"2.2.1 \u521d\u59cb\u5316channel"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_init_channels--\x3emec_alloc_channels--\x3emec_alloc_channel--\x3emec_init_inst_param--\x3e|\u521d\u59cb\u5316 send job and recv job|mec_init_channels_param\nmec_init_channels--\x3e|\u521d\u59cb\u5316 recv queue and send queue|mec_alloc_channel_msg_queue--\x3einit_msgqueue"}),"\n",(0,_.jsx)(n.p,{children:"\u6bcf\u4e2achannel\u6709\u4e24\u4e2apipe\uff0c\u6bcf\u4e2apipe\u53c8\u6709\u4e24\u4e2ajob\uff0c\u4e00\u4e2a\u53d1\u9001job\uff0c\u4e00\u4e2a\u63a5\u6536job\uff0c\u5728\u521d\u59cb\u5316channel\u65f6\u6ce8\u518c\uff0c\u8fd9\u4e2ajob\u5c31\u662f\u5177\u4f53\u7684\u6267\u884c\u51fd\u6570\u3002\u6700\u540e\u4f1a\u901a\u8fc7reactor\u5206\u914d\u5230agent\u7ebf\u7a0b\u4e0a\u53bb\u5177\u4f53\u6267\u884c\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"void mec_init_channels_param(mec_channel_t *channel, const mec_profile_t *profile)\n{\n    for (uint32 k = 0; k < PRIV_CEIL; k++) {\n        mec_pipe_t *pipe = &channel->pipe[k];\n        cm_init_thread_lock(&pipe->send_lock);\n        cm_init_thread_lock(&pipe->recv_lock);\n        cm_init_thread_lock(&pipe->recv_epoll_lock);\n        pipe->priv = k;\n        pipe->channel = channel;\n        pipe->attach[SEND_MODE].job = mec_proc_send_pipe;\n        pipe->attach[RECV_MODE].job = mec_proc_recv_pipe;\n        pipe->send_pipe.connect_timeout = profile->connect_timeout;\n        pipe->send_pipe.socket_timeout = profile->socket_timeout;\n        pipe->recv_pipe.connect_timeout = profile->connect_timeout;\n        pipe->recv_pipe.socket_timeout = profile->socket_timeout;\n        pipe->send_pipe.l_onoff = 1;\n        pipe->send_pipe.l_linger = 1;\n        pipe->try_connet_count = 0;\n        pipe->send_need_close = CM_FALSE;\n        pipe->recv_need_close = CM_FALSE;\n    }\n}\n"})}),"\n",(0,_.jsxs)(n.ul,{children:["\n",(0,_.jsx)(n.li,{children:"mec_proc_send_pipe"}),"\n"]}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_proc_send_pipe--\x3emec_try_connect--\x3e|\u8fde\u63a5tcp\u670d\u52a1\u7aef|cs_connect--\x3ecs_send_bytes\ncs_connect--\x3ecs_open_tcp_link--\x3e|\u53d1\u9001pipe\u5c42\u8fde\u63a5\u4fe1\u606f|cs_tcp_connect--\x3ecm_ipport_to_sockaddr--\x3ecs_create_socket--\x3ecs_tcp_send_timed--\x3ecs_tcp_wait--\x3ecs_tcp_recv_timed"}),"\n",(0,_.jsxs)(n.ul,{children:["\n",(0,_.jsx)(n.li,{children:"mec_proc_recv_pipe"}),"\n"]}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_proc_recv_pipe--\x3emec_proc_recv_msg--\x3emec_read_message--\x3emec_process_message--\x3e|\u5904\u7406\u6d88\u606f\u5b9e\u9645\u4e0a\u653e\u5165\u6d88\u606f\u961f\u5217,\u6bcf\u4e00\u4e2a\u961f\u5217\u4f1a\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b,\u7531\u7ebf\u7a0b\u5faa\u73af\u51fd\u6570\u53bb\u89e3\u6790\u6d88\u606f|dtc_task_proc--\x3e|\u6279\u91cf\u4ece\u961f\u5217\u4e2d\u53d6\u51fa\u6d88\u606f\u6765\u5904\u7406|get_batch_msgitems--\x3e|\u6279\u91cf\u5904\u7406\u63a5\u6536|dtc_proc_batch_recv--\x3edtc_proc_batch--\x3edtc_proc_batch_core--\x3edtc_recv_proc\ndtc_proc_batch--\x3edtc_decompress_batch\nget_batch_msgitems--\x3e|\u6279\u91cf\u5904\u7406\u53d1\u9001|dtc_proc_batch_send"}),"\n",(0,_.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u542f\u52a8\u76d1\u542c\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_start_lsnr--\x3ecs_start_tcp_lsnr--\x3ecs_create_lsnr_socks--\x3ecs_lsnr_init_epoll_fd--\x3esrv_tcp_lsnr_proc"}),"\n",(0,_.jsx)(n.p,{children:"\u521d\u59cb\u5316channel\u5b8c\u6210\u540e\uff0c\u8fd8\u9700\u8981\u521d\u59cb\u5316mq\u63a5\u6536\u4e0a\u4e0b\u6587\u548cmq\u53d1\u9001\u4e0a\u4e0b\u6587\u4e2d\u7684channel_private_queue\uff0c\u8fd9\u662f\u4e00\u4e2a\u4e8c\u7ef4\u6570\u7ec4\uff0c\u662f\u6d88\u606f\u961f\u5217\u7684\u5177\u4f53\u5b58\u653e\u5730\u5740\u3002\u4e00\u7ef4\u662f\u8282\u70b9id\uff0c\u4e8c\u7ef4\u662fchannel\u5bf9\u5e94\u7684\u6d88\u606f\u961f\u5217\u3002\u5047\u8bbe\u6709\u4e09\u4e2a\u8282\u70b9\uff0c\u6bcf\u4e2a\u8282\u70b9\u914d\u7f6e\u7684channel\u4e2a\u6570\u662f4\uff0c\u90a3\u4e48\u5c31\u67093*4=12\u4e2a\u6d88\u606f\u961f\u5217\uff0c\u5bf9\u5e943*4\u7684\u4e8c\u7ef4\u6570\u7ec4\u3002"}),"\n",(0,_.jsx)(n.h4,{id:"222-\u8fde\u63a5channel",children:"2.2.2 \u8fde\u63a5channel"}),"\n",(0,_.jsx)(n.p,{children:"\u5728\u521b\u5efa\u5b8clistener\uff08acceptor\uff09\u540e\u4e3b\u7ebf\u7a0b\u4f1a\u8fdb\u884cchannel\u7684connect\u64cd\u4f5c\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_connect_by_profile--\x3emec_connect--\x3e|\u8fde\u63a5\u6bcf\u4e00\u4e2achannel|mec_connect_channel--\x3e|\u8fde\u63a5\u9ad8\u4f18\u5148\u7ea7pipe\u548c\u4f4e\u4f18\u5148\u7ea7pipe|mec_conn_pipe--\x3e|\u5c06pipe\u7ed1\u5b9a\u5230agent\u4e0a\u8fd0\u884c|attach_agent--\x3e|pipe\u653e\u5165\u6210\u529f\u540e\u9700\u8981\u53d1\u9001\u4fe1\u53f7\u901a\u77e5agent\u6709\u4efb\u52a1\u5230\u6765,agent\u7ebf\u7a0b\u4f1a\u88ab\u5524\u9192\u5904\u7406job|cm_event_notify"}),"\n",(0,_.jsx)(n.p,{children:"\u6b64\u65f6\u4f1a\u5c06\u6240\u6709\u7684channel\u8fde\u63a5\uff0c\u5177\u4f53\u6765\u8bf4\u662fpipe\u8fde\u63a5\uff0cchannel\u7684\u8fde\u63a5\u5176\u5b9e\u5c31\u662fchannel\u4e24\u4e2apipe\uff08\u9ad8\u4f4e\u4f18\u5148\u7ea7\uff09\u7684\u8fde\u63a5\u3002\u901a\u8fc7\u8fd9\u4e2a\u6b65\u9aa4\uff0c\u5c31\u5c06pipe\u653e\u5165\u5230agent\u91cc\uff0c\u6b64\u65f6socket\u4e5f\u8fd8\u6ca1\u6709\u5230reactor\u91cc\uff0c\u4e14\u6b64\u65f6\u7684pipe\u662f\u53d1\u9001\u7c7b\u578b\uff0c\u8868\u660e\u9700\u8981\u4e3b\u52a8\u53d1\u9001\u6d88\u606f\uff0c\u6700\u7ec8\u6d88\u606f\u6d41\u7a0b\u8f6c\u79fb\u5230\u4e86mec_proc_send_pipe\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"23-api",children:"2.3 api"}),"\n",(0,_.jsx)(n.p,{children:"api\u6a21\u5757\u63d0\u4f9b\u4e86mec\u5bf9\u5916\u7684\u5168\u90e8\u63a5\u53e3\uff0c\u5176\u5bf9\u5e94\u7684\u5934\u6587\u4ef6\u4e3amec.h\uff0c\u5176\u4ed6\u6a21\u5757\u9700\u8981\u4f7f\u7528mec\u6a21\u5757\u7684\u529f\u80fd\u548c\u63a5\u53e3\u53ea\u9700\u8981\u5f15\u5165mec.h\u5934\u6587\u4ef6\u5373\u53ef\u3002"}),"\n",(0,_.jsx)(n.p,{children:"api\u6a21\u5757\u5b9a\u4e49\u4e86mec\u6d88\u606f\u7ed3\u6784\u548c\u6d88\u606f\u7c7b\u578b\uff0cmec\u6d88\u606f\u5206\u4e3a\u6d88\u606f\u5934\u548c\u6d88\u606f\u4f53\uff0c\u6d88\u606f\u5934\u4e3b\u8981\u662f\u5b58\u653e\u8282\u70b9\u76f8\u5173\u4fe1\u606f\u548c\u63a7\u5236\u4fe1\u606f\uff0c\u6d88\u606f\u4f53\u5b58\u653e\u5e94\u7528\u5c42\u6570\u636e\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u5934\u7ed3\u6784\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6d88\u606f\u4ea4\u6362\u5934\u90e8\ntypedef struct st_mec_message_head {\n    uint8      cmd;       ///< \u6d88\u606f\u8bf7\u6c42\u7c7b\u578b\n    uint8      flags;     ///< \u72b6\u6001\u6807\u5fd7\n    uint16     batch_size; ///< \u6279\u91cf\u6d88\u606f\u6761\u6570\n    uint32     src_inst;  ///< \u6765\u6e90id\uff08\u6e90\u8282\u70b9id\uff09\n    uint32     dst_inst;  ///< \u76ee\u7684\u8282\u70b9id\n    uint32     stream_id;   ///< \u6d41id\uff08channel id\uff09\n    uint32     size;     ///< \u6d88\u606f\u957f\u5ea6\n    uint32     serial_no; ///< channel\u5e8f\u5217\u53f7\n    uint32     frag_no;   ///< \u5206\u7247\u5e8f\u5217\u53f7\n    uint32     version;   ///< \u534f\u8bae\u7248\u672c\n    uint64     time1;\n    uint64     time2;\n    uint64     time3;\n} mec_message_head_t;\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u4f53\u7ed3\u6784\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6d88\u606f\u4f53\ntypedef struct st_mec_message {\n    mec_message_head_t *head; ///< \u6d88\u606f\u5934\u6307\u9488\n    char               *buffer; ///< \u6d88\u606f\n    uint32              buf_size; ///< \u6d88\u606f\u5927\u5c0f\n    uint32              aclt_size;\n    uint32              offset;   // for reading\n    uint32              options;  // options\n} mec_message_t;\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u5934\u4e2dcmd\u7684\u7c7b\u578b\u6709\u5982\u4e0b\u51e0\u79cd\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u4ea4\u6362\u6d88\u606f\u547d\u4ee4\ntypedef enum en_mec_command {\n    // normal cmd:\n    MEC_CMD_CONNECT                = 0, ///< \u8fde\u63a5\u8bf7\u6c42\n    MEC_CMD_HEALTH_CHECK_HIGH      = 1,\n    MEC_CMD_HEALTH_CHECK_LOW       = 2,\n    MEC_CMD_APPEND_LOG_RPC_REQ     = 3, ///< \u65e5\u5fd7\u6dfb\u52a0\u8bf7\u6c42\n    MEC_CMD_APPEND_LOG_RPC_ACK     = 4, ///< \u65e5\u5fd7\u6dfb\u52a0\u786e\u8ba4\n    MEC_CMD_VOTE_REQUEST_RPC_REQ   = 5, ///< \u6295\u7968\u8bf7\u6c42\n    MEC_CMD_VOTE_REQUEST_RPC_ACK   = 6, ///< \u6295\u7968\u786e\u8ba4\n    MEC_CMD_GET_COMMIT_INDEX_REQ   = 7, ///< \u7d22\u5f15\u63d0\u4ea4\u8bf7\u6c42\n    MEC_CMD_GET_COMMIT_INDEX_ACK   = 8, ///< \u7d22\u5f15\u63d0\u4ea4\u786e\u8ba4\n    MEC_CMD_PROMOTE_LEADER_RPC_REQ = 9, ///< \u5347\u4e3b\u8bf7\u6c42\n    MEC_CMD_BLOCK_NODE_RPC_REQ     = 10, \n    MEC_CMD_BLOCK_NODE_RPC_ACK     = 11,\n    MEC_CMD_SEND_COMMON_MSG        = 12, ///< \u53d1\u9001\u901a\u7528\u6d88\u606f\n    MEC_CMD_CHANGE_MEMBER_RPC_REQ  = 13, ///< \u6210\u5458\u53d8\u66f4\u8bf7\u6c42\n    MEC_CMD_UNIVERSAL_WRITE_REQ    = 14, ///< \u901a\u7528\u5199\u5165\u8bf7\u6c42\n    MEC_CMD_UNIVERSAL_WRITE_ACK    = 15, ///< \u901a\u7528\u5199\u5165\u786e\u8ba4\n    MEC_CMD_STATUS_CHECK_RPC_REQ   = 16, ///< \u72b6\u6001\u68c0\u67e5\u8bf7\u6c42\n    MEC_CMD_STATUS_CHECK_RPC_ACK   = 17, ///< \u72b6\u6001\u68c0\u67e5\u786e\u8ba4\n\n    MEC_CMD_NORMAL_CEIL, ///< \u5728\u8fd9\u4e2a\u679a\u4e3e\u524d\u6dfb\u52a0\u65b0\u7684\u8bf7\u6c42\uff0c\u5728\u540e\u9762\u6dfb\u52a0\u6d4b\u8bd5\u8bf7\u6c42\uff0c\u6bd4\u8fd9\u4e2a\u679a\u4e3e\u503c\u5927\u4ec5\u7528\u4e8e\u6d4b\u8bd5\n\n    // test cmd:\n    MEC_CMD_TEST_REQ  = MEC_CMD_NORMAL_CEIL + 1, ///< \u6d4b\u8bd5\u8bf7\u6c42\n    MEC_CMD_TEST_ACK  = MEC_CMD_NORMAL_CEIL + 2, ///< \u6d4b\u8bd5\u786e\u8ba4\n    MEC_CMD_TEST1_REQ = MEC_CMD_NORMAL_CEIL + 3,\n    MEC_CMD_TEST1_ACK = MEC_CMD_NORMAL_CEIL + 4,\n    MEC_CMD_BRD_TEST  = MEC_CMD_NORMAL_CEIL + 5,\n\n    MEC_CMD_CEIL,\n} mec_command_t;\n"})}),"\n",(0,_.jsx)(n.p,{children:"mec\u5bf9\u5916\u63d0\u4f9b\u7684\u63a5\u53e3\u4e3b\u8981\u5206\u4e3a\u4ee5\u4e0b\u51e0\u7c7b\uff1a"}),"\n",(0,_.jsxs)(n.ul,{children:["\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u521d\u59cb\u5316mec\u548c\u91ca\u653emec\u8d44\u6e90"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u521d\u59cb\u5316mec\n/// @return \nstatus_t mec_init();\n\n/// @brief \u91ca\u653emec\u76f8\u5173\u8d44\u6e90\nvoid     mec_deinit();\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u8fd9\u4e24\u4e2a\u63a5\u53e3\u4e3b\u8981\u662f\u4e3b\u7ebf\u7a0b\u521b\u5efa\u7684\u65f6\u5019\u8c03\u7528\u548c\u4e3b\u7ebf\u7a0b\u9000\u51fa\u524d\u8c03\u7528\u3002"}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u5904\u7406\u51fd\u6570\u6ce8\u518c\u548c\u6ce8\u9500\u63a5\u53e3"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6ce8\u518c\u6d88\u606f\u5904\u7406\u51fd\u6570,\u5c06\u6d88\u606f\u6ce8\u518c\u5230mec\u4e0a\u4e0b\u6587\u7684\u56de\u8c03\u91cc\uff0c\u5f53\u6536\u5230\u76f8\u5173\u8bf7\u6c42\u7c7b\u578b\u7684\u6570\u636e\u65f6\uff0c\u4f1a\u8c03\u7528proc\u51fd\u6570\u8fdb\u884c\u5904\u7406\n/// @param cmd \u5904\u7406\u51fd\u6570\u5bf9\u5e94\u7684\u6d88\u606f\u7c7b\u578b\n/// @param proc \u6d88\u606f\u7c7b\u578b\u5bf9\u5e94\u7684\u5904\u7406\u51fd\u6570\n/// @param priv \u6d88\u606f\u7684\u4f18\u5148\u7ea7(\u9ad8\u4f18\u5148\u7ea7\u6216\u8005\u4f4e\u4f18\u5148\u7ea7)\nvoid register_msg_process(mec_command_t cmd, msg_proc_t proc, msg_priv_t priv)\n{\n    mec_context_t *mec_ctx = get_mec_ctx();\n    if (cmd >= MEC_CMD_CEIL) {\n        return;\n    }\n    mec_ctx->cb_processer[cmd].priv = priv;\n    mec_ctx->cb_processer[cmd].proc = proc;\n}\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u5904\u7406\u51fd\u6570\u4e5f\u53ef\u4ee5\u6ce8\u9500\uff0c\u6ce8\u9500\u540e\u53ef\u91cd\u65b0\u8fdb\u884c\u6ce8\u518c\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6ce8\u9500cmd\u7c7b\u578b\u7684\u6d88\u606f\u5904\u7406\u51fd\u6570\n/// @param cmd \u6d88\u606f\u7c7b\u578b\nvoid unregister_msg_process(mec_command_t cmd)\n{\n    mec_context_t *mec_ctx = get_mec_ctx();\n    mec_ctx->cb_processer[cmd].proc = NULL;\n    mec_ctx->cb_processer[cmd].priv = PRIV_CEIL;\n}\n"})}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u53d1\u9001\u548c\u63a5\u6536\u6d88\u606f\u63a5\u53e3"}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u53d1\u9001\u4e00\u822c\u662f\u591a\u4e2a\u63a5\u53e3\u7ed3\u5408\u4f7f\u7528\uff0c\u4e00\u822c\u6d41\u7a0b\u4e3a\uff1a"}),"\n",(0,_.jsxs)(n.ol,{children:["\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u5148\u7533\u8bf7\u4e00\u4e2apack\uff0c\u5bf9\u5e94\u7684\u63a5\u53e3\u4e3a\uff1b"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u5206\u914d\u4e00\u4e2a\u6d88\u606f\uff0c\u5728\u5e7f\u64ad\u573a\u666f\u4e2d\uff0cdst_inst \u5fc5\u987b\u662f CM_INVALID_NODE_ID\n/// @param pack \u6d88\u606f\u6307\u9488\n/// @param cmd \u6d88\u606f\u7c7b\u578b\n/// @param src_inst \u6d88\u606f\u53d1\u51fa\u65b9\n/// @param dst_inst \u6d88\u606f\u63a5\u6536\u65b9\n/// @param stream_id \u6d41id\n/// @return \nstatus_t mec_alloc_pack(mec_message_t *pack, mec_command_t cmd, uint32 src_inst, uint32 dst_inst, uint32 stream_id);\n"})}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u5f80pack\u91ccput\u6570\u636e\uff0c\u5bf9\u5e94\u7684\u63a5\u53e3\u6839\u636e\u6570\u636e\u7c7b\u578b\u7684\u4e0d\u540c\u5206\u4e3a\u5982\u4e0b\u51e0\u4e2a\uff0c\u652f\u6301\u7684\u6570\u636e\u7c7b\u578b\u6709int64\u3001int32\u3001int16\u3001double\u3001bin\uff1b"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u5f80\u6d88\u606f\u91cc\u6dfb\u52a0int64\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u6570\u636e\u503c\n/// @return \nstatus_t mec_put_int64(mec_message_t *pack, uint64 value);\n/// @brief \u5f80\u6d88\u606f\u91cc\u6dfb\u52a0int32\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u6570\u636e\u503c\n/// @return \nstatus_t mec_put_int32(mec_message_t *pack, uint32 value);\n/// @brief \u5f80\u6d88\u606f\u91cc\u6dfb\u52a0int16\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u6570\u636e\u503c\n/// @return \nstatus_t mec_put_int16(mec_message_t *pack, uint16 value);\n/// @brief \u5f80\u6d88\u606f\u91cc\u6dfb\u52a0double\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u6570\u636e\u503c\n/// @return \nstatus_t mec_put_double(mec_message_t *pack, double value);\n/// @brief \u5f80\u6d88\u606f\u91cc\u6dfb\u52a0\u5b57\u8282\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param size \u6dfb\u52a0\u7684\u6570\u636e\u957f\u5ea6\n/// @param buffer \u6570\u636e\u5730\u5740\n/// @return \nstatus_t mec_put_bin(mec_message_t *pack, uint32 size, const void *buffer);\n"})}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u5c06\u6d88\u606f\u53d1\u51fa\u53bb\uff0c\u5bf9\u5e94\u7684\u63a5\u53e3\u4e3amec_send_data\uff1b"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u901a\u8fc7mec\u53d1\u9001\u6d88\u606f\n/// @param pack \n/// @return \nstatus_t mec_send_data(mec_message_t *pack);\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u53d1\u9001\u9664\u4e86\u8c03\u7528mec_send_data\u53d1\u9001\u6570\u636e\u5230\u5355\u4e2a\u8282\u70b9\u5916\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528\u5e7f\u64ad\u63a5\u53e3\u5c06\u6570\u636e\u53d1\u9001\u5230\u6240\u6709\u8282\u70b9\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u901a\u8fc7mec\u5e7f\u64ad\u4e00\u6761\u6d88\u606f\n/// @param stream_id \u6d41id\n/// @param inst_bits \n/// @param pack \u6d88\u606f\n/// @param success_bits \nvoid mec_broadcast(uint32 stream_id, uint64 inst_bits[INSTS_BIT_SZ], mec_message_t *pack,\n    uint64 success_bits[INSTS_BIT_SZ]);\n"})}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u53d1\u9001\u6210\u529f\u540e\uff0c\u91ca\u653e\u7533\u8bf7\u7684\u5305"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u91ca\u653e\u6d88\u606f\u7684\u8d44\u6e90\n/// @param pack \nvoid mec_release_pack(mec_message_t *pack);\n"})}),"\n"]}),"\n"]}),"\n",(0,_.jsx)(n.p,{children:"\u6bd4\u5982\u53d1\u9001\u4e00\u4e2aMEC_CMD_BLOCK_NODE_RPC_REQ\u8bf7\u6c42\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'status_t block_node_req(uint32 stream_id, uint32 node_id, uint32 block_time_ms)\n{\n    mec_message_t pack;\n    uint32 src_node = md_get_cur_node(); ///< \u83b7\u53d6\u672c\u8282\u70b9\u7684id\n    ///< \u7533\u8bf7\u4e00\u4e2a\u5305\n    CM_RETURN_IFERR(mec_alloc_pack(&pack, MEC_CMD_BLOCK_NODE_RPC_REQ, src_node, node_id, stream_id));\n    if (mec_put_int32(&pack, block_time_ms) != CM_SUCCESS) { ///< \u5f80\u5305\u91ccput\u6570\u636e\n        mec_release_pack(&pack);\n        LOG_DEBUG_ERR("block node req, encode fail.");\n        return CM_ERROR;\n    }\n    LOG_DEBUG_INF("send blockreq: stream=%u,src=%u,dst=%u,block_time=%u.", stream_id, src_node, node_id, block_time_ms);\n    status_t ret = mec_send_data(&pack);///< \u53d1\u9001\u6570\u636e\n    mec_release_pack(&pack); ///< \u91ca\u653e\u5305\n    return ret;\n}\n'})}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u63a5\u6536\u4e00\u822c\u662f\u5728cmd\u6ce8\u518c\u7684proc\u91cc\u9762\uff0c\u5f53mec\u63a5\u6536\u5230\u6d88\u606f\uff0c\u5e76\u6839\u636e\u6d88\u606f\u7c7b\u578b\u5c06\u6d88\u606f\u4ea4\u7ed9\u6ce8\u518c\u7684proc\u5904\u7406\u65f6\uff0c\u5c31\u53ef\u4ee5\u8c03\u7528\u6d88\u606f\u8bfb\u53d6\u63a5\u53e3\u8bfb\u53d6\u6570\u636e\u3002\u8bfb\u53d6\u6570\u636e\u4e5f\u6839\u636e\u6570\u636e\u7c7b\u578b\u5206\u4e3a\u51e0\u7c7b\uff0c\u652f\u6301\u7684\u6570\u636e\u7c7b\u578b\u6709int64\u3001int32\u3001int16\u3001double\u3001bin\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u4ece\u6d88\u606f\u4e2d\u8bfb\u53d6int64\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u8bfb\u53d6\u51fa\u6765\u7684\u503c\n/// @return \nstatus_t mec_get_int64(mec_message_t *pack, int64 *value);\n/// @brief \u4ece\u6d88\u606f\u4e2d\u8bfb\u53d6int32\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u8bfb\u53d6\u51fa\u6765\u7684\u503c\n/// @return \nstatus_t mec_get_int32(mec_message_t *pack, int32 *value);\n\n/// @brief \u6ce8\u518c\u52a0\u5bc6\u56de\u8c03\u51fd\u6570\n/// @param cb_func \u52a0\u5bc6\u56de\u8c03\u51fd\u6570\n/// @return \nstatus_t mec_register_decrypt_pwd(usr_cb_decrypt_pwd_t cb_func);\n\n/* need keep 4-byte align by the caller */\n/// @brief \u4ece\u6d88\u606f\u4e2d\u8bfb\u53d6int16\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u8bfb\u53d6\u51fa\u6765\u7684\u503c\n/// @return \nstatus_t mec_get_int16(mec_message_t *pack, int16 *value);\n\n/// @brief \u4ece\u6d88\u606f\u4e2d\u8bfb\u53d6double\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u8bfb\u53d6\u51fa\u6765\u7684\u503c\n/// @return \nstatus_t mec_get_double(mec_message_t *pack, double *value);\n\n/// @brief \u4ece\u6d88\u606f\u4e2d\u8bfb\u53d6\u6307\u5b9a\u957f\u5ea6\u5b57\u8282\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param size \u8bfb\u53d6\u5b57\u8282\u957f\u5ea6\n/// @param buffer \u6570\u636e\u5b58\u653e\u5730\u5740\n/// @return \nstatus_t mec_get_bin(mec_message_t *pack, uint32 *size, void **buffer);\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6bd4\u5982\u63a5\u6536MEC_CMD_BLOCK_NODE_RPC_REQ\u7684\u6d88\u606f\u8bfb\u53d6\u65b9\u5f0f\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'tatus_t block_node_req_proc(mec_message_t *pack)\n{\n    uint32 stream_id = pack->head->stream_id;\n    uint32 src_node_id = pack->head->src_inst;\n    LOG_DEBUG_INF("recv blockreq: stream_id=%u, node_id=%u", stream_id, src_node_id);\n\n    uint32 block_time_ms;\n    CM_RETURN_IFERR(mec_get_int32(pack, (int32*)&block_time_ms));///< \u8bfb\u53d6int32\u6570\u636e\n\n    block_ack_t ack = SUCCESS_ACK;\n    if (elc_get_node_role(stream_id) != DCF_ROLE_LEADER\n        || set_node_status(stream_id, NODE_BLOCKED, block_time_ms) != CM_SUCCESS) {\n        ack = ERROR_ACK;\n    }\n    CM_RETURN_IFERR(block_node_ack(stream_id, src_node_id, ack));\n\n    if (ack == ERROR_ACK) {\n        return CM_SUCCESS;\n    }\n\n    LOG_DEBUG_INF("set node blocked, block_time_ms=%u.", block_time_ms);\n    cm_event_notify(&g_node_status[stream_id].block.event);\n    return CM_SUCCESS;\n}\n'})}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u7533\u8bf7\u6d88\u606f\u5185\u5b58\u548c\u91ca\u653e\u6d88\u606f\u63a5\u53e3"}),"\n",(0,_.jsx)(n.p,{children:"\u8fd9\u4e24\u4e2a\u63a5\u53e3\u4e00\u822c\u5728\u53d1\u5305\u524d\u8c03\u7528\u6d88\u606f\u7533\u8bf7\u63a5\u53e3\uff0c\u53d1\u5305\u7ed3\u675f\u540e\u8c03\u7528\u6d88\u606f\u91ca\u653e\u63a5\u53e3\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u91ca\u653e\u6d88\u606f\u7684\u8d44\u6e90\n/// @param pack \nvoid mec_release_pack(mec_message_t *pack);\n/// @brief \u5206\u914d\u4e00\u4e2a\u6d88\u606f\uff0c\u5728\u5e7f\u64ad\u573a\u666f\u4e2d\uff0cdst_inst \u5fc5\u987b\u662f CM_INVALID_NODE_ID\n/// @param pack \u6d88\u606f\u6307\u9488\n/// @param cmd \u6d88\u606f\u7c7b\u578b\n/// @param src_inst \u6d88\u606f\u53d1\u51fa\u65b9\n/// @param dst_inst \u6d88\u606f\u63a5\u6536\u65b9\n/// @param stream_id \u6d41id\n/// @return \nstatus_t mec_alloc_pack(mec_message_t *pack, mec_command_t cmd, uint32 src_inst, uint32 dst_inst, uint32 stream_id);\n"})}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u5176\u4ed6\u63a5\u53e3"}),"\n"]}),"\n"]}),"\n",(0,_.jsx)(n.p,{children:"mec\u5bf9\u5916\u63d0\u4f9b\u7684\u5b8c\u6574\u63a5\u53e3\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6d88\u606f\u4ea4\u6362\u5934\u90e8\ntypedef struct st_mec_message_head {\n    uint8      cmd;       // command\n    uint8      flags;\n    uint16     batch_size; // batch size\n    uint32     src_inst;  // from instance\n    uint32     dst_inst;  // to instance\n    uint32     stream_id;   // stream id\n    uint32     size;\n    uint32     serial_no;\n    uint32     frag_no;\n    uint32     version;\n    uint64     time1;\n    uint64     time2;\n    uint64     time3;\n} mec_message_head_t;\n\n/// @brief \u6d88\u606f\u4f53\ntypedef struct st_mec_message {\n    mec_message_head_t *head;\n    char               *buffer;\n    uint32              buf_size;\n    uint32              aclt_size;\n    uint32              offset;   // for reading\n    uint32              options;  // options\n} mec_message_t;\n\n/// @brief \u4ea4\u6362\u6d88\u606f\u547d\u4ee4\ntypedef enum en_mec_command {\n    // normal cmd:\n    MEC_CMD_CONNECT                = 0, ///< \u8fde\u63a5\u8bf7\u6c42\n    MEC_CMD_HEALTH_CHECK_HIGH      = 1,\n    MEC_CMD_HEALTH_CHECK_LOW       = 2,\n    MEC_CMD_APPEND_LOG_RPC_REQ     = 3, ///< \u65e5\u5fd7\u6dfb\u52a0\u8bf7\u6c42\n    MEC_CMD_APPEND_LOG_RPC_ACK     = 4, ///< \u65e5\u5fd7\u6dfb\u52a0\u786e\u8ba4\n    MEC_CMD_VOTE_REQUEST_RPC_REQ   = 5, ///< \u6295\u7968\u8bf7\u6c42\n    MEC_CMD_VOTE_REQUEST_RPC_ACK   = 6, ///< \u6295\u7968\u786e\u8ba4\n    MEC_CMD_GET_COMMIT_INDEX_REQ   = 7, ///< \u7d22\u5f15\u63d0\u4ea4\u8bf7\u6c42\n    MEC_CMD_GET_COMMIT_INDEX_ACK   = 8, ///< \u7d22\u5f15\u63d0\u4ea4\u786e\u8ba4\n    MEC_CMD_PROMOTE_LEADER_RPC_REQ = 9, ///< \u5347\u4e3b\u8bf7\u6c42\n    MEC_CMD_BLOCK_NODE_RPC_REQ     = 10, \n    MEC_CMD_BLOCK_NODE_RPC_ACK     = 11,\n    MEC_CMD_SEND_COMMON_MSG        = 12, ///< \u53d1\u9001\u901a\u7528\u6d88\u606f\n    MEC_CMD_CHANGE_MEMBER_RPC_REQ  = 13, ///< \u6210\u5458\u53d8\u66f4\u8bf7\u6c42\n    MEC_CMD_UNIVERSAL_WRITE_REQ    = 14, ///< \u901a\u7528\u5199\u5165\u8bf7\u6c42\n    MEC_CMD_UNIVERSAL_WRITE_ACK    = 15, ///< \u901a\u7528\u5199\u5165\u786e\u8ba4\n    MEC_CMD_STATUS_CHECK_RPC_REQ   = 16, ///< \u72b6\u6001\u68c0\u67e5\u8bf7\u6c42\n    MEC_CMD_STATUS_CHECK_RPC_ACK   = 17, ///< \u72b6\u6001\u68c0\u67e5\u786e\u8ba4\n\n    MEC_CMD_NORMAL_CEIL, // please add normal cmd before this\n\n    // test cmd:\n    MEC_CMD_TEST_REQ  = MEC_CMD_NORMAL_CEIL + 1, ///< \u6d4b\u8bd5\u8bf7\u6c42\n    MEC_CMD_TEST_ACK  = MEC_CMD_NORMAL_CEIL + 2, ///< \u6d4b\u8bd5\u786e\u8ba4\n    MEC_CMD_TEST1_REQ = MEC_CMD_NORMAL_CEIL + 3,\n    MEC_CMD_TEST1_ACK = MEC_CMD_NORMAL_CEIL + 4,\n    MEC_CMD_BRD_TEST  = MEC_CMD_NORMAL_CEIL + 5,\n\n    MEC_CMD_CEIL,\n} mec_command_t;\n\n/// @brief \u4ea4\u6362\u6d88\u606f\u6570\u636e\u7c7b\u578b\ntypedef enum en_mec_type {\n    TYPE_INT64, ///< 64\u4f4d\u6574\u6570\n    TYPE_INT32, ///< 32\u4f4d\u6574\u6570\n    TYPE_INT16, ///< 16\u4f4d\u6574\u6570\n    TYPE_DOUBLE, ///< \u53cc\u7cbe\u5ea6\u6d6e\u70b9\u6570\n    TYPE_BINARY, ///< \u4e8c\u8fdb\u5236\u6570\u636e\n} mec_type_t;\n\n/// @brief \u6d88\u606f\u4f18\u5148\u7ea7\ntypedef enum en_msg_priv {\n    PRIV_HIGH = 0, ///< \u9ad8\u4f18\u5148\u7ea7\u6d88\u606f high priority message\n    PRIV_LOW  = 1, ///< \u4f4e\u4f18\u5148\u7ea7\u6d88\u606f low priority message\n    PRIV_CEIL,\n} msg_priv_t;\n\n/// @brief \u6d88\u606f\u5904\u7406\u51fd\u6570\ntypedef status_t(*msg_proc_t)(mec_message_t *pack);\n\n/// @brief \u6ce8\u518c\u6d88\u606f\u5904\u7406\u51fd\u6570\n/// @param cmd \u5904\u7406\u51fd\u6570\u5bf9\u5e94\u7684\u6d88\u606f\u7c7b\u578b\n/// @param proc \u6d88\u606f\u7c7b\u578b\u5bf9\u5e94\u7684\u5904\u7406\u51fd\u6570\n/// @param priv \u6d88\u606f\u7684\u4f18\u5148\u7ea7\nvoid register_msg_process(mec_command_t cmd, msg_proc_t proc, msg_priv_t priv);\n\n/// @brief \u6ce8\u9500cmd\u7c7b\u578b\u7684\u6d88\u606f\u5904\u7406\u51fd\u6570\n/// @param cmd \u6d88\u606f\u7c7b\u578b\nvoid unregister_msg_process(mec_command_t cmd);\n\n\n#define INST_STEP (sizeof(uint64) * 8)\n#define INSTS_BIT_SZ ((CM_MAX_NODE_COUNT - 1) / INST_STEP + 1)\n\n#define MEC_SET_BRD_INST(bits, id) CM_BIT_SET((bits)[(id) / INST_STEP], CM_GET_MASK((id) % INST_STEP))\n#define MEC_RESET_BRD_INST(bits, id) CM_BIT_RESET((bits)[(id) / INST_STEP], CM_GET_MASK((id) % INST_STEP))\n#define MEC_IS_INST_SEND(bits, id) CM_BIT_TEST((bits)[(id) / INST_STEP], CM_GET_MASK((id) % INST_STEP))\n#define MEC_INST_SENT_SUCCESS(bits, id) ((bits)[(id) / INST_STEP] |= ((uint64)0x1 << ((id) % INST_STEP)))\n\n\n/// @brief \u5206\u914d\u4e00\u4e2a\u6d88\u606f\uff0c\u5728\u5e7f\u64ad\u573a\u666f\u4e2d\uff0cdst_inst \u5fc5\u987b\u662f CM_INVALID_NODE_ID\n/// @param pack \u6d88\u606f\u6307\u9488\n/// @param cmd \u6d88\u606f\u7c7b\u578b\n/// @param src_inst \u6d88\u606f\u53d1\u51fa\u65b9\n/// @param dst_inst \u6d88\u606f\u63a5\u6536\u65b9\n/// @param stream_id \u6d41id\n/// @return \nstatus_t mec_alloc_pack(mec_message_t *pack, mec_command_t cmd, uint32 src_inst, uint32 dst_inst, uint32 stream_id);\n\n/// @brief \u521d\u59cb\u5316mec\n/// @return \nstatus_t mec_init();\n\n/// @brief \u91ca\u653emec\u76f8\u5173\u8d44\u6e90\nvoid     mec_deinit();\n\n/// @brief \u901a\u8fc7mec\u53d1\u9001\u6d88\u606f\n/// @param pack \n/// @return \nstatus_t mec_send_data(mec_message_t *pack);\n/* pack memory released by mec_broadcast itself, invoker no need to care */\n\n/// @brief \u901a\u8fc7mec\u5e7f\u64ad\u4e00\u6761\u6d88\u606f\n/// @param stream_id \u6d41id\n/// @param inst_bits \n/// @param pack \u6d88\u606f\n/// @param success_bits \nvoid mec_broadcast(uint32 stream_id, uint64 inst_bits[INSTS_BIT_SZ], mec_message_t *pack,\n    uint64 success_bits[INSTS_BIT_SZ]);\n\n/// @brief \u91ca\u653e\u6d88\u606f\u7684\u8d44\u6e90\n/// @param pack \nvoid mec_release_pack(mec_message_t *pack);\n\n/// @brief \u5f80\u6d88\u606f\u91cc\u6dfb\u52a0int64\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u6570\u636e\u503c\n/// @return \nstatus_t mec_put_int64(mec_message_t *pack, uint64 value);\n/// @brief \u5f80\u6d88\u606f\u91cc\u6dfb\u52a0int32\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u6570\u636e\u503c\n/// @return \nstatus_t mec_put_int32(mec_message_t *pack, uint32 value);\n/// @brief \u5f80\u6d88\u606f\u91cc\u6dfb\u52a0int16\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u6570\u636e\u503c\n/// @return \nstatus_t mec_put_int16(mec_message_t *pack, uint16 value);\n/// @brief \u5f80\u6d88\u606f\u91cc\u6dfb\u52a0double\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u6570\u636e\u503c\n/// @return \nstatus_t mec_put_double(mec_message_t *pack, double value);\n/// @brief \u5f80\u6d88\u606f\u91cc\u6dfb\u52a0\u5b57\u8282\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param size \u6dfb\u52a0\u7684\u6570\u636e\u957f\u5ea6\n/// @param buffer \u6570\u636e\u5730\u5740\n/// @return \nstatus_t mec_put_bin(mec_message_t *pack, uint32 size, const void *buffer);\n\n/// @brief \u4ece\u6d88\u606f\u4e2d\u8bfb\u53d6int64\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u8bfb\u53d6\u51fa\u6765\u7684\u503c\n/// @return \nstatus_t mec_get_int64(mec_message_t *pack, int64 *value);\n/// @brief \u4ece\u6d88\u606f\u4e2d\u8bfb\u53d6int32\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u8bfb\u53d6\u51fa\u6765\u7684\u503c\n/// @return \nstatus_t mec_get_int32(mec_message_t *pack, int32 *value);\n\n/// @brief \u6ce8\u518c\u52a0\u5bc6\u56de\u8c03\u51fd\u6570\n/// @param cb_func \u52a0\u5bc6\u56de\u8c03\u51fd\u6570\n/// @return \nstatus_t mec_register_decrypt_pwd(usr_cb_decrypt_pwd_t cb_func);\n\n/* need keep 4-byte align by the caller */\n/// @brief \u4ece\u6d88\u606f\u4e2d\u8bfb\u53d6int16\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u8bfb\u53d6\u51fa\u6765\u7684\u503c\n/// @return \nstatus_t mec_get_int16(mec_message_t *pack, int16 *value);\n\n/// @brief \u4ece\u6d88\u606f\u4e2d\u8bfb\u53d6double\u7c7b\u578b\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param value \u8bfb\u53d6\u51fa\u6765\u7684\u503c\n/// @return \nstatus_t mec_get_double(mec_message_t *pack, double *value);\n\n/// @brief \u4ece\u6d88\u606f\u4e2d\u8bfb\u53d6\u6307\u5b9a\u957f\u5ea6\u5b57\u8282\u7684\u6570\u636e\n/// @param pack \u6d88\u606f\n/// @param size \u8bfb\u53d6\u5b57\u8282\u957f\u5ea6\n/// @param buffer \u6570\u636e\u5b58\u653e\u5730\u5740\n/// @return \nstatus_t mec_get_bin(mec_message_t *pack, uint32 *size, void **buffer);\n\n/// @brief \u83b7\u53d6\u53d1\u9001\u961f\u5217\u957f\u5ea6\n/// @param priv \n/// @return \nuint32 mec_get_send_que_count(msg_priv_t priv);\n/// @brief \u83b7\u53d6\u63a5\u6536\u961f\u5217\u957f\u5ea6\n/// @param priv \n/// @return \nuint32 mec_get_recv_que_count(msg_priv_t priv);\n/// @brief \u83b7\u53d6\u53d1\u9001\u5185\u5b58\u7684\u5bb9\u91cf\n/// @param priv \n/// @return \nint64 mec_get_send_mem_capacity(msg_priv_t priv);\n/// @brief \u83b7\u53d6\u63a5\u6536\u5185\u5b58\u7684\u5bb9\u91cf\n/// @param priv \u6d88\u606f\u4f18\u5148\u7ea7\n/// @return \nint64 mec_get_recv_mem_capacity(msg_priv_t priv);\n/// @brief \u68c0\u67e5\u6240\u6709\u7684\u8fde\u63a5\u662f\u5426ok\n/// @return \nbool32 mec_check_all_connect();\n/// @brief \u68c0\u67e5\u6d88\u606f\u4ea4\u6362\u662f\u5426\u5c31\u7eea\n/// @param stream_id \u6d41id\n/// @param dst_inst \u76ee\u7684\u8282\u70b9\n/// @param priv \u6d88\u606f\u4f18\u5148\u7ea7\n/// @return \nbool32 mec_is_ready(uint32 stream_id, uint32 dst_inst, msg_priv_t priv);\n/// @brief \u83b7\u53d6\u5bf9\u7aef\u7684\u6d88\u606f\u4ea4\u6362\u6a21\u5757\u7248\u672c\n/// @param stream_id \u6d41id\n/// @param dst_inst \u76ee\u7684\u8282\u70b9\n/// @param peer_version \u5bf9\u7aef\u7248\u672c\n/// @return \nstatus_t mec_get_peer_version(uint32 stream_id, uint32 dst_inst, uint32 *peer_version);\n\n/// @brief \u83b7\u53d6\u63a5\u6536\u6d88\u606f\u4e2d\u7684\u7248\u672c\u53f7\n/// @param pack \n/// @return \nstatic inline uint32 mec_get_recv_pack_version(const mec_message_t *pack)\n{\n    return pack->head->version;\n}\n\nuint32 mec_get_write_pos(const mec_message_t *pack);\nvoid mec_modify_int64(mec_message_t *pack, uint32 pos, uint64 value);\n"})}),"\n",(0,_.jsx)(n.h3,{id:"24-func",children:"2.4 func"}),"\n",(0,_.jsx)(n.p,{children:"\u662f\u4e00\u4e9b\u4e3b\u8981\u51fd\u6570\u7684\u5b9e\u73b0\uff0c\u6b64\u5904\u4e0d\u505a\u5c55\u5f00\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"25-queue",children:"2.5 queue"}),"\n",(0,_.jsx)(n.p,{children:"\u961f\u5217\u5206\u4e3a\u4e24\u7c7b\uff0c\u4e00\u7c7b\u662fsend_mq\uff0c\u53e6\u4e00\u7c7b\u662frecv_mq\uff0c\u79f0\u4e3a\u53d1\u9001\u4e0a\u4e0b\u6587\u548c\u63a5\u6536\u4e0a\u4e0b\u6587\u3002\u961f\u5217\u4e0a\u4e0b\u6587\u4fdd\u5b58\u5728\u5168\u5c40\u7684mec_instance_t\u4e2d\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u961f\u5217\u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6d88\u606f\u961f\u5217\u4e0a\u4e0b\u6587\ntypedef struct st_mq_context_t {\n    thread_t tasks[MEC_DEFALT_THREAD_NUM + 1]; ///< \u7ebf\u7a0bid\u6570\u7ec4\n    task_arg_t  work_thread_idx[MEC_DEFALT_THREAD_NUM + 1]; ///< \u7ebf\u7a0b\u5bf9\u5e94\u7684\u4efb\u52a1\u53c2\u6570\n    // msg queue for session background task, multiple queue to reduce contention\n    dtc_msgqueue_t   queue[DTC_MSG_QUEUE_NUM + 1]; ///< \u961f\u5217\u6570\u7ec4\n    dtc_msgitem_pool_t  pool; ///< dtc\u6d88\u606f\u961f\u5217\u6c60\n    dtc_msgqueue_t  **channel_private_queue;\n    mec_profile_t    *profile; ///< mec\u4e3b\u8981\u4fe1\u606f\n    void *mec_ctx; ///< mec \u4e0a\u4e0b\u6587\n    void *fragment_ctx; ///< \u5206\u7247\u4e0a\u4e0b\u6587\n    spinlock_t      private_pool_init_lock; ///< \u81ea\u65cb\u9501\n    uint32          private_msg_pool_extent[PRIV_CEIL];\n    message_pool_t *private_pool[CM_MAX_NODE_COUNT][PRIV_CEIL]; ///< \u79c1\u6709\u6d88\u606f\u6c60\uff0c\u5bf9\u5e94\u9ad8\u4f4e\u4f18\u5148\u7ea7\n    message_pool_t msg_pool[PRIV_CEIL]; ///< \u6d88\u606f\u6c60\n} mq_context_t;\n"})}),"\n",(0,_.jsx)(n.p,{children:"message_pool_t\u5229\u7528\u6307\u9488\u6570\u7ec4\u6765\u5b58\u50a8\u6570\u636e\uff0c\u5176\u7ed3\u6784\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6d88\u606f\u6c60\ntypedef struct st_message_pool {\n    spinlock_t        lock;\n    uint32            msg_len;  ///< \u6d88\u606f\u957f\u5ea6\n    char             *extents[MSG_POOL_MAX_EXTENTS]; ///< extent\uff08buffer\uff09\u6570\u7ec4\n    volatile uint32   capacity; ///< \u5bb9\u91cf\n    uint32            count;    ///< \u5927\u5c0f\n    uint32            ext_cnt;  ///< ext\u73b0\u6709\u4e2a\u6570\n    uint32            free_first; ///< \u7b2c\u4e00\u4e2a\u7a7a\u95f2ext\u7d22\u5f15\n    volatile uint32   free_count; ///< \u7a7a\u95f2\u4e2a\u6570\n    volatile bool32   extending;  ///< \u6b63\u5728extend\n    uint32            msg_pool_extent; ///< ext\u4e2a\u6570\n    cm_event_t        event;\n} message_pool_t;\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u5176\u4e2d\u5b9e\u9645\u6570\u636e\u5b58\u50a8\u5728extents\u6570\u7ec4\u5185\uff0c\u6570\u7ec4\u5185\u7684\u6bcf\u4e00\u4e2a\u6307\u9488\u53c8\u6307\u5411\u4e00\u6bb5\u5185\u5b58\uff0c\u6bcf\u4e00\u6bb5\u5185\u5b58\u90fd\u7533\u8bf7\u4e86msg_pool_extent\u4e2aitem\u3002"}),"\n",(0,_.jsx)(n.p,{children:"extents\u6570\u7ec4\u4e2d\u7684\u5185\u5b58\u662f\u6309\u9700\u7533\u8bf7\u5206\u914d\u7684\uff0c\u5f53extent\u4e2a\u6570\u4e0d\u591f\u65f6\uff0c\u53c8\u4f1a\u91cd\u65b0\u7533\u8bf7\u4e00\u6bb5\u5185\u5b58\uff0c\u6bcf\u7533\u8bf7\u4e00\u6b21ext_cnt\u90fd\u4f1a\u589e\u52a01\uff0c\u76f4\u5230ext_cnt\u4e2a\u6570\u8fbe\u5230MSG_POOL_MAX_EXTENTS\uff0c\u6216\u8005\u8bf4\u76f4\u5230capacity\u8fbe\u5230\u6700\u5927\u503cext_cnt*msg_pool_extent\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u5b9e\u9645\u7684\u6d88\u606f\u5b58\u653e\u5728msg_item_t\u91cc\uff0c\u800cmessage_pool_t\u91cc\u7684extents\u6570\u7ec4\u7684\u6bcf\u4e00\u4e2a\u5143\u7d20\u5176\u5b9e\u662fmsg_pool_extent\u4e2amsg_item_t\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6d88\u606f\ntypedef struct st_msg_item {\n    message_pool_t *pool; ///< \u6240\u5c5e\u7684pool\n    uint32          id;  ///< id\uff0c\u7528\u6765\u7d22\u5f15\n    uint32          next; ///< \u4e0b\u4e00\u4e2aitem\u7684\u7d22\u5f15\n    char            buffer[0]; ///< \u5b58\u653e\u5b9e\u9645\u7684\u6570\u636e\n} msg_item_t;\n"})}),"\n",(0,_.jsx)(n.p,{children:"dtc_msgitem_pool_t\u662f\u6d88\u606f\u961f\u5217\u6c60\uff0c\u4e0e\u6d88\u606f\u6c60\u4e0d\u540c\uff0c\u5176\u7ed3\u6784\u5982\u4e0b"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6d88\u606f\u961f\u5217\u6c60\ntypedef struct st_dtc_msgitem_pool {\n    spinlock_t       lock; ///< \u81ea\u65cb\u9501\n    dtc_msgitem_t   *buffer[MAX_POOL_BUFFER_COUNT]; ///< \u6d88\u606f\u6570\u7ec4\n    uint16           buf_idx; ///< buf\u7d22\u5f15\n    uint16           hwm;\n    dtc_msgqueue_t  free_list; ///< \u7f13\u5b58\u961f\u5217\n} dtc_msgitem_pool_t;\n"})}),"\n",(0,_.jsx)(n.h4,{id:"251-\u521d\u59cb\u5316",children:"2.5.1 \u521d\u59cb\u5316"}),"\n",(0,_.jsx)(n.p,{children:"\u9700\u8981\u521d\u59cb\u5316\u53d1\u9001\u961f\u5217\u4e0a\u4e0b\u6587\u548c\u63a5\u6536\u961f\u5217\u4e0a\u4e0b\u6587\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\ninit_dtc_mq_instance--\x3einit_msgqueue--\x3einit_msgitem_pool--\x3emec_init_message_pool--\x3edtc_init_compress"}),"\n",(0,_.jsx)(n.h4,{id:"252-\u8fd0\u884c",children:"2.5.2 \u8fd0\u884c"}),"\n",(0,_.jsx)(n.p,{children:"\u5f53\u4e0a\u5c42\u5e94\u7528\u4e3b\u52a8\u53d1\u9001\u6d88\u606f\u65f6\uff0c\u6d88\u606f\u4f1a\u653e\u5230\u53d1\u9001\u961f\u5217\u91cc\u3002\u5f53agent\u6267\u884cpipe\u7684recv job\u65f6\uff0c\u6d88\u606f\u4f1a\u653e\u5230\u63a5\u6536\u961f\u5217\u91cc\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6bcf\u4e00\u4e2a\u961f\u5217\u6709\u4e00\u4e2a\u6267\u884c\u7ebf\u7a0b\uff0c\u5728\u521d\u6b21\u5c06\u6d88\u606f\u653e\u5230\u961f\u5217\u91cc\u65f6\u4f1a\u67e5\u770b\u961f\u5217\u5bf9\u5e94\u7684\u6267\u884c\u7ebf\u7a0b\u662f\u5426\u542f\u52a8\uff0c\u6ca1\u6709\u542f\u52a8\u7684\u8bdd\u5c06\u4f1a\u542f\u52a8\u961f\u5217\u7ebf\u7a0b\u3002\u961f\u5217\u7ebf\u7a0b\u7684\u6267\u884c\u51fd\u6570\u662fdtc_task_proc\u3002\u961f\u5217\u7ebf\u7a0b\u7684\u6267\u884c\u548cagent\u7ebf\u7a0b\u6267\u884c\u65b9\u5f0f\u7c7b\u4f3c\uff0c\u4e5f\u662f\u91c7\u7528\u5bf9\u961f\u5217\u52a0\u9501\uff0c\u4fe1\u53f7\u91cf\u901a\u77e5\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u5728\u961f\u5217\u6267\u884c\u7ebf\u7a0b\u4e2d\uff0c\u53c8\u8ddf\u961f\u5217\u662f\u63a5\u6536\u961f\u5217\u8fd8\u662f\u53d1\u9001\u961f\u5217\uff0c\u5206\u522b\u4ea4\u7531\u4e0d\u540c\u7684\u5904\u7406\u51fd\u6570\u8fdb\u884c\u5904\u7406\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\ndtc_task_proc--\x3ecm_event_timedwait--\x3eget_batch_msgitems--\x3e|\u6279\u91cf\u5904\u7406\u53d1\u9001\u6d88\u606f|dtc_send_batch_proc--\x3edtc_send_proc--\x3edtc_send_proc_core--\x3ecs_send_fixed_size--\x3erelease_batch_msgitems\nget_batch_msgitems--\x3e|\u6279\u91cf\u5904\u7406\u63a5\u6536\u6d88\u606f|dtc_proc_batch_recv--\x3edtc_proc_batch--\x3edtc_proc_batch_core--\x3edtc_recv_proc--\x3erelease_batch_msgitems"}),"\n",(0,_.jsx)(n.h5,{id:"2511-\u63a5\u6536\u6d88\u606f\u5165\u961f",children:"2.5.1.1 \u63a5\u6536\u6d88\u606f\u5165\u961f"}),"\n",(0,_.jsx)(n.p,{children:"\u63a5\u6536\u6d88\u606f\u5165\u961f\u662f\u5728pipe\u7684recv job\u4e2d\u5165\u961f\u7684\u3002\u5177\u4f53\u51fd\u6570\u4e3amec_proc_recv_msg\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"mq_context_t *mq_ctx = get_recv_mq_ctx(); ///< \u5148\u627e\u5230\u63a5\u6536\u961f\u5217\u4e0a\u4e0b\u6587\nmessage_pool_t *pool = &mq_ctx->msg_pool[pipe->priv]; ///< \u6839\u636epipe\u7684\u4f18\u5148\u7ea7\u53d6\u51fa\u5bf9\u5e94\u7684\u6d88\u606f\u6c60\uff0c\u540e\u9762\u4f1a\u4ece\u6d88\u606f\u6c60\u5206\u914d\u6d88\u606f\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u5148\u4ecepriavte_pool\u91cc\u5206\u914d\u6d88\u606f\uff0c"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_alloc_msg_item_from_private_pool--\x3e|\u5982\u679cprivate_pool\u6ca1\u6709\u521d\u59cb\u5316\u9700\u8981\u5148\u521d\u59cb\u5316|mec_private_pool_init--\x3e|pool\u521d\u59cb\u5316\u53ea\u662f\u7533\u8bf7\u4e86message_pool_t\u7684\u5185\u5b58,\u4f46\u5176\u5185\u90e8\u7684extents\u5185\u5b58\u8fd8\u6ca1\u6709\u5206\u914d|mec_init_message_pool--\x3emec_alloc_msg_item\nmec_alloc_msg_item_from_private_pool--\x3e|\u4ece\u5df2\u7ecf\u521d\u59cb\u5316\u7684private_pool\u5206\u914d\u4e00\u4e2aitem|mec_alloc_msg_item"}),"\n",(0,_.jsx)(n.p,{children:"mec_alloc_msg_item\u903b\u8f91\u6bd4\u8f83\u590d\u6742\uff0c\u4e0b\u9762\u662f\u5177\u4f53\u7684\u6d41\u7a0b\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'#define MSG_ITEM_SIZE(pool)                \\\n    ((pool)->msg_len + sizeof(msg_item_t)) \\ ///< \u6bcf\u4e00\u4e2apool\u91cc\u7684\u6d88\u606f\u957f\u5ea6\u662f\u76f8\u540c\u7684\uff0c\u5206\u914d\u7684item\u662fitem\u957f\u5ea6\u52a0\u4e0a\u6d88\u606f\u957f\u5ea6\n\nstatus_t mec_alloc_msg_item(message_pool_t *pool, msg_item_t **item)\n{\n    *item = NULL; ///< \u8fd9\u4e2a\u662f\u5916\u90e8\u4f20\u8fdb\u6765\u7684\u4e8c\u7ea7\u6307\u9488\uff0c\u7533\u8bf7\u7684\u5185\u5b58\u8d4b\u503c\u7ed9\u5b83\n    for (;;) {\n        cm_spin_lock(&pool->lock, NULL);\n        if (pool->free_first != CM_INVALID_ID32) { ///< pool\u521d\u59cb\u5316free_first\u4e3aCM_INVALID_ID32\uff0c\u8fd9\u91cc\u8868\u793apool\u521d\u59cb\u72b6\u6001\n            GET_FROM_FREE_LST(pool, *item); ///< \u6709\u7a7a\u95f2\u7684\u76f4\u63a5\u4ecepool\u7684\u7a7a\u95f2\u5217\u8868\u91cc\u7533\u8bf7\n            cm_spin_unlock(&pool->lock);\n            return CM_SUCCESS;\n        }\n        if (pool->count < pool->capacity) { ///< pool\u8fd8\u6ca1\u6709\u6ee1\u4ecepool\u91cc\u76f4\u63a5\u7533\u8bf7\n            ALLOC_FROM_POOL(pool, *item);\n            cm_spin_unlock(&pool->lock);\n            return CM_SUCCESS;\n        }\n        if (pool->extending) { ///< pool\u6b63\u5728\u6269\u5c55\u9700\u8981\u4f11\u7720\u4e00\u4e0b\u7b49\u5f85\u6269\u5c55\u5b8c\n            cm_spin_unlock(&pool->lock);\n            cm_sleep(CM_SLEEP_1_FIXED);\n            continue;\n        }\n        pool->extending = CM_TRUE; ///< \u6269\u5c55\u5f00\u59cb\n        cm_spin_unlock(&pool->lock);\n        if (pool->capacity >= MSG_POOL_MAX_EXTENTS * pool->msg_pool_extent) { /// pool\u7684\u5bb9\u91cf\u5df2\u7ecf\u8d85\u8fc7\u4e86\u6700\u5927\u6269\u5c55\uff0c\u6269\u5c55\u7ed3\u675f\uff0c\u8fd4\u56de\u6210\u529f\n            pool->extending = CM_FALSE;\n            return CM_SUCCESS;\n        }\n        size_t alloc_size = MSG_ITEM_SIZE(pool) * pool->msg_pool_extent; ///< \u5206\u914d\u6269\u5c55\u4e2a\u6570\n        pool->extents[pool->ext_cnt] = malloc(alloc_size); ///< \u6700\u7ec8\u5206\u914d\u7684\u5185\u5b58\u5728extents\u6570\u7ec4\u91cc\uff0c\n                                                           ///< \u6bcf\u4e00\u4e2aextent\u5c31\u662fitem+msg\u6570\u7ec4\uff0c\u6570\u7ec4\u5927\u5c0f\u4e3apool->msg_pool_extent\n        if (pool->extents[pool->ext_cnt] == NULL) { ///< \u5982\u679c\u5185\u5b58\u5206\u914d\u5931\u8d25\uff0c\u8fd4\u56de\u5931\u8d25\n            pool->extending = CM_FALSE;\n            CM_THROW_ERROR(ERR_ALLOC_MEMORY, alloc_size, "message items");\n            return CM_ERROR;\n        }\n        pool->capacity += pool->msg_pool_extent; ///< pool\u7684\u5bb9\u91cf\u589e\u52a0\n        ++pool->ext_cnt;///< \u6269\u5c55extent\n        CM_MFENCE;\n        pool->extending = CM_FALSE;///< \u6269\u5c55\u7ed3\u675f\n        LOG_DEBUG_INF("[MEC]alloc message item with pool extend, alloc_size:%zu ext_cnt:%u msg_pool_extent:%u "\n            "capacity:%u", alloc_size, pool->ext_cnt, pool->msg_pool_extent, pool->capacity);\n    }\n    return CM_SUCCESS;\n}\n'})}),"\n",(0,_.jsx)(n.p,{children:"item\u5206\u914d\u6210\u529f\u540e\uff0c\u4f1a\u628apack attach\u5230item\u7684\u6570\u636e\u5185\u5b58buff\u4e0a,\u6b64\u65f6pack\u5f15\u7528\u4e86buff\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"MEC_MESSAGE_ATTACH(&pack, get_mec_profile(), pipe->priv, item->buffer);\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u7136\u540e\u8c03\u7528mec_read_message\u5c06\u6570\u636e\u8bfb\u5230pack\u91cc\uff0c\u518d\u901a\u8fc7mec_process_message\u5c06pack\u653e\u5165\u961f\u5217\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'status_t mec_process_message(const mec_pipe_t *pipe, mec_message_t *msg) ///< msg\u5c31\u662f\u4e0a\u9762\u4ece\u7f51\u7edcIO\u91cc\u8bfb\u53d6\u51fa\u7684pack\n{\n    dtc_msgqueue_t *my_queue = NULL;\n    mq_context_t *mq_ctx = get_recv_mq_ctx(); ///< \u83b7\u53d6\u53d1\u9001\u961f\u5217\u4e0a\u4e0b\u6587\n    ///< \u6839\u636e\u6536\u5230\u7684\u6d88\u606f\u5934\u91cc\u7684stream_id\u627e\u5230channel id\n    uint32 channel_id = MEC_STREAM_TO_CHANNEL_ID(msg->head->stream_id, get_mec_profile()->channel_num); \n    ///< \u6839\u636echannel id\u548c\u6765\u6e90\u8282\u70b9id\u627e\u5230\u5bf9\u5e94\u7684\u79c1\u6709\u961f\u5217\n    my_queue = &mq_ctx->channel_private_queue[msg->head->src_inst][channel_id];\n    ///< \u4ece\u79c1\u6709\u961f\u5217\u91cc\u5206\u914d\u4e00\u4e2adtc_msgitem_t\uff08\u4e00\u4e2a\u643a\u5e26\u6d88\u606f\u7684\u53cc\u5411\u94fe\u8868\u8282\u70b9\uff09\n    dtc_msgitem_t *msgitem = mec_alloc_msgitem(mq_ctx, my_queue);\n    if (msgitem == NULL) {\n        LOG_DEBUG_ERR("[MEC]alloc message item failed, error code %d.", cm_get_os_error());\n        return CM_ERROR;\n    }\n    ///< dtc_msgitem_t\u7684\u6d88\u606f\u6307\u9488\u6307\u5411msg\u7684buffer\n    msgitem->msg = msg->buffer;\n    uint32 index = 0; ///< \u9ed8\u8ba4\u653e\u5165\u7684\u961f\u5217\u662f0\n    if (pipe->priv == PRIV_LOW) { ///< \u5982\u679c\u662f\u4f4e\u4f18\u5148\u7ea7\uff0c\u5219\u961f\u5217\u7d22\u5f15\u4e3a1\n        index = 1; // avoid concurrent attacks without affecting performance.\n    }\n    CM_MFENCE;\n    put_msgitem(&mq_ctx->queue[index], msgitem); ///< \u5c06\u6d88\u606f\u653e\u5165\u961f\u5217\u91cc\uff08\u6b64\u65f6\u6d88\u606f\u6307\u9488\u5728\u4e24\u4e2a\u5730\u65b9\uff0c\u4e00\u4e2a\u662fprivate_queue,\u53e6\u4e00\u4e2a\u662fqueue\uff09\n\n    if (!mq_ctx->work_thread_idx[index].is_start) {\n        cm_spin_lock(&mq_ctx->work_thread_idx[index].lock, NULL);\n        if (!mq_ctx->work_thread_idx[index].is_start) {\n            if (cm_event_init(&mq_ctx->work_thread_idx[index].event) != CM_SUCCESS) {\n                LOG_RUN_ERR("[MEC]create thread %u event failed, error code %d.", index, cm_get_os_error());\n                cm_spin_unlock(&mq_ctx->work_thread_idx[index].lock);\n                return CM_ERROR;\n            }\n            if (cm_create_thread(dtc_task_proc, 0, (void *)&mq_ctx->work_thread_idx[index],\n                                 &mq_ctx->tasks[index]) != CM_SUCCESS) {\n                LOG_RUN_ERR("[MEC]create work thread %u failed.", index);\n                cm_spin_unlock(&mq_ctx->work_thread_idx[index].lock);\n                return CM_ERROR;\n            }\n            mq_ctx->work_thread_idx[index].is_start = CM_TRUE;\n        }\n        cm_spin_unlock(&mq_ctx->work_thread_idx[index].lock);\n    }\n    cm_event_notify(&mq_ctx->work_thread_idx[index].event); ///< \u901a\u77e5\u961f\u5217\u7ebf\u7a0b\u6709\u65b0\u6d88\u606f\u5230\u6765\n    return CM_SUCCESS;\n}\n'})}),"\n",(0,_.jsx)(n.h5,{id:"2512-\u53d1\u9001\u6d88\u606f\u5165\u961f",children:"2.5.1.2 \u53d1\u9001\u6d88\u606f\u5165\u961f"}),"\n",(0,_.jsx)(n.h4,{id:"253-\u961f\u5217\u6279\u5904\u7406",children:"2.5.3 \u961f\u5217\u6279\u5904\u7406"}),"\n",(0,_.jsx)(n.p,{children:"\u6279\u91cf\u63a5\u6536\u5728\u961f\u5217\u7ebf\u7a0b\u7684\u5904\u7406\u51fd\u6570\u4e2d\uff0c\u63a5\u6536\u65f6\u9700\u8981\u5148\u627e\u5230\u5bf9\u5e94\u7684\u961f\u5217\uff0c"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"uint32 queue_idx = arg->index % (DTC_MSG_QUEUE_NUM + 1); ///< \u961f\u5217\u7684\u7d22\u5f15\u6839\u636e\u653e\u5165\u65f6\u7684\u7d22\u5f15\u5bf9\u961f\u5217\u4e2a\u6570\u52a01\u53d6\u4f59\uff0c\u5b9e\u9645\u53d6\u51fa\u7684\u8fd8\u662f\u521b\u5efa\u961f\u5217\u7ebf\u7a0b\u65f6\u5bf9\u5e94\u7684\u961f\u5217\uff0c\u907f\u514d\u53d6\u51fa\u975e\u6cd5\u7d22\u5f15\u961f\u5217\nget_batch_msgitems(queue, &batch_queue, mq_ctx->profile->batch_size);\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6279\u91cf\u53d6\u51fa\u7684\u903b\u8f91\u5982\u4e0b\uff1a"}),"\n",(0,_.jsxs)(n.ol,{children:["\n",(0,_.jsx)(n.li,{children:"\u9996\u5148\u4e0a\u5c42\u53ef\u4ee5\u914d\u7f6e\u6279\u91cf\u5904\u7406\u7684\u6d88\u606f\u6570\u91cf\uff1b"}),"\n",(0,_.jsx)(n.li,{children:"\u7136\u540e\u4f1a\u6bd4\u8f83\u6279\u5904\u7406\u6570\u91cf\u548c\u961f\u5217\u6d88\u606f\u6570\u91cf\u7684\u5927\u5c0f\uff0c\u82e5\u961f\u5217\u6d88\u606f\u6570\u91cf\u8f83\u591a\uff0c\u5219\u53d6\u51fa\u6279\u5904\u7406\u6570\u91cf\u7684\u6d88\u606f\uff0c\u82e5\u961f\u5217\u6d88\u606f\u6570\u91cf\u4e0d\u8db3\uff0c\u5219\u5c06\u961f\u5217\u6d88\u606f\u5168\u90e8\u53d6\u51fa\uff1b"}),"\n",(0,_.jsx)(n.li,{children:"\u961f\u5217\u91c7\u7528\u53cc\u5411\u94fe\u8868\u5b9e\u73b0\uff0c\u5e76\u4e14\u8bb0\u5f55\u4e0b\u4e86\u961f\u5217\u7684\u5934\u5c3e\u6307\u9488\uff0c\u6279\u91cf\u51fa\u961f\u4e3b\u8981\u5c31\u662f\u66f4\u65b0\u5934\u5c3e\u6307\u9488\uff0c\u4ee5\u53ca\u5934\u5c3e\u6307\u9488\u7684\u53cc\u5411\u6307\u9488\uff1b"}),"\n",(0,_.jsx)(n.li,{children:"\u6700\u7ec8\u51fa\u961f\u7684\u6570\u636e\u4e5f\u662f\u4e00\u4e2a\u961f\u5217\uff1b"}),"\n"]}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6279\u91cf\u6d88\u606f\u51fa\u961f\n/// @param queue \u6d88\u606f\u961f\u5217\n/// @param batch \u6d88\u606f\u51fa\u961f\u5b58\u653e\u5730\u5740\n/// @param batch_size \u51fa\u961f\u6d88\u606f\u6570\u91cf\nvoid get_batch_msgitems(dtc_msgqueue_t *queue, dtc_msgqueue_t *batch, uint32 batch_size)\n{\n    if (queue->count == 0) {\n        return;\n    }\n\n    cm_spin_lock(&queue->lock, NULL); // \u8bbf\u95ee\u524d\u5148\u52a0\u9501\n    if (queue->count == 0) {\n        cm_spin_unlock(&queue->lock);\n        return;\n    }\n    uint32 size = MIN(batch_size, queue->count); // \u53d6\u51fa\u961f\u6570\u548c\u961f\u5217\u5b9e\u9645\u6570\u91cf\u7684\u5c0f\u503c\u51fa\u961f\n    batch->first = queue->first; // \u5c06\u961f\u5934\u6307\u9488\u8d4b\u7ed9bacth\u7684\u961f\u5934\n    for (uint32 loop = 0; loop < size - 1; loop++) {\n        CM_ASSERT(queue->first->msg != NULL);\n        queue->first = queue->first->next;\n    } // \u5c06\u961f\u5934\u6307\u9488\u5f80\u540e\u79fbsize\u4e2a\u4f4d\u7f6e\n\n    batch->last = queue->first; // \u6b64\u65f6\u961f\u5934\u6307\u9488\u5df2\u7ecf\u8fbe\u5230\u8981\u51fa\u961f\u7684\u4f4d\u7f6e\uff0c\u5c06\u961f\u5934\u8d4b\u503c\u7ed9batch\u7684\u961f\u5c3e\n    queue->first = queue->first->next; // \u518d\u8bb2\u961f\u5934\u5f80\u540e\u79fb\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u56e0\u4e3a\u4e4b\u524d\u7684\u961f\u5934\u8981\u51fa\u961f\n    if (queue->first != NULL) {  // \u82e5\u961f\u5934\u4e0d\u4e3anull\uff0c\u6b64\u65f6\u961f\u5934\u524d\u5e94\u8be5\u6ca1\u6709\u6570\u636e\uff0c\u8bbe\u7f6e\u961f\u5934\u7684prev\u4e3anull\n        queue->first->prev = NULL;\n    }\n    batch->last->next = NULL; // batch\u6240\u6709\u6570\u636e\u5df2\u53d6\u51fa\uff0c\u6b64\u65f6\u961f\u5c3e\u540e\u9762\u5e94\u8be5\u6ca1\u6709\u6570\u636e\uff0c\u8bbe\u7f6e\u961f\u5c3e\u7684next\u4e3anull\n    batch->count = size; // batch\u7684\u5927\u5c0f\u4e3asize\n\n    queue->count -= size; // \u66f4\u65b0\u539f\u961f\u5217\u5927\u5c0f\n    if (queue->count == 0) { // \u82e5\u961f\u5217\u4e3a\u7a7a\uff0c\u91cd\u7f6e\u961f\u5934\u961f\u5c3e\n        queue->last = NULL;\n        queue->first = NULL;\n    }\n\n    cm_spin_unlock(&queue->lock);\n    return;\n}\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6279\u91cf\u53d6\u51fa\u7684\u6d88\u606f\u53ea\u662f\u961f\u5217\u7684\u6307\u9488\uff0c\u5e76\u6ca1\u6709\u89e3\u6790\u5177\u4f53\u7684\u6d88\u606f\u3002\u5177\u4f53\u5904\u7406\u51fd\u6570\u4e3adtc_proc_batch_recv\uff0c"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"    dtc_msgitem_t *msg_item = batch_queue->first; ///< \u4ece\u94fe\u8868\u5934\u8282\u70b9\u5f00\u59cb\u8fdb\u884c\u5904\u7406\n    mec_message_head_t *head = NULL;\n    while (msg_item != NULL) { ///< \u5faa\u73af\u5904\u7406\u6bcf\u4e00\u4e2a\u8282\u70b9\n        head = (mec_message_head_t *)msg_item->msg; ///< \u5c06\u6570\u636e\u6307\u9488\u8f6c\u6362\u4e3a\u6d88\u606f\u6307\u9488\n        if (dtc_proc_batch(arg, head) != CM_SUCCESS) {\n            return;\n        }\n        mec_release_message_buf(msg_item->msg); ///< \u6bcf\u5904\u7406\u5b8c\u4e00\u4e2a\u94fe\u8868\u8282\u70b9\uff0c\u90fd\u5c06\u5176buf\u91ca\u653e\u6389\n        msg_item->msg = NULL;\n        msg_item = msg_item->next;\n    }\n"})}),"\n",(0,_.jsx)(n.p,{children:"mec_message_head_t\u6d88\u606f\u5934\u4e2d\u643a\u5e26\u4e86\u6279\u91cf\u6570\u636e\u7684\u4e2a\u6570\uff0c\u5148\u67e5\u770b\u6d88\u606f\u662f\u5426\u662f\u591a\u6761\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'    int32 batch_size = head->batch_size; ///< \u53d6\u51fa\u6d88\u606f\u603b\u6761\u6570\n    uint32 remain_size = (uint32)(head->size - sizeof(mec_message_head_t)); ///< \u5269\u4f59\u6d88\u606f\u6761\u6570\n    CM_ASSERT(batch_size > 1); ///< \u6279\u5904\u7406\u6d88\u606f\u81f3\u5c112\u6761\n\n    msg_priv_t head_priv = CS_PRIV_LOW(head->flags) ? PRIV_LOW : PRIV_HIGH; ///< \u6d88\u606f\u7684\u4f18\u5148\u7ea7\n    mec_message_head_t *temp_head = head + 1; ///< \u4e0b\u4e00\u6761\u6d88\u606f\n    while (batch_size > 0) { ///< \u904d\u5386\u6d88\u606f\u76f4\u5230\u6d88\u606f\u5904\u7406\u5b8c\n        CM_ASSERT(!CS_COMPRESS(temp_head->flags));\n        msg_priv_t cur_priv = CS_PRIV_LOW(temp_head->flags) ? PRIV_LOW : PRIV_HIGH; ///< \u83b7\u53d6\u5f53\u524d\u6d88\u606f\u7684\u4f18\u5148\u7ea7\n        if (cur_priv != head_priv || remain_size < temp_head->size ///< \u5269\u4f59\u6d88\u606f\u5927\u5c0f\u5e94\u5927\u4e8e\u5f53\u524d\u8282\u70b9\u6d88\u606f\u5927\u5c0f\n            || remain_size < (uint32)sizeof(mec_message_head_t)) { ///< \u5f53\u524d\u6d88\u606f\u7684\u4f18\u5148\u7ea7\u5e94\u8be5\u4e0e\u5934\u8282\u70b9\u76f8\u540c\n            ///< \u5269\u4f59\u6d88\u606f\u5e94\u5927\u4e8emec_message_head_t\u957f\u5ea6\n            LOG_DEBUG_ERR("[MEC]batchc err: cur_priv %u, head_priv %u, cur_size %u, remain_size %u, src %u",\n                cur_priv, head_priv, temp_head->size, remain_size, head->src_inst);\n            return CM_ERROR;\n        }\n        dtc_recv_proc(mec_ctx, fragment_ctx, temp_head);\n        temp_head = (mec_message_head_t *)((char *)temp_head + temp_head->size); ///< \u79fb\u52a8\u6307\u9488\n        batch_size--;\n        remain_size -= temp_head->size;\n    }\n'})}),"\n",(0,_.jsx)(n.p,{children:"\u6bcf\u6b21\u5904\u7406\u6d88\u606f\u9700\u8981\u6839\u636e\u63a7\u5236\u6d88\u606f\u67e5\u770b\u662f\u5426\u9700\u8981\u5408\u5e76\u5305\uff0c"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'    mec_message_t pack;\n    ///< \u68c0\u67e5\u6765\u6e90\u8282\u70b9\u548c\u6d41\u662f\u5426\u5b58\u5728\n    if (md_check_stream_node_exist(head->stream_id, head->src_inst) != CM_SUCCESS) {\n        LOG_DEBUG_ERR("[MEC]eachhead: invalid stream_id %u or src_inst %u", head->stream_id, head->src_inst);\n        return;\n    }\n    ///< \u68c0\u67e5\u6d88\u606f\u662f\u5426\u53d1\u5f80\u672c\u8282\u70b9\n    if (SECUREC_UNLIKELY(head->dst_inst != md_get_cur_node())) {\n        LOG_DEBUG_ERR("[MEC]eachhead: dst_inst %u is not me.", head->dst_inst);\n        return;\n    }\n    ///< \u68c0\u67e5\u6d88\u606fcmd\u662f\u5426\u5408\u6cd5\n    if (SECUREC_UNLIKELY(head->cmd >= MEC_CMD_CEIL)) {\n        LOG_DEBUG_ERR("[MEC]invalid mec command %u", head->cmd);\n        return;\n    }\n    ///< \u83b7\u53d6\u5bf9\u5e94cmd\u7684process\u51fd\u6570\u8fdb\u884c\u5904\u7406\n    msg_proc_t proc = mec_ctx->cb_processer[head->cmd].proc;\n    if (SECUREC_UNLIKELY(proc == NULL)) {\n        LOG_DEBUG_ERR("[MEC]no message handling function is registered for message type %u", head->cmd);\n        return;\n    }\n    head->time2 = g_timer()->now;\n    g_mec_perf_stat.recv_count++;\n    g_mec_perf_stat.recv_delay += head->time2 - head->time1;\n    stat_record(RECV_DELAY, head->time2 - head->time1);\n    ///< \u6839\u636e\u6d88\u606f\u5934\u7684\u63a7\u5236\u4f4d\u533a\u5206\u662f\u5426\u8fd8\u6709\u66f4\u591a\u6d88\u606f\n    if (CS_MORE_DATA(head->flags)) {\n        dtc_proc_more_data(fragment_ctx, head); ///< \u5904\u7406\u5206\u7247\n    } else if (CS_END_DATA(head->flags)) { ///< \u5904\u7406\u6700\u540e\u4e00\u4e2a\u5305\n        dtc_proc_end_data(mec_ctx, proc, fragment_ctx, head); ///< \u5206\u7247\u7ed3\u675f\uff0c\u5408\u5305\n    } else {\n        MEC_MESSAGE_ATTACH2(&pack, (char *)head);\n        mec_init_get(&pack);\n        ///< \u5904\u7406\u6d88\u606f\n        if (proc(&pack) != CM_SUCCESS) {\n            int32 code = 0;\n            const char *message = NULL;\n            cm_get_error(&code, &message);\n            LOG_DEBUG_WAR("[MEC]proc message failed,src[%d],dst[%d],cmd[%u],stream id[%u],err code %d, err msg %s",\n                head->src_inst, head->dst_inst, head->cmd, head->stream_id, code, code == 0 ? "N/A" : message);\n        }\n    }\n'})}),"\n",(0,_.jsx)(n.p,{children:"\u5904\u7406\u5206\u7247\u65f6\uff0c\u5206\u7247\u4f7f\u7528hash\u6765\u4fdd\u5b58\uff0c\u4f7f\u7528\u8282\u70b9id\uff0c\u6d41id\u548c\u5e8f\u5217\u53f7\u6765\u8ba1\u7b97hash\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'    fragment_key_t key;\n    FILL_FRAGMENT_KEY(head, key); ///< \u521d\u59cb\u5316key\n    uint32 hash_key = cm_hash_bytes((const uint8 *)&key, sizeof(fragment_key_t), FRAGMENT_BUCKETS); ///< \u8ba1\u7b97hash\u503c\n    fragment_bucket_t *bucket = &fragment_ctx->buckets[hash_key];\n    fragment_ctrl_t *ctrl = NULL;\n    uint32 del_sn;\n\n    ctrl = find_fragment_ctrl(bucket, &key);\n    if (head->frag_no == 0) { ///< \u5982\u679c\u662f\u7b2c\u4e00\u4e2a\u62a5\u6587\u76f4\u63a5\u63d2\u5165\u5206\u7247\u91cc\n        if (insert_fragment_pack(head, bucket) != CM_SUCCESS) {\n            LOG_DEBUG_WAR("[MEC]first_frag insert fail. src inst[%d], frag_no[%u], serial no[%u], batch size[%u], "\n                          "err code %d, err msg %s",\n                          head->src_inst, head->frag_no, head->serial_no, head->batch_size,\n                          cm_get_error_code(), cm_get_errormsg(cm_get_error_code()));\n            return;\n        }\n    } else { ///< \u4e0d\u662f\u7b2c\u4e00\u4e2a\u62a5\u6587\u5219\u9700\u8981\u8fdb\u884c\u5408\u5305\n        if (concat_fragment_pack(ctrl, head) != CM_SUCCESS) {\n            LOG_DEBUG_WAR("[MEC]non_first_frag concat fail. src inst[%d], frag_no[%u], serial no[%u], batch size[%u], "\n                          "err code %d, err msg %s",\n                          head->src_inst, head->frag_no, head->serial_no, head->batch_size,\n                          cm_get_error_code(), cm_get_errormsg(cm_get_error_code()));\n            goto error;\n        }\n        cm_spin_unlock(&ctrl->lock);\n    }\n'})}),"\n",(0,_.jsx)(n.h3,{id:"26-reactor",children:"2.6 reactor"}),"\n",(0,_.jsx)(n.p,{children:"mec\u603b\u5171\u6709\u4e24\u4e2areactor\uff0c\u4e00\u4e2a\u662f\u9ad8\u4f18\u5148\u7ea7\uff0c\u4e00\u4e2a\u662f\u4f4e\u4f18\u5148\u7ea7\u3002\u4e0e\u4e4b\u76f8\u5bf9\u5e94\uff0cagent\u4e5f\u6709\u4e24\u4e2a\uff0c\u9ad8\u4f18\u5148\u7ea7\u548c\u4f4e\u4f18\u5148\u7ea7\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6bcf\u4e00\u4e2areactor\u662f\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u8d1f\u8d23\u76d1\u542cchannel\u7684pipe\u662f\u5426\u6709\u4e8b\u4ef6\u5230\u6765\u3002\u53ef\u4ee5\u901a\u8fc7MEC_REACTOR_THREAD_NUM\u6765\u914d\u7f6ereactor\u7ebf\u7a0b\u4e2a\u6570\u3002"}),"\n",(0,_.jsx)(n.p,{children:"reactor\u7ebf\u7a0b\u4e0eagent\u7ebf\u7a0b\u4e0d\u540c\uff0creactor\u7ebf\u7a0b\u662f\u4e00\u5f00\u59cb\u5c31\u5168\u90e8\u521b\u5efa\u597d\u4e86\uff0c\u4e0d\u4f1a\u6309\u9700\u521b\u5efa\uff0creactor\u7ebf\u7a0b\u4e5f\u4e0d\u662f\u7ebf\u7a0b\u6c60\u7684\u6a21\u5f0f\uff0c\u6bcf\u4e2areactor\u7ebf\u7a0b\u5c31\u662f\u660e\u786e\u505a\u4e00\u4ef6\u4e8b\uff0c\u76d1\u542csocket\u662f\u5426\u6709\u4e8b\u4ef6\u5c31\u7eea\u5e76\u4ea4\u7ed9agent\u53bb\u5904\u7406\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6bcf\u4e00\u4e2achannel\u6709\u4e24\u4e2apipe\uff0c\u4e00\u4e2a\u9ad8\u4f18\u5148\u7ea7\uff0c\u4e00\u4e2a\u4f4e\u4f18\u5148\u7ea7\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \ntypedef struct st_reactor {\n    uint32 id;\n    thread_t thread; ///< reactor \u7ebf\u7a0bid\n    int epollfd;     ///< epoll id\n    atomic32_t channel_count; ///< \u901a\u9053\u6570\n    uint32 avg_oagents;\n    reactor_status_t status; ///< \u72b6\u6001\n    agent_pool_t  *agent_pool; ///< \u4ee3\u7406\u6c60\n} reactor_t;\n"})}),"\n",(0,_.jsx)(n.p,{children:"reactor\u521d\u59cb\u5316\u65f6\uff0c\u521b\u5efa\u4e00\u4e2areactor\u5c31\u662f\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u6bcf\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c\u7684\u662f\u4e00\u4e2a\u5faa\u73af\uff0c\u7528epoll_wait\u76d1\u542c\u662f\u5426\u6709socket\u51c6\u5907\u5c31\u7eea\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'    while (!thread->closed) {\n        reactor_handle_events(reactor); \n        if (reactor->status == REACTOR_STATUS_PAUSING) {\n            reactor->status = REACTOR_STATUS_PAUSED;\n        }\n    }\n\n    nfds = epoll_wait(reactor->epollfd, events, EV_WAIT_NUM, EV_WAIT_TIMEOUT);\n    if (nfds == -1) {\n        if (errno != EINTR) {\n            LOG_RUN_ERR("[MEC]Failed to wait for connection request, OS error:%d", cm_get_os_error());\n        }\n        return;\n    }\n    if (nfds == 0) {\n        return;\n    }\n\n    for (loop = 0; loop < nfds; ++loop) {\n        /*\u5904\u7406\u5c31\u7eea\u7684socket */\n    }\n'})}),"\n",(0,_.jsx)(n.p,{children:"\u6bcf\u5c31\u7eea\u4e00\u4e2asocket\uff0c\u8fd9\u91cc\u5176\u5b9e\u5c31\u662fpipe\uff0c\u5c31\u4f1a\u5c06\u5176\u653e\u5230\u4e00\u4e2aagent\u91cc\u53bb\u6267\u884c\u3002"}),"\n",(0,_.jsx)(n.h4,{id:"261-\u6dfb\u52a0pipe",children:"2.6.1 \u6dfb\u52a0pipe"}),"\n",(0,_.jsx)(n.p,{children:"acceptor\u6bcf\u63a5\u6536\u5230\u4e00\u4e2a\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\uff0c\u5c31\u4f1a\u521b\u5efa\u4e00\u4e2apipe\uff0c\u5e76\u5c06\u8fd9\u4e2apipe\u6dfb\u52a0\u5230\u4e00\u4e2areactor\u7684\u76d1\u542c\u5217\u8868\u91cc\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_tcp_accept--\x3emec_accept--\x3emec_init_pipe--\x3ereactor_register_pipe--\x3ereactor_add_epoll_pipe"}),"\n",(0,_.jsx)(n.h4,{id:"262-\u6267\u884cpipe",children:"2.6.2 \u6267\u884cpipe"}),"\n",(0,_.jsx)(n.p,{children:"reactor\u7ebf\u7a0b\u4f1a\u76d1\u542c\u6dfb\u52a0\u8fdb\u6765\u7684pipe\uff0c\u5e76\u628a\u6709\u4e8b\u4ef6\u5230\u6765\u7684\u53d6\u51fa\u9644\u7740\u5230agent\u4e2d\u8fd0\u884c\u3002\u9644\u7740\u5230agent\u540e\uff0creactor\u4f1a\u8c03\u7528cm_event_notify\u5411agent\u53d1\u9001\u4fe1\u53f7\u91cf\uff0c\u6fc0\u6d3b\u4e00\u4e2aagent\u7ebf\u7a0b\u6765\u5904\u7406pipe\u7684job\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nreactor_create_pool--\x3ereactor_start_pool--\x3ereactor_start--\x3ereactor_work--\x3ereactor_entry--\x3ereactor_handle_events--\x3ereactor_wait4events--\x3eattach_agent--\x3etry_attach_agent"}),"\n",(0,_.jsx)(n.h2,{id:"3-protocol",children:"3. protocol"}),"\n",(0,_.jsx)(n.p,{children:"\u534f\u8bae\u5c42\u4e3b\u8981\u5305\u542btcp\u548cssl\u7684\u76f8\u5173\u6536\u53d1\u5305\u5b9e\u73b0\u4ee5\u53ca\u670d\u52a1\u7aef\u76d1\u542c\u5b9e\u73b0\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u5b9e\u9645\u6536\u53d1\u5305\u51fd\u6570"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"typedef struct st_vio {\n    recv_func_t vio_recv;\n    send_func_t vio_send;\n    wait_func_t vio_wait;\n    recv_timed_func_t vio_recv_timed;\n    send_timed_func_t vio_send_timed;\n} vio_t;\n\n\nstatic const vio_t g_vio_list[] = {\n    { NULL, NULL, NULL, NULL, NULL },\n\n    // TCP io functions\n    { (recv_func_t)cs_tcp_recv, (send_func_t)cs_tcp_send, (wait_func_t)cs_tcp_wait,\n      (recv_timed_func_t)cs_tcp_recv_timed, (send_timed_func_t)cs_tcp_send_timed },\n\n    // SSL io functions\n    { (recv_func_t)cs_ssl_recv, (send_func_t)cs_ssl_send, (wait_func_t)cs_ssl_wait,\n      (recv_timed_func_t)cs_ssl_recv_timed, (send_timed_func_t)cs_ssl_send_timed },\n};\n"})}),"\n",(0,_.jsx)(n.h3,{id:"31-listener",children:"3.1 listener"}),"\n",(0,_.jsx)(n.p,{children:"listener\u4e3b\u8981\u8d1f\u8d23\u76d1\u542csocket\u5e76accept\uff0caccept\u5305\u62ec\u7cfb\u7edf\u8c03\u7528accept(\u5373tcp\u4e09\u6b21\u63e1\u624b)\uff0c\u53c8\u5305\u542b\u5e94\u7528\u5c42accept\uff08pipe\u8fde\u63a5\uff09\u3002"}),"\n",(0,_.jsx)(n.h4,{id:"311-\u7cfb\u7edf\u8c03\u7528accept",children:"3.1.1 \u7cfb\u7edf\u8c03\u7528accept"}),"\n",(0,_.jsx)(n.p,{children:"mec\u91c7\u7528reactor\u6a21\u5f0f\u5b9e\u73b0\uff0clistener\u4e3b\u8981\u662f\u5b9e\u73b0acceptor\u7684\u529f\u80fd\uff0c\u8d1f\u8d23\u76d1\u542csocket\uff0c\u5e76\u63a5\u53d7\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u3002\u63a5\u53d7\u8fde\u63a5\u540e\u521b\u5efapipe\uff0c\u5e76\u5c06\u5176\u6dfb\u52a0\u5230reactor\u4e2d\uff0c\u7531reactor\u8d1f\u8d23\u540e\u7eed\u7684\u8bfb\u5199\u4e8b\u4ef6\u76d1\u542c\u3002listener\u5b9e\u9645\u4e0a\u4e5f\u662f\u4e00\u4e2aepoll_wait\u7684\u5faa\u73af\uff0c\u4f46\u5176\u53ea\u63d0\u4f9b\u76d1\u542c\u63a5\u53d7\u8fde\u63a5\u7684\u529f\u80fd\uff0c\u5373accept\u7cfb\u7edf\u8c03\u7528\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_start_lsnr--\x3ecs_start_tcp_lsnr--\x3e|\u521b\u5efa\u76d1\u542csocket,\u8bbe\u7f6esocket\u53c2\u6570|cs_create_lsnr_socks--\x3e|\u5982\u679c\u6709\u591a\u4e2a\u5730\u5740\u7684\u8bdd\u4f1a\u521b\u5efa\u591a\u4e2asocket|cs_create_one_lsnr_sock\ncs_start_tcp_lsnr--\x3e|\u5c06\u521b\u5efa\u7684socket\u6dfb\u52a0\u5230epoll\u76d1\u542c\u91cc|cs_lsnr_init_epoll_fd--\x3e|\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u6765\u63a5\u53d7\u6765\u81ea\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u8bf7\u6c42|cm_create_thread"}),"\n",(0,_.jsx)(n.p,{children:"\u521b\u5efa\u5b8csocket\u540e\u4f1a\u542f\u52a8\u4e00\u4e2a\u7ebf\u7a0b\u6765\u5904\u7406\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u8bf7\u6c42\uff0c\u5904\u7406\u51fd\u6570\u4e3asrv_tcp_lsnr_proc\u3002\u8be5\u51fd\u6570\u662f\u4e00\u4e2aepoll_wait\u7684\u5faa\u73af\uff0c\u4f1a\u76d1\u542c\u5bf9\u5e94\u7684socket\u4e8b\u4ef6\u5e76\u8fdb\u884c\u5904\u7406\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nsrv_tcp_lsnr_proc--\x3ecs_try_tcp_accept--\x3eepoll_wait--\x3e|\u6709\u5ba2\u6237\u7aef\u8fde\u63a5\u8bf7\u6c42\u5230\u6765|cs_create_tcp_link--\x3eaccept--\x3ecs_check_link_ip--\x3e|\u8fd9\u91cc\u4f1a\u8bbe\u7f6esocket\u4e3a\u975e\u963b\u585e\u975e\u5ef6\u65f6|cs_set_io_mode\ncs_create_tcp_link--\x3e|accept\u5b8c\u6210\u540e,\u6267\u884c\u4e0a\u5c42accept\u56de\u8c03\u5e76\u5c06pipe\u52a0\u5165\u5230reactor|mec_tcp_accept"}),"\n",(0,_.jsx)(n.p,{children:"\u521b\u5efa\u76d1\u542c\u540e\uff0caccept\u5b8c\u6210\u540e\u4f1a\u5c06mec_tcp_accept\u4fdd\u5b58\u5728tcp_lsnr_t\u7684action\u91cc\uff0c\u4f1a\u5728\u521b\u5efapipe\u65f6\u8c03\u7528\u3002\u5728acceptor\u7684\u6267\u884c\u7ebf\u7a0b\u91cc\u5b8c\u6210accept\u540e\uff0c\u4f1a\u6267\u884caction\u5e76\u5c06pipe\u653e\u5165reactor\u4e2d\u3002"}),"\n",(0,_.jsx)(n.h4,{id:"312-\u5e94\u7528\u5c42accept",children:"3.1.2 \u5e94\u7528\u5c42accept"}),"\n",(0,_.jsx)(n.p,{children:"tcp\u8fde\u63a5\u5efa\u7acb\u540e\uff0c\u5ba2\u6237\u7aef\uff08\u4e3b\u52a8\u5efa\u8fde\u63a5\u7684\u4e00\u65b9\uff09\u4f1a\u7acb\u5373\u53d1\u9001proto_code\uff0cacceptor\u9700\u8981\u6821\u9a8c\u534f\u8bae\u7801\u662f\u5426\u6b63\u786e\uff0c\u786e\u8ba4\u534f\u8bae\u7801\u540e\u9700\u8981\u53d1\u9001link_ready_ack_t\u56de\u590d\u5bf9\u7aef\u8fde\u63a5\u51c6\u5907\u5c31\u7eea\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u6536\u5230link_ready_ack_t\u540e\uff0c\u63a5\u7740\u4f1a\u53d1\u9001mec_message_head_t\uff0c\u53d1\u9001\u8fde\u63a5\u8bf7\u6c42\u3002"}),"\n",(0,_.jsx)(n.p,{children:"acceptor\u7aef\u6536\u5230mec_message_head_t\uff0c\u4f1a\u6821\u9a8c\u8fde\u63a5\u6d88\u606f\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u9700\u8981\u6ce8\u610f\u7684\u662f\u6b64\u65f6\u7684\u6d88\u606f\u6536\u53d1\u5904\u7406\u8fd8\u6ca1\u6709\u8f6c\u4ea4\u5230reactor\u5904\u7406\u3002"}),"\n",(0,_.jsx)(n.p,{children:"mec_message_head_t\u6d88\u606f\u91cc\u4f1a\u643a\u5e26src_inst\u548cstream_id\uff0c\u5206\u522b\u8868\u793a\u6765\u6e90\u5b9e\u4f8bid\u548c\u6d41id\uff0c\u5bf9\u5e94\u5230\u672c\u7aef\u5176\u5b9e\u5c31\u662f\u8282\u70b9id\u548cchannel id\uff0c\u6839\u636e\u8fd9\u4e24\u4e2a\u53c2\u6570\u5c31\u53ef\u4ee5\u552f\u4e00\u786e\u5b9a\u4e00\u4e2achannel\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u5e76\u8ddf\u636emec_message_head_t\u6d88\u606f\u91cc\u7684flags\u786e\u5b9a\u662f\u9ad8\u4f18\u5148\u7ea7pipe\u8fd8\u662f\u4f4e\u4f18\u5148\u7ea7\uff0c\u7136\u540e\u627e\u5230pipe\uff0c\u6700\u7ec8\u9700\u8981\u628apipe\u4ea4\u7ed9reactor\u53bb\u5904\u7406\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"channel = &mec_ctx->channels[head.src_inst][head.stream_id]; ///< \u627e\u5230\u4e00\u4e2achannel\nmsg_priv_t priv = CS_PRIV_LOW(head.flags) ? PRIV_LOW : PRIV_HIGH; ///< \u6839\u636eflags\u786e\u5b9a\u662f\u9ad8\u4f18\u5148\u7ea7pipe\u8fd8\u662f\u4f4e\u4f18\u5148\u7ea7\nmec_pipe_t *mec_pipe = &channel->pipe[priv]; ///< \u627e\u5230pipe\n"})}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_tcp_accept--\x3emc_accept--\x3emec_init_pipe--\x3e|\u8bfb\u53d6proto_code\u9a8c\u8bc1\u534f\u8bae\u7801\u662f\u5426\u6b63\u786e|cs_read_bytes--\x3e|\u7136\u540e\u53d1\u9001link_ready_ack_t\u7ed9\u5bf9\u7aef|cs_send_bytes\nmec_init_pipe--\x3e|\u7b49\u5f85socket\u4e8b\u4ef6\u5230\u6765|cs_wait--\x3ecs_read_fixed_size--\x3e|\u68c0\u67e5\u8fde\u63a5\u4fe1\u606f\u662f\u5426\u6b63\u786e|check_connect_head_info--\x3e|\u5c06pipe\u4ea4\u7ed9reactor\u53bb\u7ba1\u7406,\u6b64\u65f6acceptor\u5b8c\u6210|reactor_register_pipe--\x3ereactor_add_epoll_pipe"}),"\n",(0,_.jsx)(n.h3,{id:"32-packet",children:"3.2 packet"}),"\n",(0,_.jsx)(n.p,{children:"packet\u4e3b\u8981\u662f\u5b9e\u73b0\u4e86\u5927\u5c0f\u7aef\u8f6c\u6362\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"33-ssl",children:"3.3 ssl"}),"\n",(0,_.jsx)(n.p,{children:"ssl\u4e3b\u8981\u662f\u4f7f\u7528openssl\u52a0\u5bc6tcp\u901a\u4fe1\u6570\u636e\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"34-pipe",children:"3.4 pipe"}),"\n",(0,_.jsx)(n.p,{children:"\u96c6\u7fa4\u8282\u70b9\u4e4b\u95f4\u5b9e\u9645\u662f\u901a\u8fc7channel\u901a\u4fe1\uff0c\u800cchannel\u53c8\u662f\u901a\u8fc7pipe\u6765\u901a\u4fe1\uff0c\u8fd9\u91cc\u7684pipe\u6307\u7684\u662fmec_pipe_t\u3002\u5728\u96c6\u7fa4\u4e2d\u4e24\u4e2a\u8282\u70b9\u4e4b\u95f4\u5b9e\u9645\u662f\u6709\u4e24\u6761\u901a\u4fe1\u94fe\u8def\u7684\uff0c\u6bcf\u4e2a\u8282\u70b9\u90fd\u662f\u65e2\u4f5c\u4e3a\u5ba2\u6237\u7aef\uff0c\u4e5f\u4f5c\u4e3a\u670d\u52a1\u7aef\u3002"}),"\n",(0,_.jsx)(n.p,{children:"pipe\u662fchannel\u5177\u4f53\u7684\u901a\u4fe1\u5355\u5143\uff0c\u4e5f\u662f\u901a\u4fe1\u7684\u6700\u5c0f\u6a21\u5757\uff0c\u5b9e\u9645\u5404\u4e2a\u5b9e\u4f8b\uff08\u8282\u70b9\uff09\u4e4b\u95f4\u5c31\u662f\u901a\u8fc7pipe\u6765\u901a\u4fe1\u3002pipe\u7684job\uff08\u884c\u4e3a\uff09\u4e3b\u8981\u5206\u4e3a\u4e24\u7c7b\uff0cSEND_MODE\u548cRECV_MODE\u3002"}),"\n",(0,_.jsx)(n.p,{children:"pipe\u5728\u5176\u5185\u90e8\u53c8\u5212\u5206\u4e3a\u4e24\u7c7b\uff0csend_pipe\u548crecv_pipe\uff0csend_pipe\u7528\u4e8e\u5ba2\u6237\u7aef\uff0c\u7528\u4e8e\u4e3b\u52a8\u8fde\u63a5\uff0crecv_pipe\u7528\u4e8e\u670d\u52a1\u7aef\uff0c\u7528\u4e8e\u63a5\u53d7\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief mec\u7ba1\u9053\ntypedef struct st_mec_pipe {\n    thread_lock_t send_lock; ///< \u53d1\u9001\u9501\n    thread_lock_t recv_lock; ///< \u63a5\u6536\u9501\n    thread_lock_t recv_epoll_lock;\n    struct {\n        volatile uint16 is_reg : 1; ///< \u662f\u5426\u6ce8\u518c\n        volatile uint16 recv_pipe_active : 1; ///< \u63a5\u6536pipe\u662f\u5426\u6fc0\u6d3b\n        volatile uint16 send_pipe_active : 1; ///< \u53d1\u9001pipe\u662f\u5426\u6fc0\u6d3b\n        uint16 priv : 1;\n        volatile uint16 try_connet_count : 12;\n    };\n    cs_pipe_t          send_pipe; ///< \u53d1\u9001\u8fde\u63a5\u901a\u9053\n    cs_pipe_t          recv_pipe; ///< \u63a5\u6536\u8fde\u63a5\u901a\u9053\n    atomic32_t         send_need_close;\n    atomic32_t         recv_need_close;\n    struct st_reactor *reactor;\n    struct st_mec_channel *channel;\n    attach_info_t      attach[MODE_END]; ///< pipe\u7684job\uff08send\u3001recv\uff09\uff0cagent\u7ebf\u7a0b\u7684\u6267\u884c\u51fd\u6570\u4fe1\u606f\n} mec_pipe_t;\n"})}),"\n",(0,_.jsx)(n.h4,{id:"341-pipe\u7684\u8fde\u63a5",children:"3.4.1 pipe\u7684\u8fde\u63a5"}),"\n",(0,_.jsx)(n.h5,{id:"3411-\u5ba2\u6237\u7aef",children:"3.4.1.1 \u5ba2\u6237\u7aef"}),"\n",(0,_.jsx)(n.p,{children:"pipe\u662f\u5efa\u7acb\u5728tcp\u4e0a\u5c42\u7684\u5e94\u7528\u534f\u8bae\uff0c\u5728tcp\u5efa\u7acb\u6210\u529f\u540e\uff0c\u8fd8\u9700\u8981\u5efa\u7acbpipe\u7684\u8fde\u63a5\uff0c\u6700\u7ec8\u662f\u5728pipe\u7684\u53d1\u9001job\u51fd\u6570mec_proc_send_pipe\u4e2d\u5b8c\u6210\u3002"}),"\n",(0,_.jsx)(n.p,{children:"pipe\u7684send_pipe\u8fde\u63a5\u5927\u81f4\u5206\u4e3a\u4e09\u6b65\uff1a"}),"\n",(0,_.jsxs)(n.ol,{children:["\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u9996\u5148\u5efa\u7acbtcp\u8fde\u63a5\uff0ctcp connect\u6210\u529f\u540e\uff0c\u53d1\u9001protocol code\uff1b"}),"\n",(0,_.jsx)(n.p,{children:"\u534f\u8bae\u7801\u662f\u4e00\u4e2a\u9b54\u6570\uff0c\u4e3b\u8981\u662f\u4e3a\u4e86\u4e0e\u5176\u4ed6\u901a\u4fe1\u534f\u8bae\u505a\u533a\u5206\uff0c\u9632\u6b62\u7f51\u7edc\u6570\u636e\u7684\u5e72\u6270\u3002"}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u5bf9\u7aef\u6536\u5230\u534f\u8bae\u7801\u540e\u4f1a\u56de\u590dlink_ready_ack\uff0c\u7b49\u5f85\u5bf9\u7aef\u56de\u590dlink_ready_ack\uff0c\u5bf9\u7aef\u7684\u54cd\u5e94\u4e86\u4f1a\u5305\u542b\u5927\u5c0f\u7aef\u3001\u7248\u672c\u53f7\uff1b"}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u6536\u5230\u5bf9\u7aef\u56de\u590dlink_ready_ack\u540e\u786e\u8ba4\u53cc\u65b9tcp\u94fe\u8def\u6b63\u5e38\u540e\uff0c\u9700\u8981\u53d1\u9001pipe\u7684connect\u4fe1\u606f\uff0c\u53d1\u9001mec_message_head_t\uff0c\u4e3b\u8981\u662f\u53d1\u9001\u672c\u5730channel\u4fe1\u606f\uff1b\u53d1\u9001\u5b8cpipe\u7684connect\u8bf7\u6c42\u540e\uff0c\u672c\u7aef\u7684send_pipe\u6fc0\u6d3b\u5c31\u5b8c\u6210\u4e86\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"#define FILL_CONNECT_HEAD(head, profile, channel, pipe)                     \\\n    do {                                                                    \\\n        (head).cmd = MEC_CMD_CONNECT;                                       \\ ///< \u547d\u4ee4\u7c7b\u578b\n        (head).src_inst = (profile)->inst_id;                               \\ ///< \u5b9e\u4f8b\uff08\u8282\u70b9\uff09id\n        (head).stream_id = MEC_CHANNEL_ID((channel)->id);                   \\ ///< channel id\n        (head).size = sizeof(mec_message_head_t);                           \\ ///< \u6d88\u606f\u957f\u5ea6\n        (head).flags = ((pipe)->priv == PRIV_HIGH ? 0 : CS_FLAG_PRIV_LOW);  \\ ///< pipe\u7c7b\u578b\n        (head).serial_no = cm_atomic32_inc(&(channel)->serial_no);          \\ ///< channel\u5e8f\u5217\u53f7\n        if (CS_DIFFERENT_ENDIAN((pipe)->send_pipe.options)) {               \\ ///< \u5927\u5c0f\u7aef\u8f6c\u6362\n            (head).src_inst = cs_reverse_uint32((head).src_inst);           \\\n            (head).stream_id = cs_reverse_uint32((head).stream_id);         \\\n            (head).size = cs_reverse_uint32((head).size);                   \\\n            (head).serial_no = cs_reverse_uint32((head).serial_no);         \\\n        }                                                                   \\\n    } while (0)\n"})}),"\n"]}),"\n"]}),"\n",(0,_.jsx)(n.p,{children:"\u5728mec\u521d\u59cb\u5316\u65f6\uff0c\u4e3b\u7ebf\u7a0b\u4f1a\u8fde\u63a5\u6240\u6709\u7684channel\uff0c\u4e5f\u5c31\u662f\u4f1a\u8fde\u63a5pipe\u3002\u6b64\u65f6\u4f1a\u5c06\u6240\u6709pipe\u90fdattach\u5230agent\u4e0a\uff0c\u5e76\u5c06pipe\u7c7b\u578b\u8bbe\u7f6e\u4e3aSEND_MODE\uff0cattach\u6210\u529f\u540e\u8c03\u7528cm_event_notify\u901a\u77e5agent\u6267\u884cpipe\u7684job\u3002\u6b64\u65f6\u4f1a\u6267\u884cmec_proc_send_pipe\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_proc_send_pipe--\x3e|pipe\u8fd8\u6ca1\u6709\u8fde\u63a5\u6210\u529f\u7684\u8bdd\u5c1d\u8bd5\u8fde\u63a5|mec_try_connect--\x3ecs_connect--\x3ecs_open_tcp_link--\x3e|\u5148\u5efa\u7acbtcp\u8fde\u63a5|cs_tcp_connect--\x3ecs_tcp_connect_core--\x3econnect--\x3e|\u8fde\u63a5\u6210\u529f\u540e\u53d1\u9001\u534f\u8bae\u7801,\u534f\u8bae\u786e\u8ba4\u786e\u4fdd\u901a\u4fe1\u4e24\u7aef\u534f\u8bae\u4e00\u81f4|cs_tcp_send_timed--\x3e|\u82e5\u534f\u8bae\u4e00\u81f4\u5bf9\u7aef\u56de\u590dlink_ready_ack,\u63a5\u6536\u8be5\u6d88\u606f\u5e76\u5904\u7406|cs_tcp_recv_timed\ncs_connect--\x3e|\u8fde\u63a5\u6210\u529f\u540e\u53d1\u9001\u6d88\u606f\u5934|cs_send_bytes--\x3ecs_tcp_send_timed\nmec_proc_send_pipe--\x3e|\u5df2\u7ecf\u8fde\u63a5\u6210\u529f,\u8fde\u63a5\u6210\u529f\u540e\u4f1a\u5c06agent\u91cd\u65b0\u653e\u5230idle\u961f\u5217\u91cc|detach_agent"}),"\n",(0,_.jsx)(n.h5,{id:"3412-\u670d\u52a1\u7aef",children:"3.4.1.2 \u670d\u52a1\u7aef"}),"\n",(0,_.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u7684\u8fde\u63a5\u8bf7\u53c2\u8003listener\u3002"}),"\n",(0,_.jsx)(n.h4,{id:"342-pipe\u7684\u6267\u884c",children:"3.4.2 pipe\u7684\u6267\u884c"}),"\n",(0,_.jsx)(n.p,{children:"\u5728socket\u5c42\u9762\u6765\u8bf4\uff0cpipe\u5171\u6709\u4e24\u4e2asocket\uff0c\u4e00\u4e2a\u7528\u4e8e\u53d1\u9001\uff0c\u4e00\u4e2a\u7528\u4e8e\u63a5\u6536\u3002\u6bcf\u4e24\u4e2a\u8282\u70b9\u4e4b\u95f4\u5efa\u7acbpipe\u65f6\uff0c\u90fd\u9700\u8981\u5efa\u7acb\u4e24\u4e2asocket\u3002\u6bd4\u5982\u8282\u70b91\u548c\u8282\u70b92\uff0c\u5bf9\u4e8e\u8282\u70b91\u6765\u8bf4\uff0c\u8282\u70b91\u4f1a\u4e3b\u52a8\u8fde\u63a5\u8282\u70b92\uff0c\u5efa\u7acbsocket1\uff0c\u7528\u4e8e\u53d1\u9001\u3002\u540c\u65f6\u8282\u70b92\u4e5f\u4f1a\u4e3b\u52a8\u8fde\u63a5\u8282\u70b91\uff0c\u5efa\u7acbsocket2\uff0c\u7528\u4e8e\u63a5\u6536\u3002\u5373\u5728pipe\u5c42\u9762\u5efa\u7acb\u7684socket\u7684\u6570\u636e\u6536\u53d1\u90fd\u662f\u5355\u5411\u7684\uff0c\u4e00\u4e2asocket\u4ec5\u7528\u4e8e\u53d1\uff0c\u53e6\u5916\u4e00\u4e2asocket\u4ec5\u7528\u4e8e\u6536\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6bcf\u4e00\u4e2apipe\u90fd\u4f1a\u6709\u4e24\u4e2ajob\uff0c\u4e00\u4e2a\u53d1\u9001job\uff0c\u4e00\u4e2a\u63a5\u6536job\uff0c\u8fd9\u8bb2\u4e2ajob\u5bf9\u5e94socket\u7684\u6536\u53d1\u884c\u4e3a\u3002\u5bf9\u4e8e\u53d1\u9001job\u6765\u8bf4\uff0c\u5176socket\u8fde\u63a5\u662f\u4e3b\u52a8\u5efa\u7acb\u7684\uff0c\u4e14socket\u53ea\u7528\u4e8e\u53d1\u9001\uff0c\u53d1\u9001\u4e5f\u662f\u4e3b\u52a8\u5efa\u7acb\u7684\uff0c\u56e0\u800c\u4e0d\u9700\u8981\u76d1\u542c\uff0c\u5373\u4e0d\u9700\u8981\u5c06\u53d1\u9001socket\u52a0\u5165\u5230reactor\u91cc\uff0c\u53ea\u9700\u8981\u6bcf\u6b21\u53d1\u9001\u524d\u68c0\u67e5\u94fe\u8def\u662f\u5426\u8fde\u63a5\uff0c\u672a\u8fde\u63a5\u7684\u8bdd\u9700\u8981\u5efa\u7acb\u8fde\u63a5\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u800c\u5bf9\u4e8e\u63a5\u6536job\u6765\u8bf4\uff0c\u5728acceptor\u5efa\u7acbtcp\u8fde\u63a5\u540e\uff0c\u5c31\u9700\u8981\u628a\u521b\u5efa\u7684socket\u6dfb\u52a0\u5230reactor\u91cc\uff0c\u7531reactor\u8d1f\u8d23\u76d1\u542c\uff0c\u4f46\u6709\u4e8b\u4ef6\u5230\u6765\u540e\uff08\u6536\u5305\uff09\uff0c\u5c06pipe\u9644\u7740\u5230agent\u4e0a\u8fd0\u884c\uff0c\u6b64\u65f6\u6267\u884c\u7684\u5c31\u662fpipe\u7684\u63a5\u6536job\u3002"}),"\n",(0,_.jsx)(n.h5,{id:"3421-\u53d1\u9001",children:"3.4.2.1 \u53d1\u9001"}),"\n",(0,_.jsx)(n.p,{children:"\u5bf9\u4e8e\u53d1\u9001\u6765\u8bf4\uff0c\u4e3b\u8981\u5c31\u662f\u8fdb\u884csend_pipe\u7684\u8fde\u63a5\u3002\u8fde\u63a5\u8bf7\u67e5\u770b3.4.1pipe\u7684\u8fde\u63a5\u3002"}),"\n",(0,_.jsx)(n.h5,{id:"3422-\u63a5\u6536",children:"3.4.2.2 \u63a5\u6536"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nreactor_wait4events--\x3e|reactor\u76d1\u542c\u5230\u4e8b\u4ef6\u5230\u6765\u5c06pipe\u7ed1\u5b9a\u5230agent\u4e0a\u8fd0\u884c|attach_agent--\x3e|agent\u6536\u5230\u4fe1\u53f7\u4f1a\u6267\u884c\u5bf9\u5e94\u7684job|job--\x3e|reactor\u76d1\u542c\u90fd\u662f\u63a5\u6536job|mec_proc_recv_pipe--\x3emec_proc_recv_msg--\x3e|\u5148\u89e3\u6790\u6d88\u606f\u5934|mec_read_message--\x3e|\u518d\u5904\u7406\u6d88\u606f\u4f53|mec_process_message--\x3e|\u628a\u6d88\u606f\u653e\u5230\u63a5\u6536\u961f\u5217\u91cc|put_msgitem--\x3e|\u901a\u77e5\u961f\u5217\u7ebf\u7a0b\u6709\u65b0\u6d88\u606f\u5230\u6765|cm_event_notify"}),"\n",(0,_.jsx)(n.p,{children:"pipe\u7684\u63a5\u6536job\u5e76\u4e0d\u8d1f\u8d23\u5b9e\u9645\u6d88\u606f\u7684\u5904\u7406\uff0c\u800c\u662f\u5c06\u6d88\u606f\u653e\u5230\u6d88\u606f\u961f\u5217\u91cc\u9762\uff0c\u7531\u961f\u5217\u7ebf\u7a0b\u8fdb\u884c\u5904\u7406\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"35-tcp",children:"3.5 tcp"}),"\n",(0,_.jsx)(n.p,{children:"tcp\u6a21\u5757\u5b9e\u73b0\u4e86tcp\u7684\u6536\u53d1\u5305\uff0c\u521b\u5efasocket\uff0c\u914d\u7f6esocket\u7b49\u529f\u80fd\u3002\u6700\u7ec8\u7684\u6536\u53d1\u5305\u51fa\u5165\u53e3\u90fd\u5728\u672c\u6a21\u5757\u91cc\u3002"}),"\n",(0,_.jsx)(n.h2,{id:"4-\u6570\u636e\u6536\u53d1",children:"4. \u6570\u636e\u6536\u53d1"}),"\n",(0,_.jsx)(n.p,{children:"\u5728\u6574\u4e2amec\u6a21\u5757\u4e2d\uff0c\u6570\u636e\u6536\u53d1\u90fd\u662f\u901a\u8fc7\u961f\u5217\u6765\u8fdb\u884c\u7684\uff0c\u53d1\u9001\u65f6\u4f1a\u5c06\u6570\u636e\u53d1\u9001\u5230\u961f\u5217\u91cc\uff0c\u7b49\u7d2f\u79ef\u4e00\u5b9a\u6d88\u606f\u540e\u6279\u91cf\u8fdb\u884c\u53d1\u9001\uff1b\u63a5\u6536\u6d88\u606f\u65f6\uff0c\u63a5\u6536\u5230\u7684\u6d88\u606f\u4e5f\u662f\u5148\u653e\u5165\u6d88\u606f\u961f\u5217\u4e2d\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"41-\u6d88\u606f",children:"4.1 \u6d88\u606f"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6d88\u606f\u4ea4\u6362\u5934\u90e8\ntypedef struct st_mec_message_head {\n    uint8      cmd;       ///< \u6d88\u606f\u8bf7\u6c42\u7c7b\u578b\n    uint8      flags;     ///< \u72b6\u6001\u6807\u5fd7\n    uint16     batch_size; ///< \u6279\u91cf\u6d88\u606f\u6761\u6570\n    uint32     src_inst;  ///< \u6765\u6e90id\uff08\u6e90\u8282\u70b9id\uff09\n    uint32     dst_inst;  ///< \u76ee\u7684\u8282\u70b9id\n    uint32     stream_id;   ///< \u6d41id\uff08channel id\uff09\n    uint32     size;     ///< \u6d88\u606f\u957f\u5ea6\n    uint32     serial_no; ///< channel\u5e8f\u5217\u53f7\n    uint32     frag_no;   ///< \u5206\u7247\u5e8f\u5217\u53f7\n    uint32     version;   ///< \u534f\u8bae\u7248\u672c\n    uint64     time1;\n    uint64     time2;\n    uint64     time3;\n} mec_message_head_t;\n"})}),"\n",(0,_.jsx)(n.p,{children:"flags\u7684bit\u4f4d\u7528\u4e8e\u5b58\u653e\u6d88\u606f\u7684\u63a7\u5236\u4fe1\u606f\uff0c"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"#define CS_FLAG_NONE                 0x0000  ///< \u6ca1\u6709\u63a7\u5236\u4fe1\u606f\n#define CS_FLAG_MORE_DATA            0x0001  ///< \u9700\u8981\u63a5\u6536\u66f4\u591a\u6d88\u606f\n#define CS_FLAG_END_DATA             0x0002  ///< \u6700\u540e\u4e00\u6761\u6d88\u606f\n#define CS_FLAG_PEER_CLOSED          0x0004  ///< \u5bf9\u7aef\u5173\u95ed\n#define CS_FLAG_COMPRESS             0x0008  ///< \u538b\u7f29\u6807\u5fd7\n#define CS_FLAG_PRIV_LOW             0x0010  ///< \u4f4e\u4f18\u5148\u7ea7\u6d88\u606f\n#define CS_FLAG_BATCH                0x0020  ///< \u6279\u91cf\u53d1\u9001\u6d88\u606f\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u4e5f\u6709\u81ea\u5df1\u7684\u6d88\u606f\u6c60\uff0c\u6d88\u606f\u6c60\u53c8\u5206\u4e3aprivate pool\u548cmsg_pool\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"42-\u6570\u636e\u53d1\u9001",children:"4.2 \u6570\u636e\u53d1\u9001"}),"\n",(0,_.jsx)(n.p,{children:"\u6570\u636e\u53d1\u9001\u5c31\u662f\u628a\u6570\u636e\u653e\u5165\u5bf9\u5e94channel\u7684\u53d1\u9001\u961f\u5217\u4e2d\uff0c\u7b49\u5f85\u961f\u5217\u7ebf\u7a0b\u8fdb\u884c\u6279\u91cf\u53d1\u9001\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u653e\u5165\u79c1\u6709\u961f\u5217"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:" my_queue = &mq_ctx->channel_private_queue[head->dst_inst][channel_id]; ///< \u6839\u636e\u76ee\u7684\u8282\u70b9id\u548cchannel id\u627e\u5230\u961f\u5217\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u653e\u5165queue\uff0c\u5982\u679c\u662f\u4f4e\u4f18\u5148\u7ea7\u6839\u636e\u76ee\u7684\u5b9e\u4f8bid\u548cchannel id\u6765\u8ba1\u7b97hash\uff1b\u5982\u679c\u662f\u9ad8\u4f18\u5148\u7ea7\u653e\u5728\u7b2c\u4e00\u4e2a\u961f\u5217\u91cc\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"    uint32 index = 0;\n    if (CS_PRIV_LOW(head->flags)) {\n        index = cm_hash_uint32((head->dst_inst & 0xFFFFFF) | (channel_id << 24), DTC_MSG_QUEUE_NUM) + 1;\n    }\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6bcf\u4e00\u4e2a\u961f\u5217\u5bf9\u5e94\u4e00\u4e2a\u6d88\u606f\u5904\u7406\u7ebf\u7a0b\uff0c\u82e5\u961f\u5217\u7ebf\u7a0b\u6ca1\u6709\u542f\u52a8\u7684\u8bdd\u8fd8\u9700\u8981\u542f\u52a8\u961f\u5217\u7ebf\u7a0b\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u5c06\u6d88\u606f\u653e\u5165\u961f\u5217\u540e\uff0c\u9700\u8981\u53d1\u9001\u4fe1\u53f7\u901a\u77e5\u961f\u5217\u7ebf\u7a0b\u6709\u65b0\u4efb\u52a1\u5230\u6765\u3002"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_send_data--\x3emec_put_msg_queue--\x3emec_alloc_msgitem--\x3ealloc_msgitems--\x3eput_msgitem--\x3ecm_event_notify\nput_msgitem--\x3ecm_event_init--\x3ecm_create_thread--\x3edtc_task_proc\nmec_send_data--\x3e|\u5982\u679cchannel\u6ca1\u6709\u8fde\u63a5\u9700\u8981\u5148\u8fde\u63a5|mec_scale_out--\x3emec_connect_channel"}),"\n",(0,_.jsx)(n.h3,{id:"43-\u6570\u636e\u63a5\u6536",children:"4.3 \u6570\u636e\u63a5\u6536"}),"\n",(0,_.jsx)(n.p,{children:"\u6570\u636e\u63a5\u6536\u8bf7\u53c2\u80033.4.2pipe\u7684\u6267\u884c\u3002\u6570\u636e\u63a5\u6536\u5904\u7406\u5b9e\u9645\u662f\u5728pipe\u7684\u63a5\u6536job\u4e2d\u6267\u884c\u7684\uff0c\u5177\u4f53\u7684\u6267\u884c\u51fd\u6570\u662fmec_proc_recv_pipe\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u5904\u7406\u6d41\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a"}),"\n",(0,_.jsx)(n.mermaid,{value:"graph TB\nmec_proc_recv_msg--\x3e|\u5148\u8bfb\u51fa\u4e00\u6761\u6d88\u606f|mec_read_message--\x3e|\u518d\u5c06\u6d88\u606f\u653e\u5165\u961f\u5217|mec_process_message"}),"\n",(0,_.jsxs)(n.ol,{children:["\n",(0,_.jsx)(n.li,{children:"\u5148\u8bfb\u53d6\u6d88\u606f\u5934\uff0c\u83b7\u53d6\u6d88\u606f\u4f53\u957f\u5ea6\uff1b"}),"\n",(0,_.jsx)(n.li,{children:"\u518d\u6839\u636e\u6d88\u606f\u4f53\u957f\u5ea6\u8bfb\u53d6\u6d88\u606f\u4f53\uff1b"}),"\n",(0,_.jsx)(n.li,{children:"\u5c06\u6d88\u606f\u653e\u5165\u961f\u5217\uff1b"}),"\n"]}),"\n",(0,_.jsx)(n.p,{children:"\u5c06\u6d88\u606f\u653e\u5165\u961f\u5217\u65f6\uff0c\u9700\u8981\u5148\u627e\u5230\u961f\u5217\u7684\u7d22\u5f15\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"    mq_context_t *mq_ctx = get_recv_mq_ctx(); ///< \u83b7\u53d6\u4e86\u53d1\u9001\u961f\u5217\u4e0a\u4e0b\u6587\n    uint32 index = 0; ///< \u9ed8\u8ba4\u653e\u5165\u7684\u662f\u7d22\u5f15\u4e3a0\u7684\u961f\u5217\n    if (pipe->priv == PRIV_LOW) { ///< \u5982\u679c\u961f\u5217\u662f\u4f4e\u4f18\u5148\u7ea7\uff0c\u9ed8\u8ba4\u653e\u5165\u7684\u662f\u7d22\u5f15\u4e3a1\u7684\u961f\u5217\n        index = 1; // avoid concurrent attacks without affecting performance.\n    }\n    CM_MFENCE;\n    put_msgitem(&mq_ctx->queue[index], msgitem); ///< \u653e\u5165\u961f\u5217\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6d88\u606f\u653e\u5165\u961f\u5217\u540e\uff0c\u5c31\u7531\u961f\u5217\u7ebf\u7a0b\u6765\u5904\u7406\u3002"}),"\n",(0,_.jsx)(n.h2,{id:"5-faq",children:"5. FAQ"}),"\n",(0,_.jsx)(n.h3,{id:"51-\u4ee3\u7801\u5c42\u9762\u5982\u4f55\u533a\u5206channel\u4e2d\u9ad8\u4f4e\u4f18\u5148\u7ea7",children:"5.1 \u4ee3\u7801\u5c42\u9762\u5982\u4f55\u533a\u5206channel\u4e2d\u9ad8\u4f4e\u4f18\u5148\u7ea7\uff1f"}),"\n",(0,_.jsx)(n.p,{children:"\u4ece\u4e00\u5f00\u59cb\uff0cmec\u521d\u59cb\u5316\u5b8c\u6210\u540e\uff0c\u5c31\u5df2\u7ecf\u521b\u5efa\u597d\u4e86\u9ad8\u4f18\u5148\u7ea7\u7684reactor\u3001agent\u4ee5\u53ca\u4f4e\u4f18\u5148\u7ea7\u7684reactor\u3001agent\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2achannel\uff0c\u4e5f\u90fd\u521b\u5efa\u597d\u4e86\u9ad8\u4f18\u5148\u7ea7\u7684pipe\u548c\u4f4e\u4f18\u5148\u7ea7\u7684pipe\u3002\u4e5f\u5c31\u662f\u8bf4\u901a\u9053\u4ece\u4e00\u5f00\u59cb\u5c31\u5efa\u7acb\u597d\u4e86\uff0c\u770b\u4e0a\u5c42\u7684\u6d88\u606f\u671f\u671b\u4f7f\u7528\u54ea\u4e2a\u901a\u9053\u6765\u53d1\u9001\u6d88\u606f\u3002"}),"\n",(0,_.jsx)(n.h4,{id:"541-\u6d88\u606f\u7684\u4f18\u5148\u7ea7",children:"5.4.1 \u6d88\u606f\u7684\u4f18\u5148\u7ea7"}),"\n",(0,_.jsx)(n.p,{children:"channel\u7684\u4f18\u5148\u7ea7\u4e0e\u6d88\u606f\u7684\u4f18\u5148\u7ea7\u6709\u5173\uff0c\u6d88\u606f\u7684\u4f18\u5148\u7ea7\u5728\u6ce8\u518c\u6d88\u606f\u5904\u7406\u51fd\u6570\u65f6\u5019\u5c31\u786e\u5b9a\u4e86\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u6ce8\u518c\u6d88\u606f\u5904\u7406\u51fd\u6570,\u5c06\u6d88\u606f\u6ce8\u518c\u5230mec\u4e0a\u4e0b\u6587\u7684\u56de\u8c03\u91cc\uff0c\u5f53\u6536\u5230\u76f8\u5173\u8bf7\u6c42\u7c7b\u578b\u7684\u6570\u636e\u65f6\uff0c\u4f1a\u8c03\u7528proc\u51fd\u6570\u8fdb\u884c\u5904\u7406\n/// @param cmd \u5904\u7406\u51fd\u6570\u5bf9\u5e94\u7684\u6d88\u606f\u7c7b\u578b\n/// @param proc \u6d88\u606f\u7c7b\u578b\u5bf9\u5e94\u7684\u5904\u7406\u51fd\u6570\n/// @param priv \u6d88\u606f\u7684\u4f18\u5148\u7ea7(\u9ad8\u4f18\u5148\u7ea7\u6216\u8005\u4f4e\u4f18\u5148\u7ea7)\nvoid register_msg_process(mec_command_t cmd, msg_proc_t proc, msg_priv_t priv)\n{\n    mec_context_t *mec_ctx = get_mec_ctx();\n    if (cmd >= MEC_CMD_CEIL) {\n        return;\n    }\n    mec_ctx->cb_processer[cmd].priv = priv;\n    mec_ctx->cb_processer[cmd].proc = proc;\n}\n"})}),"\n",(0,_.jsx)("font",{color:"red",children:"\u9ad8\u4f18\u5148\u7ea7\u7684\u6d88\u606f\u548c\u4f4e\u4f18\u5148\u7ea7\u7684\u6d88\u606f\u5dee\u522b\u5728\u5206\u914d\u5305\u586b\u5145\u63a7\u5236\u4fe1\u606f\u65f6\uff0c\u9ad8\u4f18\u5148\u7ea7\u7684\u6d88\u606f\u662f\u4e0d\u8fdb\u884c\u538b\u7f29\u4f20\u8f93\u7684\uff0c\u800c\u4f4e\u4f18\u5148\u7ea7\u7684\u6d88\u606f\u82e5\u8bbe\u7f6e\u4e86\u538b\u7f29\u5219\u4f1a\u538b\u7f29\u8fdb\u884c\u4f20\u8f93\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"    msg_priv_t priv = mec_ctx->cb_processer[cmd].priv; ///< \u83b7\u53d6cmd\u7c7b\u578b\u6d88\u606f\u7684\u4f18\u5148\u7ea7\n    if (get_mec_profile()->algorithm != COMPRESS_NONE && priv) { \n        head->flags |= CS_FLAG_COMPRESS; ///< \u4f4e\u4f18\u5148\u7ea7\u6d88\u606f\u914d\u7f6e\u538b\u7f29\u7b97\u6cd5\u540e\u9700\u8981\u8bbe\u7f6e\u538b\u7f29\u6807\u5fd7\n    }\n"})}),"\n",(0,_.jsx)("font",{color:"red",children:"\u6839\u636e\u6d88\u606f\u4f18\u5148\u7ea7\u7684\u4e0d\u540c\uff0c\u5176\u653e\u5165\u961f\u5217\u7684\u4f4d\u7f6e\u4e5f\u4e0d\u540c\u3002\u9ad8\u4f18\u5148\u7ea7\u6d88\u606f\u653e\u5165\u7d22\u5f15\u4e3a0\u7684\u961f\u5217\uff0c\u4f4e\u4f18\u5148\u7ea7\u6d88\u606f\u653e\u5165\u7d22\u5f15\u975e0\u7684\u5176\u4ed6\u961f\u5217\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"    uint32 index = 0;\n    if (CS_PRIV_LOW(head->flags)) {\n        index = cm_hash_uint32((head->dst_inst & 0xFFFFFF) | (channel_id << 24), DTC_MSG_QUEUE_NUM) + 1;\n    }\n    put_msgitem(&mq_ctx->queue[index], msgitem); \n"})}),"\n",(0,_.jsx)("font",{color:"red",children:"DTC_MSG_QUEUE_NUM\u7684\u503c\u662f16\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u9ad8\u4f18\u5148\u7ea7\u961f\u5217\u53ea\u6709\u4e00\u4e2a\uff0c\u5c31\u662f\u7b2c\u4e00\u4e2a\uff0c\u4f4e\u4f18\u5148\u7ea7\u961f\u5217\u670915\u4e2a\u3002\u8fd9\u6837\u7684\u8bdd\uff0c\u9ad8\u4f18\u5148\u7ea7\u6d88\u606f\u5c31\u4e0d\u4f1a\u548c\u4f4e\u4f18\u5148\u7ea7\u6d88\u606f\u7ade\u4e89\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6839\u636e\u6d88\u606f\u4f18\u5148\u7ea7\u7684\u4e0d\u540c\uff0c\u6d88\u606f\u7684buf\u5927\u5c0f\u4e5f\u4e0d\u4e00\u6837\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"uint32 buf_size = (priv == PRIV_LOW) ? MEC_ACTL_MSG_BUFFER_SIZE(get_mec_profile()) : MEC_PRIV_MESSAGE_BUFFER_SIZE;\n"})}),"\n",(0,_.jsx)(n.h4,{id:"511-\u63a5\u6536",children:"5.1.1 \u63a5\u6536"}),"\n",(0,_.jsx)("font",{color:"red",children:"\u63a5\u6536\u65f6\u6d88\u606f\u643a\u5e26\u7684\u6d88\u606f\u5934\u4e2d\u5305\u542b\u7684stream_id\u548csrc_inst\u53ef\u4ee5\u786e\u5b9a\u4e00\u4e2achannel\uff0c\u6d88\u606f\u5934\u4e2dflags\u5305\u542b\u4e86\u6d88\u606f\u662f\u9ad8\u4f18\u5148\u7ea7\u8fd8\u662f\u4f4e\u4f18\u5148\u7ea7\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"channel = &mec_ctx->channels[head.src_inst][head.stream_id];\nmsg_priv_t priv = CS_PRIV_LOW(head.flags) ? PRIV_LOW : PRIV_HIGH;\nmec_pipe_t *mec_pipe = &channel->pipe[priv];\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6839\u636e\u6d88\u606f\u7684\u4f18\u5148\u7ea7\uff0c\u4f1a\u5c06pipe\u653e\u5230\u4e0d\u540c\u7b49\u7ea7\u7684reactor\u91cc\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'    if (reactor_register_pipe(mec_pipe, get_mec_reactor(priv)) != CM_SUCCESS) {\n        LOG_RUN_ERR("[MEC]register channel %u priv %u to reactor failed.", channel->id, priv);\n        return CM_ERROR;\n    }\n'})}),"\n",(0,_.jsx)(n.h4,{id:"512-\u53d1\u9001",children:"5.1.2 \u53d1\u9001"}),"\n",(0,_.jsx)("font",{color:"red",children:"\u53d1\u9001\u65f6\u6d88\u606f\u643a\u5e26\u7684\u6d88\u606f\u5934\u4e2d\u5305\u542b\u7684stream_id\u548cdst_inst\u53ef\u4ee5\u786e\u5b9a\u4e00\u4e2achannel\uff0c\u6d88\u606f\u5934\u4e2dflags\u5305\u542b\u4e86\u6d88\u606f\u662f\u9ad8\u4f18\u5148\u7ea7\u8fd8\u662f\u4f4e\u4f18\u5148\u7ea7\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u5728\u53d1\u9001\u65f6\uff0c\u9996\u5148\u6839\u636estream_id\u548cdst_inst\u786e\u5b9achannel\uff0c\u786e\u5b9a\u65b9\u5f0f\u4e3astream_id\u5bf9channel\u4e2a\u6570\u53d6\u4f59\u6570\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"#define MEC_STREAM_TO_CHANNEL_ID(stream_id, channel_num) (uint8)((stream_id) % (channel_num))\nuint32 channel_id = MEC_STREAM_TO_CHANNEL_ID(head->stream_id, profile->channel_num);\nmec_channel_t *channel = &mec_ctx->channels[head->dst_inst][channel_id];///< \u53d6\u51fachannel\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u786e\u5b9achannel\u540e\uff0c\u6839\u636e\u5e94\u7528\u8bbe\u5b9a\u7684\u5305\u7684\u4f18\u5148\u7ea7\u9009\u53d6\u5bf9\u5e94\u7684pipe\uff0c\u5224\u65ad\u5bf9\u5e94\u7684pipe\u662f\u5426\u5df2\u7ecf\u8fde\u63a5\u6fc0\u6d3b\uff0c\u672a\u8fde\u63a5\u6fc0\u6d3b\u76f4\u63a5\u8fd4\u56de\u9519\u8bef\uff0c\u672c\u6b21\u53d1\u9001\u5931\u8d25\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'        msg_priv_t priv = CS_PRIV_LOW(head->flags) ? PRIV_LOW : PRIV_HIGH;\n        if (!channel->pipe[priv].send_pipe_active) {\n            LOG_DEBUG_ERR("[MEC]data send_pipe to dst_inst[%u] priv[%u] is not ready.", head->dst_inst, priv);\n            return CM_ERROR;\n        }\n'})}),"\n",(0,_.jsx)(n.h3,{id:"52-\u4e94\u5927\u7ec4\u4ef6\u7684\u5173\u7cfb\u56fe",children:"5.2 \u4e94\u5927\u7ec4\u4ef6\u7684\u5173\u7cfb\u56fe\uff1f"}),"\n",(0,_.jsx)(n.h3,{id:"53-\u6536\u53d1pipe\u662f\u5426\u90fd\u9700\u8981\u6fc0\u6d3b",children:"5.3 \u6536\u53d1pipe\u662f\u5426\u90fd\u9700\u8981\u6fc0\u6d3b"}),"\n",(0,_.jsx)(n.p,{children:"\u6536\u53d1pipe\u5fc5\u987b\u8981\u6fc0\u6d3b\u624d\u80fd\u8fdb\u884c\u6b63\u5e38\u63a5\u6536\u53d1\u9001\u6570\u636e\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u82e5\u53ea\u6fc0\u6d3bsend pipe\u5219\u53ea\u53ef\u4ee5\u53d1\u9001\u6570\u636e\uff0c\u4e0d\u53ef\u4ee5\u63a5\u6536\u6570\u636e\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u82e5\u53ea\u6fc0\u6d3brecv pipe\u5219\u53ea\u53ef\u4ee5\u63a5\u6536\u6570\u636e\uff0c\u4e0d\u53ef\u4ee5\u53d1\u9001\u6570\u636e\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"54-\u7f51\u7edc\u8d85\u65f6\u65f6\u95f4\u5982\u4f55\u8bbe\u7f6e",children:"5.4 \u7f51\u7edc\u8d85\u65f6\u65f6\u95f4\u5982\u4f55\u8bbe\u7f6e"}),"\n",(0,_.jsx)(n.p,{children:"\u8d85\u65f6\u65f6\u95f4\u53c2\u6570\u5982\u4e0b\uff0c\u5728\u521d\u59cb\u5316channel\u7684\u65f6\u5019\u521d\u59cb\u5316\uff0c"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"        pipe->send_pipe.connect_timeout = profile->connect_timeout; ///< \u53d1\u9001pipe\u8fde\u63a5\u8d85\u65f6\u65f6\u95f4\n        pipe->send_pipe.socket_timeout = profile->socket_timeout;   ///< \u53d1\u9001pipe socket\u63a5\u6536\u53d1\u9001\u8d85\u65f6\u65f6\u95f4\n        pipe->recv_pipe.connect_timeout = profile->connect_timeout; ///< \u63a5\u6536pipe\u8fde\u63a5\u8d85\u65f6\u65f6\u95f4\n        pipe->recv_pipe.socket_timeout = profile->socket_timeout; ///< \u63a5\u6536pipe socket\u63a5\u6536\u53d1\u9001\u8d85\u65f6\u65f6\u95f4\n        pipe->send_pipe.l_onoff = 1; ///< 0=off, 1=on(\u5f00\u5173)\n        pipe->send_pipe.l_linger = 1; ///< \u5ef6\u65f6\u65f6\u95f4\n"})}),"\n",(0,_.jsxs)(n.blockquote,{children:["\n",(0,_.jsx)(n.p,{children:"\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b,\u5f53\u8c03\u7528close\u5173\u95edsocke\u7684\u4f7f\u7528\uff0cclose\u4f1a\u7acb\u5373\u8fd4\u56de\u3002\u4f46\u662f\uff0c\u5982\u679csend buffer\u4e2d\u8fd8\u6709\u6570\u636e\uff0c\u7cfb\u7edf\u4f1a\u8bd5\u7740\u5148\u628asend buffer\u4e2d\u7684\u6570\u636e\u53d1\u9001\u51fa\u53bb\uff0c\u7136\u540eclose\u624d\u8fd4\u56de\u3002SO_LINGER\u9009\u9879\u5219\u662f\u7528\u6765\u4fee\u6539\u8fd9\u79cd\u9ed8\u8ba4\u64cd\u4f5c\u7684\u3002"}),"\n",(0,_.jsxs)(n.ol,{children:["\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u5f53l_onoff\u88ab\u8bbe\u7f6e\u4e3a0\u7684\u65f6\u5019"}),"\n",(0,_.jsx)(n.p,{children:"\u5c06\u4f1a\u5173\u95edSO_LINGER\u9009\u9879\uff0c\u5373TCP\u6216\u5219SCTP\u4fdd\u6301\u9ed8\u8ba4\u64cd\u4f5c\uff1aclose\u7acb\u5373\u8fd4\u56de\uff0c\u5e95\u5c42\u4f1a\u5c06\u672a\u53d1\u9001\u5b8c\u7684\u6570\u636e\u53d1\u9001\u5b8c\u6210\u540e\u518d\u91ca\u653e\u8d44\u6e90\uff0c\u4e5f\u5c31\u662f\u4f18\u96c5\u7684\u9000\u51fa\u3002"}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"l_onoff\u503c\u975e0\uff0cl_linger = 0\n\u5f53\u8c03\u7528close\u7684\u65f6\u5019\uff0cTCP\u8fde\u63a5\u4f1a\u7acb\u5373\u65ad\u5f00\u3002send buffer\u4e2d\u672a\u88ab\u53d1\u9001\u7684\u6570\u636e\u5c06\u88ab\u4e22\u5f03\uff0c\u5e76\u5411\u5bf9\u65b9\u53d1\u9001\u4e00\u4e2aRST\u4fe1\u606f\u3002\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u7531\u4e8e\u8fd9\u79cd\u65b9\u5f0f\uff0c\u662f\u975e\u6b63\u5e38\u76844\u4e2d\u63e1\u624b\u65b9\u5f0f\u7ed3\u675fTCP\u94fe\u63a5\uff0c\u6240\u4ee5\uff0cTCP\u8fde\u63a5\u5c06\u4e0d\u4f1a\u8fdb\u5165TIME_WAIT\u72b6\u6001\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u89e3\u51b3\u8fc7\u591a\u7684\u7684TIME_WAIT\u5bfc\u81f4\u8d44\u6e90\u4e0d\u8db3\u7684\u95ee\u9898\uff0c\u4f46\u662f\u8fd9\u6837\u4f1a\u5bfc\u81f4\u65b0\u5efa\u7acb\u7684\u53ef\u80fd\u548c\u5c31\u8fde\u63a5\u7684\u6570\u636e\u9020\u6210\u6df7\u4e71\u3002"}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u8bbe\u7f6e l_onoff \u4e3a\u975e0\uff0cl_linger\u4e3a\u975e0"}),"\n",(0,_.jsx)(n.p,{children:"\u5f53\u5957\u63a5\u53e3\u5173\u95ed\u65f6\u5185\u6838\u5c06\u62d6\u5ef6\u4e00\u6bb5\u65f6\u95f4\uff08\u7531l_linger\u51b3\u5b9a\uff09\u3002\u5982\u679c\u5957\u63a5\u53e3\u7f13\u51b2\u533a\u4e2d\u4ecd\u6b8b\u7559\u6570\u636e\uff0c\u8fdb\u7a0b\u5c06\u5904\u4e8e\u7761\u7720\u72b6\u6001\uff0c\u76f4 \u5230\uff08a\uff09\u6240\u6709\u6570\u636e\u53d1\u9001\u5b8c\u4e14\u88ab\u5bf9\u65b9\u786e\u8ba4\uff0c\u4e4b\u540e\u8fdb\u884c\u6b63\u5e38\u7684\u7ec8\u6b62\u5e8f\u5217\uff08\u63cf\u8ff0\u5b57\u8bbf\u95ee\u8ba1\u6570\u4e3a0\uff09\u6216\uff08b\uff09\u5ef6\u8fdf\u65f6\u95f4\u5230\u3002\u6b64\u79cd\u60c5\u51b5\u4e0b\uff0c\u5e94\u7528\u7a0b\u5e8f\u68c0\u67e5close\u7684\u8fd4\u56de\u503c\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u5982\u679c\u5728\u6570\u636e\u53d1\u9001\u5b8c\u5e76\u88ab\u786e\u8ba4\u524d\u65f6\u95f4\u5230\uff0cclose\u5c06\u8fd4\u56deEWOULDBLOCK\u9519\u8bef\u4e14\u5957\u63a5\u53e3\u53d1\u9001\u7f13\u51b2\u533a\u4e2d\u7684\u4efb\u4f55\u6570\u636e\u90fd\u4e22\u5931\u3002close\u7684\u6210\u529f\u8fd4\u56de\u4ec5\u544a\u8bc9\u6211\u4eec\u53d1\u9001\u7684\u6570\u636e\uff08\u548cFIN\uff09\u5df2\u7531\u5bf9\u65b9TCP\u786e\u8ba4\uff0c\u5b83\u5e76\u4e0d\u80fd\u544a\u8bc9\u6211\u4eec\u5bf9\u65b9\u5e94\u7528\u8fdb\u7a0b\u662f\u5426\u5df2\u8bfb\u4e86\u6570\u636e\u3002\u5982\u679c\u5957\u63a5\u53e3\u8bbe\u4e3a\u975e\u963b\u585e\u7684\uff0c\u5b83\u5c06\u4e0d\u7b49\u5f85close\u5b8c\u6210\u3002"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,_.jsx)(n.h4,{id:"541-\u5ba2\u6237\u7aef\u4e3b\u52a8\u53d1\u8d77\u8fde\u63a5",children:"5.4.1 \u5ba2\u6237\u7aef\uff08\u4e3b\u52a8\u53d1\u8d77\u8fde\u63a5\uff09"}),"\n",(0,_.jsxs)(n.ol,{children:["\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u8bbe\u7f6e\u63a5\u6536\u53d1\u9001\u7f13\u51b2\u533a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// \u9ed8\u8ba4\u63a5\u6536\u53d1\u9001\u7f13\u51b2\u533a\u5747\u672a64M\n(void)setsockopt(sock, SOL_SOCKET, SO_SNDBUF, (char *)&send_size, sizeof(uint32));\n(void)setsockopt(sock, SOL_SOCKET, SO_RCVBUF, (char *)&recv_size, sizeof(uint32));\n"})}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u8bbe\u7f6e\u8fde\u63a5\u8d85\u65f6\u65f6\u95f4"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"///< \u8d85\u65f6\u65f6\u95f4\u4e3a profile->connect_timeout\n(void)setsockopt(sock, SOL_SOCKET, SO_SNDTIMEO, (char *)&tv, sizeof(tv));\n(void)setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, (char *)&tv, sizeof(tv));\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u8bbe\u7f6e\u53f7\u8d85\u65f6\u65f6\u95f4\u540e\uff0c\u4f1a\u5c1d\u8bd5connect\uff0c\u82e5connect\u5931\u8d25\u4e86\uff0c\u5219\u4f1a\u4f1a\u8ba1\u7b97\u4e00\u4e2a\u8d85\u65f6\u7ed3\u675f\u65f6\u95f4\u7528poll\uff08linux\uff09\u6216select\uff08windows\uff09\u91cd\u65b0\u5c1d\u8bd5\u8fde\u63a5\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"   ret = connect(link->sock, SOCKADDR(&link->remote), link->remote.salen);\n   if (ret < 0) { // \u82e5connect\u5931\u8d25\uff0c\u5219\u4f1a\u8ba1\u7b97\u4e00\u4e2a\u8d85\u65f6\u7ed3\u675f\u65f6\u95f4\u7528poll\u6216select\u91cd\u65b0\u5c1d\u8bd5\u8fde\u63a5\n       if (sock_attr->connect_timeout < 0) {\n           end_time = -1;\n       } else {\n           end_time = cm_current_time() + sock_attr->connect_timeout / (int32)MILLISECS_PER_SECOND;\n       }\n       error_no = cm_get_os_error();\n       if (cs_tcp_connect_wait(link, error_no, end_time) == CM_SUCCESS) {\n           ret = 0;\n       }\n   }\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u4f7f\u7528poll\u6216\u8005select\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4\u6765\u8fdb\u884c\u8fde\u63a5\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"#ifndef WIN32\n   return poll(fds, nfds, timeout); ///< timeout\u65f6\u95f4\u5185\u8fd8\u6ca1\u6709\u4e8b\u4ef6\u53d1\u751f\u5c06\u8fd4\u56de\n#else\n   fd_set wfds;\n   fd_set rfds;\n   fd_set efds;\n   struct pollfd *pfds = fds;\n   struct timeval tv, *tvptr = NULL;\n\n   FD_ZERO(&rfds);\n   FD_ZERO(&wfds);\n   FD_ZERO(&efds);\n   if (timeout >= 0) {\n       tv.tv_sec = timeout / CM_TIME_THOUSAND_UN;\n       tv.tv_usec = (timeout % CM_TIME_THOUSAND_UN) * CM_TIME_THOUSAND_UN;\n       tvptr = &tv;\n   }\n\n   cs_tcp_poll_set_fd(pfds, nfds, &wfds, &rfds, &efds);\n\n   return (int32)select((int)(pfds->fd + 1), &rfds, &wfds, &efds, tvptr);///< timeout\u65f6\u95f4\u5185\u8fd8\u6ca1\u6709\u4e8b\u4ef6\u53d1\u751f\u5c06\u8fd4\u56de\n#endif\n"})}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u8fde\u63a5\u6210\u529f\u540e\uff0c\u4f1a\u91cd\u8bbesocket\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u5c06\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u4e3a0\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"   struct timeval tv = { 0, 0 };\n   (void)setsockopt(sock, SOL_SOCKET, SO_SNDTIMEO, (char *)&tv, sizeof(tv));\n   (void)setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, (char *)&tv, sizeof(tv));\n"})}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u8bbe\u7f6eio\u6a21\u5f0f\uff0c\u8bbe\u7f6eIO\u4e3a\u975e\u963b\u585eIO\uff0c\u914d\u7f6eTCP_NODELAY"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"void cs_set_io_mode(socket_t sock, bool32 nonblock, bool32 nodelay)\n{\n   tcp_option_t option;\n   option = nonblock ? 1 : 0;\n   (void)cs_ioctl_socket(sock, FIONBIO, &option);\n\n   option = nodelay ? 1 : 0;\n   (void)setsockopt(sock, IPPROTO_TCP, TCP_NODELAY, (char *)&option, sizeof(option));\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,_.jsxs)(n.blockquote,{children:["\n",(0,_.jsx)(n.p,{children:"TCP_NODELAY\u9009\u9879\u662f\u7528\u6765\u63a7\u5236\u662f\u5426\u5f00\u542fNagle\u7b97\u6cd5\uff0c\u8be5\u7b97\u6cd5\u662f\u4e3a\u4e86\u63d0\u9ad8\u8f83\u6162\u7684\u5e7f\u57df\u7f51\u4f20\u8f93\u6548\u7387\uff0c\u51cf\u5c0f\u5c0f\u5206\u7ec4\u7684\u62a5\u6587\u4e2a\u6570\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u8981\u6c42\u4e00\u4e2aTCP\u8fde\u63a5\u4e0a\u6700\u591a\u53ea\u80fd\u6709\u4e00\u4e2a\u672a\u88ab\u786e\u8ba4\u7684\u5c0f\u5206\u7ec4\uff0c\u5728\u8be5\u5c0f\u5206\u7ec4\u7684\u786e\u8ba4\u5230\u6765\u4e4b\u524d\uff0c\u4e0d\u80fd\u53d1\u9001\u5176\u4ed6\u5c0f\u5206\u7ec4\u3002"}),"\n"]}),"\n",(0,_.jsxs)(n.ol,{start:"5",children:["\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u8bbe\u7f6ekeepalive\u53c2\u6570\uff0c\u9ed8\u8ba4keepalive\u914d\u7f6e\u4e3aidle120s\uff0cinterval\u4e3a5s\uff0ckeepalive\u6b21\u6570\u4e3a3\u6b21\u3002\u4e5f\u5c31\u662f\u94fe\u8def\u4e4b\u95f4\u6700\u957f120+5*3=135\u79d2\u5185\u6ca1\u6709\u6570\u636e\u4ea4\u4e92\u5c31\u4f1a\u5173\u95ed\u8fde\u63a5\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"    tcp_option_t option;\n    option = 1;\n\n    (void)setsockopt(sock, SOL_SOCKET, SO_KEEPALIVE, (void *)&option, sizeof(int32));\n    (void)setsockopt(sock, SOL_TCP, TCP_KEEPIDLE, (void *)&idle, sizeof(int32));\n    (void)setsockopt(sock, SOL_TCP, TCP_KEEPINTVL, (void *)&interval, sizeof(int32));\n    (void)setsockopt(sock, SOL_TCP, TCP_KEEPCNT, (void *)&count, sizeof(int32));\n"})}),"\n"]}),"\n",(0,_.jsxs)(n.li,{children:["\n",(0,_.jsx)(n.p,{children:"\u8bbe\u7f6eSO_LINGER\uff0c\u8bbe\u7f6e\u5173\u95edTCP\u8fde\u63a5\u65f6\u7684\u884c\u4e3a\uff0c\u8bbe\u7f6e\u5173\u95ed\u8fde\u63a5\u65f6\u7b49\u5f85\u53d1\u9001\u7f13\u5b58\u533a\u7684\u6570\u636e\u88ab\u53d1\u9001\u51fa\u53bb\u7684\u65f6\u95f4\uff0c\u5f53\u524d\u914d\u7f6e\u4e3a1\u79d2\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"    struct linger so_linger;\n    so_linger.l_onoff = l_onoff;\n    so_linger.l_linger = l_linger;\n    (void)setsockopt(sock, SOL_SOCKET, SO_LINGER, (char *)&so_linger, sizeof(struct linger));\n"})}),"\n"]}),"\n"]}),"\n",(0,_.jsx)(n.h4,{id:"542-\u670d\u52a1\u7aef\u63a5\u53d7\u8fde\u63a5\u7684\u4e00\u65b9",children:"5.4.2 \u670d\u52a1\u7aef\uff08\u63a5\u53d7\u8fde\u63a5\u7684\u4e00\u65b9\uff09"}),"\n",(0,_.jsx)(n.p,{children:"\u4e0e\u5ba2\u6237\u7aef\u8bbe\u7f6e\u7c7b\u4f3c\uff0c\u670d\u52a1\u7aef\u5728\u63a5\u6536\u5230\u4e00\u4e2a\u5ba2\u6237\u7aef\u8bf7\u6c42\u5e76\u521b\u5efasocket\u540e\uff0c\u4f1a\u5bf9socket\u8bbe\u7f6eIO\u6a21\u5f0f\uff0cbuffer\u5927\u5c0f\uff0ckeepalive\uff0cSO_LINGER\uff0c\u8fd9\u4e9b\u914d\u7f6e\u4e0e\u5ba2\u6237\u7aef\u8bbe\u7f6e\u65b9\u5f0f\u4e00\u81f4\u3002"}),"\n",(0,_.jsx)(n.h4,{id:"543-\u6d88\u606f\u6536\u53d1\u8d85\u65f6",children:"5.4.3 \u6d88\u606f\u6536\u53d1\u8d85\u65f6"}),"\n",(0,_.jsx)(n.p,{children:"\u5728\u6bcf\u6b21\u6d88\u606f\u63a5\u6536\u65f6\uff0c\u90fd\u4f1a\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4\u6765\u8fdb\u884c\u63a5\u6536\uff0c\u8d85\u65f6\u673a\u5236\u662f\u5229\u7528poll\u6765\u8bbe\u7f6e\uff0c\u5373\u6bcf\u4e00\u6b21\u8bfb\u53d6\u90fd\u4f1a\u8c03\u7528poll\u7b49\u5f85\u76f4\u5230\u6570\u636e\u5230\u6765\u6216\u8005\u8d85\u65f6\u8fd4\u56de\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"/// @brief \u7b49\u5f85tcp\u5957\u63a5\u5b57\u4e8b\u4ef6\u6210\u529f\u6216\u8005\u8d85\u65f6\n/// @param link tcp\u8fde\u63a5\u4fe1\u606f\n/// @param wait_for \u7b49\u5f85\u4e8b\u4ef6\u7c7b\u578b\uff0c\u8bfb\u6216\u5199\n/// @param timeout \u8d85\u65f6\u65f6\u95f4\n/// @param ready \u662f\u5426\u51c6\u5907\u597d\n/// @return \nstatus_t cs_tcp_wait(tcp_link_t *link, uint32 wait_for, int32 timeout, bool32 *ready)\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u5728\u8bfb\u53d6\u6d88\u606f\u65f6\uff0c\u82e5\u6d88\u606f\u8fd8\u6ca1\u6709\u5168\u90e8\u8bfb\u5b8c\uff0c\u4f1a\u5faa\u73af\u8bfb\u53d6\uff0c\u6bcf\u6b21\u8bfb\u53d6\u90fd\u4f1a\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4,\u8bfb\u53d6\u6570\u636e\u7684\u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\u4e3a50ms\u3002\u7136\u540e\u4f1a\u7d2f\u79ef\u8bfb\u53d6\u8d85\u65f6\u65f6\u95f4\uff0c\u5982\u679c\u65f6\u95f4\u7d2f\u79ef\u5230socket_timeout\u5219\u4f1a\u8ba4\u4e3a\u8bfb\u53d6\u8d85\u65f6\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'     while (remain_size > 0) {\n        if (cs_wait(pipe, CS_WAIT_FOR_READ, CM_POLL_WAIT, &ready) != CM_SUCCESS) { ///< \u6bcf\u6b21\u8bfb\u53d6\u90fd\u5e26\u8d85\u65f6\u65f6\u95f4\u53bb\u8bfb\n            return CM_ERROR;\n        }\n\n        if (!ready) { /// \u4f1a\u7d2f\u79ef\u8d85\u65f6\u65f6\u95f4\n            wait_interval += CM_POLL_WAIT;\n            if (wait_interval >= pipe->socket_timeout) {///< \u5f53\u65f6\u95f4\u7d2f\u79ef\u8d85\u8fc7socket_timeout\u51fa\u9519\u8fd4\u56de\n                CM_THROW_ERROR(ERR_TCP_TIMEOUT, "recv data");\n                return CM_ERROR;\n            }\n            continue;\n        }\n\n        if (VIO_RECV(pipe, read_buf, remain_size, &read_size, &wait_event) != CM_SUCCESS) {\n            return CM_ERROR;\n        }\n\n        read_buf    += read_size;\n        remain_size -= read_size;\n    }\n'})}),"\n",(0,_.jsx)(n.h3,{id:"55-\u6279\u5904\u7406\u7684\u6d88\u606f\u903b\u8f91\u600e\u4e48\u786e\u5b9a\u4e00\u6b21\u5904\u7406\u591a\u5c11\u6761\u6d88\u606f",children:"5.5 \u6279\u5904\u7406\u7684\u6d88\u606f\u903b\u8f91\uff0c\u600e\u4e48\u786e\u5b9a\u4e00\u6b21\u5904\u7406\u591a\u5c11\u6761\u6d88\u606f"}),"\n",(0,_.jsx)(n.p,{children:"\u8bf7\u67e5\u770b\u961f\u5217\u7ae0\u82822.5.3 \u961f\u5217\u6279\u5904\u7406\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"56-\u53d1\u9001\u5931\u8d25\u540e\u7684\u8bca\u65ad",children:"5.6 \u53d1\u9001\u5931\u8d25\u540e\u7684\u8bca\u65ad"}),"\n",(0,_.jsx)(n.p,{children:"\u5bf9\u4e8e\u5e94\u7528\u5c42\u6765\u8bf4\uff0c\u5c06\u6d88\u606f\u653e\u5165\u961f\u5217\u5c31\u662f\u6210\u529f\uff0c\u53ea\u6709\u8fd4\u56de\u503c\u6807\u8bc6\u662f\u5426\u6210\u529f\u3002\u8fd4\u56de\u6210\u529f\u4e5f\u5e76\u4e0d\u8868\u793a\u6d88\u606f\u4e00\u5b9a\u53d1\u9001\u51fa\u53bb\u4e86\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u5e94\u7528\u5c42\u662f\u901a\u8fc7\u5e94\u7528\u5c42\u6d88\u606f\u7684\u786e\u8ba4\u6765\u5224\u65ad\u6d88\u606f\u5b9e\u9645\u662f\u5426\u53d1\u9001\u6210\u529f\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u6682\u65f6\u4e0d\u63d0\u4f9b\u53d1\u9001\u5931\u8d25\u7684\u8bca\u65ad\u4fe1\u606f\uff0c\u82e5\u5f00\u542f\u4e86debug\u65e5\u5fd7\u7ea7\u522b\uff0c\u4f1a\u6709\u65e5\u5fd7\u6253\u5370\u3002"}),"\n",(0,_.jsx)(n.h3,{id:"57-\u7f51\u7edc\u6d88\u606f\u5e72\u6270\u5982\u4f55\u8bc6\u522b\u975e\u672c\u8282\u70b9\u6d88\u606f",children:"5.7 \u7f51\u7edc\u6d88\u606f\u5e72\u6270\uff0c\u5982\u4f55\u8bc6\u522b\u975e\u672c\u8282\u70b9\u6d88\u606f"}),"\n",(0,_.jsx)(n.p,{children:"\u5728\u6536\u5230\u6d88\u606f\u540e\u4f1a\u6821\u9a8c\u6d88\u606f\u5934\u90e8\uff0c\u4f1a\u68c0\u67e5stream_id\u662f\u5426\u5408\u6cd5\uff0csrc_inst\u662f\u5426\u5408\u6cd5\u4ee5\u53ca\u6765\u6e90\u8282\u70b9id\u548c\u76ee\u7684\u8282\u70b9id\u662f\u5426\u6b63\u786e\u3002"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'    if (md_check_stream_node_exist(head->stream_id, head->src_inst) != CM_SUCCESS \n        || head->src_inst == cur_node || head->dst_inst != cur_node) {\n        LOG_DEBUG_ERR("[MEC]rcvhead: invalid stream_id %u or src_inst %u or dst_inst %u, cur=%u",\n            head->stream_id, head->src_inst, head->dst_inst, cur_node);\n        return CM_ERROR;\n    }\n\n    if (SECUREC_UNLIKELY(head->cmd >= MEC_CMD_CEIL)) {\n        LOG_DEBUG_ERR("[MEC]rcvhead:invalid msg command %u", head->cmd);\n        return CM_ERROR;\n    }\n    if (SECUREC_UNLIKELY(mec_ctx->cb_processer[head->cmd].proc == NULL)) {\n        LOG_DEBUG_ERR("[MEC]rcvhead:no message handling function registered for message type %u", head->cmd);\n        return CM_ERROR;\n    }\n'})}),"\n",(0,_.jsx)(n.h3,{id:"58-agent\u6267\u884cjob\u7ed3\u675f\u7684\u6807\u5fd7\u63a5\u6536\u591a\u5c11\u6570\u636e\u7ed3\u675f",children:"5.8 agent\u6267\u884cjob\u7ed3\u675f\u7684\u6807\u5fd7\uff0c\u63a5\u6536\u591a\u5c11\u6570\u636e\u7ed3\u675f"}),"\n",(0,_.jsx)(n.p,{children:"agent\u6267\u884cjob\u65f6\uff0c\u82e5\u662f\u53d1\u9001job\uff0c\u5c06\u4e00\u6761\u6d88\u606f\u53d1\u9001\u7ed3\u675f\u540e\uff0cjob\u7ed3\u675f\u3002"}),"\n",(0,_.jsx)(n.p,{children:"\u82e5\u662f\u63a5\u6536job\uff0c\u5148\u63a5\u6536\u6d88\u606f\u5934\uff0c\u518d\u63a5\u6536\u6d88\u606f\u4f53\uff0c\u4e00\u6761\u6d88\u606f\u63a5\u6536\u7ed3\u675f\u540e\uff0cjob\u7ed3\u675f\u3002"}),"\n",(0,_.jsx)(n.h2,{id:"reference",children:"reference"}),"\n",(0,_.jsxs)(n.ol,{children:["\n",(0,_.jsx)(n.li,{children:(0,_.jsx)(n.a,{href:"https://blog.csdn.net/qq_38537501/article/details/118310363",children:"https://blog.csdn.net/qq_38537501/article/details/118310363"})}),"\n"]})]})}function l(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,_.jsx)(n,{...e,children:(0,_.jsx)(d,{...e})}):d(e)}},88025:(e,n,c)=>{c.d(n,{A:()=>t});const t=c.p+"assets/images/reactor_flow-d550b147c539c3acbfc4f338cead231b.jpg"},93529:(e,n,c)=>{c.d(n,{A:()=>t});const t=c.p+"assets/images/node_comm-08bbcc7bd44bbaf41948165376a0ecf2.jpg"}}]);