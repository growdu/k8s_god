"use strict";(self.webpackChunkk_8_s_god=self.webpackChunkk_8_s_god||[]).push([[8932],{28453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>a});var _=r(96540);const t={},c=_.createContext(t);function s(e){const n=_.useContext(c);return _.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),_.createElement(c.Provider,{value:n},e.children)}},64132:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>p,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>_,toc:()=>i});const _=JSON.parse('{"id":"cluster/DCF/dcf\u5199\u5165\u673a\u5236","title":"dcf\u5199\u5165\u673a\u5236","description":"\u5199\u5165","source":"@site/docs/cluster/DCF/dcf\u5199\u5165\u673a\u5236.md","sourceDirName":"cluster/DCF","slug":"/cluster/DCF/dcf\u5199\u5165\u673a\u5236","permalink":"/blog/docs/cluster/DCF/dcf\u5199\u5165\u673a\u5236","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/cluster/DCF/dcf\u5199\u5165\u673a\u5236.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"C\u8bed\u8a00\u96ea\u82b1\u7b97\u6cd5,\u8bb0\u4e00\u6b21\u96ea\u82b1\u7b97\u6cd5\u7684\u5b9e\u73b0","permalink":"/blog/docs/cluster/C\u8bed\u8a00\u96ea\u82b1\u7b97\u6cd5,\u8bb0\u4e00\u6b21\u96ea\u82b1\u7b97\u6cd5\u7684\u5b9e\u73b0"},"next":{"title":"dcf\u6295\u7968\u7cfb\u7edf\u8be6\u89e3","permalink":"/blog/docs/cluster/DCF/dcf\u6295\u7968\u7cfb\u7edf\u8be6\u89e3"}}');var t=r(74848),c=r(28453);const s={},a="dcf\u5199\u5165\u673a\u5236",p={},i=[{value:"\u5199\u5165",id:"\u5199\u5165",level:2},{value:"\u786e\u8ba4",id:"\u786e\u8ba4",level:2}];function l(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"dcf\u5199\u5165\u673a\u5236",children:"dcf\u5199\u5165\u673a\u5236"})}),"\n",(0,t.jsx)(n.h2,{id:"\u5199\u5165",children:"\u5199\u5165"}),"\n",(0,t.jsx)(n.p,{children:"dcf\u63d0\u4f9b\u5982\u4e0b\u4e24\u4e2a\u5199\u5165\u63a5\u53e3\uff1a"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:(0,t.jsx)(n.strong,{children:"dcf_write"})})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"int dcf_write(unsigned int stream_id, const char* buffer, unsigned int length, unsigned long long key, unsigned long long *index);\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u4ec5\u5728leader\u8282\u70b9\u8c03\u7528\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:(0,t.jsx)(n.strong,{children:"dcf_universal_write"})})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"int dcf_universal_write(unsigned int stream_id, const char* buffer, unsigned int length, unsigned long long key, unsigned long long *index);\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u53ef\u4ee5\u5728\u4efb\u610f\u8282\u70b9\u8c03\u7528\u3002"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u786e\u8ba4",children:"\u786e\u8ba4"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:(0,t.jsx)(n.strong,{children:"dcf_register_after_writer"})})}),"\n",(0,t.jsx)(n.p,{children:"\u7528\u4e8e\u6ce8\u518cleader\u8282\u70b9\u5199\u5165\u6210\u529f\u56de\u8c03\u51fd\u6570\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"int dcf_register_after_writer(usr_cb_after_writer_t cb_func)\n{\n    return rep_register_after_writer(ENTRY_TYPE_LOG, cb_func);\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6700\u7ec8\u5c06\u56de\u8c03\u51fd\u6570\u6ce8\u518c\u5230\u5168\u5c40\u53d8\u91cf"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"int rep_register_after_writer(entry_type_t type, usr_cb_after_writer_t cb_func)\n{\n    g_cb_after_writer[type] = cb_func;\n    return CM_SUCCESS;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u8c03\u7528\u6d41\u7a0b\u5982\u4e0b\uff1a"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TB\nrep_common_init--\x3ecm_create_thread--\x3e\n|\u542f\u52a8\u4e2a\u7ebf\u7a0b\u6765\u6267\u884capply|rep_apply_thread_entry--\x3erep_apply_proc\n--\x3eg_cb_after_writer"}),"\n",(0,t.jsx)(n.p,{children:"\u7ebf\u7a0b\u5728\u7b49\u5f85\u6761\u4ef6\u53d8\u91cf\u91ca\u653e\uff0c\u5e76\u6267\u884capply\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'// \u5148\u67e5\u51fa\u6709\u591a\u5c11\u6761\u6d41\nif (md_get_stream_list(streams, &stream_count) != CM_SUCCESS) {\n        LOG_DEBUG_ERR("[REP]md_get_stream_list failed");\n        return;\n    }\nwhile (!thread->closed) { // \u82e5\u7ebf\u7a0b\u6ca1\u6709\u5173\u95ed\u5219\u5faa\u73af\u7b49\u5f85\n        if (!exists_log) { // \u9996\u5148\u5224\u65ad\u662f\u5426\u5b58\u5728\u65e5\u5fd7\uff0c\u4e0d\u5b58\u5728\u5c31\u4f11\u7720\u7b49\u5f85\u5524\u9192\n            (void)cm_event_timedwait(&g_apply_cond, CM_SLEEP_500_FIXED);\n        }\n        LOG_TRACE(g_rep_tracekey, "apply_thread work");\n        exists_log = CM_FALSE;\n        for (uint32 i = 0; i < stream_count; i++) { // \u904d\u5386\u6bcf\u4e00\u6761\u6d41\n            uint32 stream_id = streams[i];\n            bool8 stream_exists_log = CM_FALSE;\n            LOG_TIME_BEGIN(rep_apply_proc);\n            // \u6267\u884capply\n            if (rep_apply_proc(stream_id, &stream_exists_log) != CM_SUCCESS) {\n                LOG_DEBUG_ERR_EX("[REP]rep_apply_proc failed.");\n            }\n            LOG_TIME_END(rep_apply_proc);\n\n            exists_log = (exists_log || stream_exists_log);\n        }\n    }\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u5176\u4e2d\u7b49\u5f85\u7684\u6761\u4ef6\u53d8\u91cf\u4e3a\uff0c\u5728\u5982\u4e0b\u7684\u5730\u65b9\u5524\u9192\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'void rep_apply_trigger()\n{\n  LOG_DEBUG_INF("[REP]rep_apply_trigger");\n  LOG_TRACE(g_rep_tracekey, "common:rep_apply_trigger.");\n  cm_event_notify(&g_apply_cond);\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"rep_apply_trigger\u7684\u8c03\u7528\u6808\u5982\u4e0b;"}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TB\n\nrep_acceptlog_proc--\x3erep_leader_acceptlog_proc--\x3e\nrep_try_commit_log--\x3e|leader|rep_apply_trigger\nrep_accept_thread_entry--\x3erep_acceptlog_proc--\x3e\nrep_follower_acceptlog_proc--\x3e|follower|rep_apply_trigger"}),"\n",(0,t.jsx)(n.p,{children:"\u7ecf\u8fc7\u4e0a\u9762\u8c03\u7528\u6d41\u7a0b\u53ef\u4ee5\u770b\u5230\uff0capply\u7ebf\u7a0b\u662f\u7531accept\u7ebf\u7a0b\u5524\u9192\u7684\u3002accept\u7ebf\u7a0b\u4e0eapply\u7ebf\u7a0b\u7c7b\u4f3c\uff0c\u540c\u6837\u662f\u7b49\u5f85\u6761\u4ef6\u53d8\u91cf\u5c06\u7ebf\u7a0b\u5524\u9192\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'if (md_get_stream_list(streams, &stream_count) != CM_SUCCESS) {\n        LOG_DEBUG_ERR("[REP]md_get_stream_list failed");\n        return;\n    }\n\n    while (!thread->closed) {\n        if (!exists_log) {\n            LOG_TRACE(g_rep_tracekey, "accept_thread wait.");\n            (void)cm_event_timedwait(&g_accept_cond, CM_SLEEP_500_FIXED);\n        }\n        LOG_TRACE(g_rep_tracekey, "accept_thread work.");\n\n        exists_log = CM_FALSE;\n        for (uint32 i = 0; i < stream_count; i++) {\n            uint32 stream_id = streams[i];\n            date_t now = g_timer()->now;\n            exists_log = (exists_log || g_common_state[stream_id].accept_log);\n            if (g_common_state[stream_id].accept_log ||\n                now - g_common_state[stream_id].last_accept_time > CM_DEFAULT_HB_INTERVAL*MICROSECS_PER_MILLISEC) {\n                LOG_TRACE(g_rep_tracekey, "accept_thread do work.");\n                g_common_state[stream_id].accept_log = CM_FALSE;\n                g_common_state[stream_id].last_accept_time = now;\n                if (rep_acceptlog_proc(stream_id) != CM_SUCCESS) {\n                    LOG_DEBUG_ERR("[REP]rep_acceptlog_proc failed.");\n                }\n            } else {\n                LOG_TRACE(g_rep_tracekey, "accept_thread no work.");\n            }\n        }\n    }\n'})}),"\n",(0,t.jsx)(n.p,{children:"accept\u7ebf\u7a0b\u7b49\u5f85\u7684\u6761\u4ef6\u53d8\u91cf\u4e3ag_accept_cond\uff0c\u5176\u5524\u9192\u6d41\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'void rep_set_accept_flag(uint32 stream_id)\n{\n    LOG_DEBUG_INF("rep_set_accept_flag.");\n    g_common_state[stream_id].accept_log = CM_TRUE;\n    cm_event_notify(&g_accept_cond);\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"rep_set_accept_flag\u8c03\u7528\u5806\u6808\u5982\u4e0b\uff1a"}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TB\nstg_register_cb--\x3erep_accepted_trigger"}),"\n",(0,t.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5df2\u770b\u5230accept\u7ebf\u7a0b\u7684\u5524\u9192\u662f\u901a\u8fc7\u6ce8\u518c\u56de\u8c03\u51fd\u6570\u6765\u89e6\u53d1\u7684\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'\xa0\xa0\xa0\xa0if (stg_register_cb(ENTRY_TYPE_LOG, rep_accepted_trigger) != CM_SUCCESS) {\n        LOG_DEBUG_ERR("[REP]rep register stg callback failed");\n        return CM_ERROR;\n    }\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'status_t stg_register_cb(entry_type_t type, void *func)\n{\n    switch (type) {\n        case ENTRY_TYPE_CONF:\n            g_write_conf_func = (write_conf_func_t)func;\n            break;\n        case ENTRY_TYPE_LOG:\n            g_notify_rep_func = (notify_rep_func_t)func;\n            break;\n        default:\n            LOG_RUN_ERR("[STG]Register callback failed");\n            return CM_ERROR;\n    }\n    return CM_SUCCESS;\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\u56de\u8c03\u51fd\u6570\u6700\u7ec8\u88ab\u6ce8\u518c\u5230\u4e86g_notify_rep_func\u3002"}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TB\ndisk_thread_entry--\x3e|append\u7ebf\u7a0b|process_append_action--\x3estream_append_entry_impl\n--\x3ecallback_rep_func--\x3eg_notify_rep_func\nstream_batcher_flush--\x3ecallback_rep_func"}),"\n",(0,t.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u4e00\u4e2a\u56de\u8c03\u51fd\u6570\u662f\u7531append\u7ebf\u7a0b\u89e6\u53d1\u7684\uff0cappend\u7ebf\u7a0b\u4f1a\u7b49\u5f85stream->disk_event\u6761\u4ef6\u53d8\u91cf\u88ab\u5524\u9192\u3002stream->disk_event\u5728stream_append_entry\u4e2d\u88ab\u5524\u9192\u3002"}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TB\nrep_appendlog_req_proc--\x3erep_follower_process\n--\x3erep_follower_appendlog--\x3estg_append_entry\n--\x3estream_append_entry\nrep_write--\x3estg_append_entry"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"register_msg_process(MEC_CMD_APPEND_LOG_RPC_REQ, rep_appendlog_req_proc, PRIV_LOW);\n"})}),"\n",(0,t.jsx)(n.p,{children:"MEC_CMD_APPEND_LOG_RPC_REQ\u5728rep_appendlog_node\u4e2d\u53d1\u9001\u3002"}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TB\nrep_appendlog_thread_entry--\x3erep_appendlog_stream--\x3erep_appendlog_node"}),"\n",(0,t.jsx)(n.p,{children:"rep_appendlog_thread_entry\u6709\u6761\u4ef6\u53d8\u91cfg_appendlog_cond\u5524\u9192\u3002g_appendlog_cond\u53c8\u901a\u8fc7rep_appendlog_trigger\u5524\u9192\u3002"}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TB\nrep_write--\x3erep_appendlog_trigger\nrep_appendlog_ack_proc--\x3erep_appendlog_trigger\nrep_rematch_proc--\x3erep_appendlog_trigger\n"}),"\n",(0,t.jsx)(n.p,{children:"rep_appendlog_trigger\u7531MEC_CMD_APPEND_LOG_RPC_ACK\u6d88\u606f\u89e6\u53d1\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"register_msg_process(MEC_CMD_APPEND_LOG_RPC_ACK, rep_appendlog_ack_proc, PRIV_LOW);\n"})}),"\n",(0,t.jsx)(n.p,{children:"dd"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:(0,t.jsx)(n.strong,{children:"dcf_register_consensus_notify"})})}),"\n",(0,t.jsx)(n.p,{children:"\u7528\u4e8e\u6ce8\u518cfollower\u8282\u70b9\u5199\u5165\u6570\u636e\u6210\u529f\u7684\u56de\u8c03\u51fd\u6570\u3002"}),"\n"]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);