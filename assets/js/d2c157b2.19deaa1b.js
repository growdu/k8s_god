"use strict";(self.webpackChunkk_8_s_god=self.webpackChunkk_8_s_god||[]).push([[1309],{28453:(e,n,l)=>{l.d(n,{R:()=>s,x:()=>t});var r=l(96540);const i={},a=r.createContext(i);function s(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(a.Provider,{value:n},e.children)}},51906:(e,n,l)=>{l.r(n),l.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>p,frontMatter:()=>s,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"pgsql/replication/pg_replication_keepalive","title":"\u6d41\u590d\u5236\u5fc3\u8df3\u8d85\u65f6\u95ee\u9898","description":"\u57fa\u672c\u6982\u5ff5","source":"@site/docs/pgsql/replication/pg_replication_keepalive.md","sourceDirName":"pgsql/replication","slug":"/pgsql/replication/pg_replication_keepalive","permalink":"/blog/docs/pgsql/replication/pg_replication_keepalive","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/pgsql/replication/pg_replication_keepalive.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"pg_logical_decode","permalink":"/blog/docs/pgsql/replication/pg_logic_decode"},"next":{"title":"pg_slot","permalink":"/blog/docs/pgsql/replication/pg_slot"}}');var i=l(74848),a=l(28453);const s={},t="\u6d41\u590d\u5236\u5fc3\u8df3\u8d85\u65f6\u95ee\u9898",c={},d=[{value:"\u57fa\u672c\u6982\u5ff5",id:"\u57fa\u672c\u6982\u5ff5",level:2},{value:"\u95ee\u9898\u73b0\u8c61",id:"\u95ee\u9898\u73b0\u8c61",level:2},{value:"\u539f\u56e0\u5206\u6790",id:"\u539f\u56e0\u5206\u6790",level:3},{value:"\u671f\u671b\u8868\u73b0",id:"\u671f\u671b\u8868\u73b0",level:3},{value:"keepalive\u673a\u5236\u5206\u6790",id:"keepalive\u673a\u5236\u5206\u6790",level:2},{value:"walsender\u5fc3\u8df3\u53d1\u9001\u673a\u5236",id:"walsender\u5fc3\u8df3\u53d1\u9001\u673a\u5236",level:3},{value:"walreceiver\u5fc3\u8df3\u53d1\u9001\u673a\u5236",id:"walreceiver\u5fc3\u8df3\u53d1\u9001\u673a\u5236",level:3},{value:"walreceiver\u62a5\u6587\u63a5\u6536\u56de\u590d\u53ca\u5176\u5b9e\u73b0",id:"walreceiver\u62a5\u6587\u63a5\u6536\u56de\u590d\u53ca\u5176\u5b9e\u73b0",level:3}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"\u6d41\u590d\u5236\u5fc3\u8df3\u8d85\u65f6\u95ee\u9898",children:"\u6d41\u590d\u5236\u5fc3\u8df3\u8d85\u65f6\u95ee\u9898"})}),"\n",(0,i.jsx)(n.h2,{id:"\u57fa\u672c\u6982\u5ff5",children:"\u57fa\u672c\u6982\u5ff5"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"walsender \u4e3b\u5e93\u6570\u636e\u53d1\u9001\u8fdb\u7a0b"}),"\n",(0,i.jsx)(n.li,{children:"walreceiver \u5907\u5e93\u6570\u636e\u63a5\u6536\u8fdb\u7a0b"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u95ee\u9898\u73b0\u8c61",children:"\u95ee\u9898\u73b0\u8c61"}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u5f53\u524d\u6d41\u590d\u5236\u8fc7\u7a0b\u4e2d\uff0c\u5f53walreceiver\u8fdb\u7a0b\u5728\u6536\u5230\u5927\u91cf\u6570\u636e\u62a5\u6587\u65f6\u4f1a\u51fa\u73b0walsender\u56e0keepalive\u5fc3\u8df3\u62a5\u6587\u8d85\u65f6\u800c\u5bfc\u81f4\u6d41\u590d\u5236\u65ad\u5f00\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"\u539f\u56e0\u5206\u6790",children:"\u539f\u56e0\u5206\u6790"}),"\n",(0,i.jsx)(n.p,{children:"\u5f53\u6570\u636e\u62a5\u6587\u8f83\u591a\u65f6\uff0cwalreceiver\u53ef\u80fd\u56e0\u6536\u5305\u6216\u5199\u5165\u65f6\u95f4\u8fc7\u957f\u800c\u5bfc\u81f4\u56de\u590dkeepalive\u62a5\u6587\u4e0d\u53ca\u65f6\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"\u671f\u671b\u8868\u73b0",children:"\u671f\u671b\u8868\u73b0"}),"\n",(0,i.jsx)(n.p,{children:"\u5f53\u6570\u636e\u62a5\u6587\u8f83\u591a\uff0cwalreceiver\u5361\u5728\u5904\u7406\u6570\u636e\u62a5\u6587\u65f6\uff0c\u4ecd\u7136\u80fd\u56de\u590d\u5fc3\u8df3\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"keepalive\u673a\u5236\u5206\u6790",children:"keepalive\u673a\u5236\u5206\u6790"}),"\n",(0,i.jsx)(n.p,{children:"\u6d41\u590d\u5236\u7684\u5927\u81f4\u6d41\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u4e3b\u5e93\u542f\u52a8\uff0c\u4e3b\u5e93\u76d1\u542c\u76f8\u5e94\u7684\u7aef\u53e3\uff0c\u5e76\u7b49\u5f85\u5907\u5e93\u7684\u8fde\u63a5\uff1b"}),"\n",(0,i.jsx)(n.li,{children:"\u5907\u5e93\u542f\u52a8\uff0c\u5e76\u4e0e\u4e3b\u5e93\u76d1\u542c\u7684\u7aef\u53e3\u5efa\u7acbtcp\u8fde\u63a5\uff0c\u4e0e\u4e3b\u5e93\u540c\u6b65wal\u65e5\u5fd7\u72b6\u6001\uff0c\u5e76\u53d1\u9001\u6d41\u590d\u5236\u8bf7\u6c42\uff1b"}),"\n",(0,i.jsx)(n.li,{children:"\u4e3b\u5907\u5e93\u5efa\u7acb\u8fde\u63a5\u540e\u4fbf\u5f00\u59cb\u6570\u636e\u4f20\u8f93\uff0c\u5728\u6570\u636e\u4f20\u8f93\u7684\u540c\u65f6\uff0c\u4e3b\u5e93\u4f1a\u5b9a\u65f6\u53d1\u9001keepalive\u6765\u68c0\u67e5\u5907\u5e93\u7684\u72b6\u6001\uff0c\u5907\u5e93\u6536\u5230keepalive\u62a5\u6587\u540e\u9700\u8fdb\u884c\u56de\u590d\uff1b\u4e3b\u5e93\u5728\u8d85\u65f6\u65f6\u95f4\u5185\u6536\u5230keepalive\u7684\u56de\u590d\u540e\u4f1a\u91cd\u65b0\u8ba1\u7b97\u4e0b\u4e00\u6b21\u5fc3\u8df3\u62a5\u6587\u7684\u53d1\u9001\u65f6\u95f4\uff0c\u82e5\u4e3b\u5e93\u672a\u5728\u8d85\u65f6\u65f6\u95f4\u5185\u6536\u5230keepalive\u56de\u590d\u62a5\u6587\u5219\u8ba4\u4e3a\u5907\u5e93\u5904\u7406\u8d85\u65f6\uff0c\u4f1a\u8fdb\u884c\u62c6\u94fe\uff1b"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"walsender\u5fc3\u8df3\u53d1\u9001\u673a\u5236",children:"walsender\u5fc3\u8df3\u53d1\u9001\u673a\u5236"}),"\n",(0,i.jsx)(n.p,{children:"walsender\u901a\u8fc7wal_sender_timeout\u786e\u8ba4keepalive\u8d85\u65f6\u65f6\u95f4\uff0c\u9ed8\u8ba4\u4e3a60s\u3002\u5176\u751f\u6548\u673a\u5236\u5982\u4e0b\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u82e5\u6536\u5230walreceiver\u56de\u590d\u7684\u62a5\u6587\uff0c\u4e0d\u8bba\u662fkeepalive\u62a5\u6587\u8fd8\u662f\u6570\u636e\u6587\u672c\uff0c\u5747\u4f1a\u66f4\u65b0last_reply_time;"}),"\n",(0,i.jsx)(n.li,{children:"\u5f53last_reply_time\u4e0e\u5f53\u524d\u65f6\u95f4\u95f4\u9694\u8fbe\u5230wal_sender_timeout\u7684\u4e00\u534a\u65f6\uff08\u9ed8\u8ba4\u4e3a30s\uff09\uff0cwalsender\u4f1a\u53d1\u9001keepalive\u62a5\u6587\uff1b"}),"\n",(0,i.jsx)(n.li,{children:"\u5f53last_reply_time\u4e0e\u5f53\u524d\u65f6\u95f4\u95f4\u9694\u8fbe\u5230wal_sender_timeout\u503c\u65f6\uff0cwalsender\u8ba4\u4e3awalreceiver\u5904\u7406\u8d85\u65f6\uff0c\u5c06\u4f1a\u65ad\u5f00\u6d41\u590d\u5236\uff1b"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"walreceiver\u5fc3\u8df3\u53d1\u9001\u673a\u5236",children:"walreceiver\u5fc3\u8df3\u53d1\u9001\u673a\u5236"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"\u6536\u5230\u5fc3\u8df3\u62a5\u6587"}),"\n",(0,i.jsx)(n.p,{children:"walreceiver\u6536\u5230\u5fc3\u8df3\u62a5\u6587\u540e\uff0c\u4f1a\u7acb\u9a6c\u56de\u590d\u5fc3\u8df3\u62a5\u6587\uff0c\u4e14\u4e0d\u5b58\u5728\u5199\u5165\u64cd\u4f5c\u3002"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"\u6536\u5230\u6570\u636e\u62a5\u6587"}),"\n",(0,i.jsx)(n.p,{children:"walreceiver\u6536\u5230\u6570\u636e\u62a5\u6587\u540e\uff0c\u4f1a\u5728\u5c06socket\u7684buffer\u7f13\u51b2\u533a\u5185\u7684\u6570\u636e\u63a5\u6536\u5904\u7406\u5b8c\u6210\u540e\u56de\u590dreply\u62a5\u6587\uff0cwlasender\u6536\u5230\u8fd9\u79cd\u62a5\u6587\u56de\u590d\u540e\u540c\u6837\u53ef\u4ee5\u91cd\u7f6ewalsender\u7684last_reply_time;"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"\u4e3b\u52a8\u53d1\u9001reply\u62a5\u6587"}),"\n",(0,i.jsx)(n.p,{children:"\u5f53walreceiver\u5728wal_receiver_timeout/2\u65f6\u95f4\u5185\u6ca1\u6709\u6536\u5230walsender\u7684\u5fc3\u8df3\u62a5\u6587\u6216\u8005\u6570\u636e\u62a5\u6587\uff0cwalreceiver\u4e5f\u4f1a\u4e3b\u52a8\u53d1\u9001reply\u62a5\u6587\uff0c\u5e76\u9700\u8981walsender\u56de\u590d\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u540c\u6837\u7684walreceiver\u5728wal_receiver_timeout\u65f6\u95f4\u5185\u6ca1\u6709\u6536\u5230walsender\u7684\u5fc3\u8df3\u62a5\u6587\u6216\u8005\u6570\u636e\u62a5\u6587\uff0cwalreceiver\u4f1a\u8ba4\u4e3awalsender\u8d85\u65f6\u800c\u65ad\u5f00\u8fde\u63a5\u3002"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"walreceiver\u62a5\u6587\u63a5\u6536\u56de\u590d\u53ca\u5176\u5b9e\u73b0",children:"walreceiver\u62a5\u6587\u63a5\u6536\u56de\u590d\u53ca\u5176\u5b9e\u73b0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-c",children:'                /* See if we can read data immediately */\n                len = walrcv_receive(wrconn, &buf, &wait_fd);\n                if (len != 0)\n                {\n                    /*\n                     * Process the received data, and any subsequent data we\n                     * can read without blocking.\n                     */\n                    for (;;)\n                    {\n                        if (len > 0)\n                        {\n                            /*\n                             * Something was received from primary, so reset\n                             * timeout\n                             */\n                            last_recv_timestamp = GetCurrentTimestamp();\n                            ping_sent = false;\n                            XLogWalRcvProcessMsg(buf[0], &buf[1], len - 1,\n                                                 startpointTLI);\n                        }\n                        else if (len == 0)\n                            break;\n                        else if (len < 0)\n                        {\n                            ereport(LOG,\n                                    (errmsg("replication terminated by primary server"),\n                                     errdetail("End of WAL reached on timeline %u at %X/%X.",\n                                               startpointTLI,\n                                               LSN_FORMAT_ARGS(LogstreamResult.Write))));\n                            endofwal = true;\n                            break;\n                        }\n                        len = walrcv_receive(wrconn, &buf, &wait_fd);\n                    }\n\n                    /* Let the primary know that we received some data. */\n                    XLogWalRcvSendReply(false, false);\n\n                    /*\n                     * If we\'ve written some records, flush them to disk and\n                     * let the startup process and primary server know about\n                     * them.\n                     */\n                    XLogWalRcvFlush(false, startpointTLI);\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u200b"})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}}}]);