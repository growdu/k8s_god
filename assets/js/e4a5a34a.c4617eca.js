"use strict";(self.webpackChunkk_8_s_god=self.webpackChunkk_8_s_god||[]).push([[7963],{28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>r});var i=n(96540);const _={},s=i.createContext(_);function o(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(_):e.components||_:o(e.components),i.createElement(s.Provider,{value:t},e.children)}},38148:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>a,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"cluster/corosync/corosync-qnetd\u6295\u7968\u673a\u5236","title":"corosync-qnetd\u6295\u7968\u673a\u5236","description":"| \u4fee\u6539\u4eba | \u4fee\u6539\u5185\u5bb9 | \u4fee\u6539\u65f6\u95f4   |","source":"@site/docs/cluster/corosync/corosync-qnetd\u6295\u7968\u673a\u5236.md","sourceDirName":"cluster/corosync","slug":"/cluster/corosync/corosync-qnetd\u6295\u7968\u673a\u5236","permalink":"/blog/docs/cluster/corosync/corosync-qnetd\u6295\u7968\u673a\u5236","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/cluster/corosync/corosync-qnetd\u6295\u7968\u673a\u5236.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"corosync-qdevice\u8be6\u89e3","permalink":"/blog/docs/cluster/corosync/corosync-qdevice\u8be6\u89e3"},"next":{"title":"corosync\u4f7f\u7528","permalink":"/blog/docs/cluster/corosync/corosync\u4f7f\u7528"}}');var _=n(74848),s=n(28453);const o={},r="corosync-qnetd\u6295\u7968\u673a\u5236",c={},d=[{value:"votequorum",id:"votequorum",level:2},{value:"corosync-qdevice",id:"corosync-qdevice",level:2},{value:"qdevice\u4e3b\u6d41\u7a0b",id:"qdevice\u4e3b\u6d41\u7a0b",level:3},{value:"qdevice\u6295\u7968\u5904\u7406",id:"qdevice\u6295\u7968\u5904\u7406",level:3},{value:"qdevice\u91cd\u8981API",id:"qdevice\u91cd\u8981api",level:3},{value:"corosync-qnetd",id:"corosync-qnetd",level:2},{value:"\u4e3b\u6d41\u7a0b",id:"\u4e3b\u6d41\u7a0b",level:3},{value:"\u63a5\u6536\u6d88\u606f",id:"\u63a5\u6536\u6d88\u606f",level:3},{value:"\u6d88\u606f",id:"\u6d88\u606f",level:3},{value:"lms\u7b97\u6cd5\u6267\u884c\u6d41\u7a0b",id:"lms\u7b97\u6cd5\u6267\u884c\u6d41\u7a0b",level:3}];function l(e){const t={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)(t.header,{children:(0,_.jsx)(t.h1,{id:"corosync-qnetd\u6295\u7968\u673a\u5236",children:"corosync-qnetd\u6295\u7968\u673a\u5236"})}),"\n",(0,_.jsxs)(t.table,{children:[(0,_.jsx)(t.thead,{children:(0,_.jsxs)(t.tr,{children:[(0,_.jsx)(t.th,{children:"\u4fee\u6539\u4eba"}),(0,_.jsx)(t.th,{children:"\u4fee\u6539\u5185\u5bb9"}),(0,_.jsx)(t.th,{children:"\u4fee\u6539\u65f6\u95f4"})]})}),(0,_.jsxs)(t.tbody,{children:[(0,_.jsxs)(t.tr,{children:[(0,_.jsx)(t.td,{children:"\u6bb5\u5e94\u5bff"}),(0,_.jsx)(t.td,{children:"\u65b0\u5efa\u6587\u6863"}),(0,_.jsx)(t.td,{children:"2023-03-14"})]}),(0,_.jsxs)(t.tr,{children:[(0,_.jsx)(t.td,{}),(0,_.jsx)(t.td,{}),(0,_.jsx)(t.td,{})]}),(0,_.jsxs)(t.tr,{children:[(0,_.jsx)(t.td,{}),(0,_.jsx)(t.td,{}),(0,_.jsx)(t.td,{})]})]})]}),"\n",(0,_.jsx)(t.p,{children:"corosync-qnetd\u662fcorosync\u7684\u7b2c\u4e09\u65b9\u4ef2\u88c1\u673a\u5236\uff0c\u5f53corosync\u51fa\u73b0\u7f51\u7edc\u5206\u533a\u65f6\uff0c\u96c6\u7fa4\u5185\u90e8\u65e0\u6cd5\u9009\u62e9\u51faquorate\u4e00\u65b9\u65f6\uff0c\u5c31\u4f1a\u501f\u52a9corosync-qnetd\u6765\u8fdb\u884c\u8f85\u52a9\u6295\u7968\u3002"}),"\n",(0,_.jsxs)(t.ul,{children:["\n",(0,_.jsx)(t.li,{children:"corosync-qnetd\u4f5c\u4e3a\u670d\u52a1\u7aef\uff0c\u4f1a\u6839\u636e\u5404\u5206\u533a\u8fde\u63a5\u5230qnetd\u7684\u5ba2\u6237\u7aef\u6570\u76ee\uff0c\u5b8c\u6210\u542f\u53d1\u5f0f\u7b97\u6cd5\u7684\u5ba2\u6237\u7aef\u6570\u76ee\u7b49\u4fe1\u606f\u6765\u5bf9\u5404\u5206\u533a\u8282\u70b9\u8fdb\u884c\u6295\u7968"}),"\n",(0,_.jsx)(t.li,{children:"corosync-qdevice\u4f5c\u4e3a\u5ba2\u6237\u7aef\u4f1a\u8fde\u63a5\u5230qnetd\uff0c\u540c\u65f6\u5728\u672c\u5730\u4f1a\u6267\u884c\u4e00\u7ec4\u542f\u53d1\u5f0f\u547d\u4ee4\uff0c\u5e76\u5c06\u542f\u53d1\u5f0f\u547d\u4ee4\u6267\u884c\u7ed3\u679c\u53d1\u9001\u5230qnetd"}),"\n",(0,_.jsx)(t.li,{children:"corosync-qnetd\u6839\u636ering id\u6765\u533a\u5206\u4e0d\u540c\u7684\u5206\u533a"}),"\n"]}),"\n",(0,_.jsx)(t.h2,{id:"votequorum",children:"votequorum"}),"\n",(0,_.jsx)(t.p,{children:"corosync\u672c\u8eab\u63d0\u4f9b\u4e86votequorum\u6a21\u5757\u548c\u4e0e\u5176\u914d\u5957\u7684\u63a5\u53e3\uff0c\u652f\u6301\u7528\u6237\u81ea\u5b9a\u4e49\u6295\u7968\u89c4\u5219\uff0c\u5b9e\u73b0\u7b2c\u4e09\u65b9\u6295\u7968\u4ef2\u88c1\u3002corosync-qdevice\u5c31\u662fcorosync\u5b98\u65b9\u5b9e\u73b0\u7684\u4e00\u5957\u7b2c\u4e09\u65b9\u6295\u7968\u4ef2\u88c1\u673a\u5236\u3002"}),"\n",(0,_.jsxs)(t.blockquote,{children:["\n",(0,_.jsx)(t.p,{children:"\u6bcf\u6b21\u6295\u7968\u914d\u7f6e\u5373\u5c06\u6539\u53d8\uff08\u4f8b\u5982\u8282\u70b9\u52a0\u5165\u6216\u79bb\u5f00\u96c6\u7fa4\uff09\u65f6\uff0c\u90fd\u4f1a\u8c03\u7528votequorum_nodelist_notification_fn_t\u56de\u8c03\u3002 \u56de\u8c03\u51fd\u6570\u7531\u4ee5\u4e0b\u7c7b\u578b\u5b9a\u4e49\u63cf\u8ff0\uff1a"}),"\n",(0,_.jsx)(t.pre,{children:(0,_.jsx)(t.code,{className:"language-c",children:"typedef void (*votequorum_nodelist_notification_fn_t) (\n  votequorum_handle_t handle,\n  uint64_t context,\n  uint32_t node_list_entries,\n  uint32_t node_list[]\n  );\n"})}),"\n",(0,_.jsx)(t.p,{children:"\u5f53\u524d\u7684 ring_id\uff08votequorum_quorum_notification_fn_t\u83b7\u53d6\uff09\u5fc5\u987b\u4f20\u9012\u7ed9 votequorum_qdevice_poll \u4ee5\u4f7f qdevice \u6295\u7968\u6709\u6548\u3002"}),"\n",(0,_.jsx)(t.p,{children:"\u6bcf\u6b21\u4ef2\u88c1\u72b6\u6001\u6539\u53d8\uff08\u4f8b\u5982\u8282\u70b9\u52a0\u5165\u6216\u79bb\u5f00\u96c6\u7fa4\uff09\u65f6\uff0c\u90fd\u4f1a\u8c03\u7528votequorum_quorum_notification_fn_t\u56de\u8c03\u3002 \u56de\u8c03\u51fd\u6570\u7531\u4ee5\u4e0b\u7c7b\u578b\u5b9a\u4e49\u63cf\u8ff0\uff1a"}),"\n",(0,_.jsx)(t.pre,{children:(0,_.jsx)(t.code,{className:"language-c",children:"typedef void (*votequorum_quorum_notification_fn_t) (\n  votequorum_handle_t handle,\n  uint64_t context,\n  uint32_t quorate,\n  uint32_t node_list_entries,\n  votequorum_node_t node_list[]\n  );\n"})}),"\n"]}),"\n",(0,_.jsx)(t.h2,{id:"corosync-qdevice",children:"corosync-qdevice"}),"\n",(0,_.jsx)(t.h3,{id:"qdevice\u4e3b\u6d41\u7a0b",children:"qdevice\u4e3b\u6d41\u7a0b"}),"\n",(0,_.jsx)(t.mermaid,{value:"graph TB\nqdevice_advanced_settings_init--\x3ecli_parse--\x3eqdevice_instance_init--\x3eqdevice_heuristics_init--\x3eqdevice_cmap_init--\x3eqdevice_log_init--\x3ea\nb--\x3eqdevice_votequorum_init--\x3eqdevice_ipc_init--\x3eqdevice_model_register_all--\x3eqdevice_instance_configure_from_cmap--\x3eqdevice_votequorum_master_wins"}),"\n",(0,_.jsxs)(t.blockquote,{children:["\n",(0,_.jsx)(t.p,{children:"qdevice_heuristics_init\u4f1afork\u51fa\u4e00\u4e2a\u8fdb\u7a0b\u5728\u672c\u673a\u6765\u6267\u884c\u542f\u53d1\u5f0f\u547d\u4ee4\uff0c\u5f53\u6240\u6709\u542f\u53d1\u5f0f\u547d\u4ee4\u5747\u6267\u884c\u6210\u529f\u540e\uff0c\u4f1a\u5c06\u7ed3\u679c\u53d1\u9001\u7ed9qnetd\uff0c\u5e2e\u52a9qnetd\u8fdb\u884c\u6295\u7968\u51b3\u7b56\u3002"}),"\n"]}),"\n",(0,_.jsx)(t.h3,{id:"qdevice\u6295\u7968\u5904\u7406",children:"qdevice\u6295\u7968\u5904\u7406"}),"\n",(0,_.jsxs)(t.blockquote,{children:["\n",(0,_.jsx)(t.p,{children:"qdevice\u901a\u8fc7net\u6a21\u5757\u548cqnetd\u901a\u4fe1\uff0c\u5e76\u6839\u636eqnetd\u8fd4\u56de\u7684\u6295\u7968\u7ed3\u679c\uff0c\u6765\u901a\u77e5\u672c\u673a\u5668\u8282\u70b9\u662f\u5426\u80fd\u83b7\u5f97qnetd\u7684\u6295\u7968\u3002"}),"\n"]}),"\n",(0,_.jsx)(t.mermaid,{value:"graph TB\nqdevice_model_net_init--\x3eqdevice_net_cast_vote_timer_update--\x3eqdevice_net_cast_vote_timer_callback--\x3eqdevice_votequorum_poll"}),"\n",(0,_.jsx)(t.p,{children:"qdevice\u83b7\u53d6\u5230qnet\u7684\u6295\u7968\u540e\u4f1a\u8fdb\u884c\u5982\u4e0b\u5904\u7406\u903b\u8f91\uff1a"}),"\n",(0,_.jsx)(t.pre,{children:(0,_.jsx)(t.code,{className:"language-c",children:'\tswitch (instance->cast_vote_timer_vote) {\n\tcase TLV_VOTE_ACK: // \u83b7\u53d6\u5230\u4e86qnetd\u7684\u6295\u7968\n\t\tcase_processed = 1;\n\t\tcast_vote = 1;\n\t\tbreak;\n\tcase TLV_VOTE_NACK: // \u6ca1\u6709\u83b7\u53d6\u5230qnetd\u7684\u6295\u7968\n\t\tcase_processed = 1;\n\t\tcast_vote = 0;\n\t\tbreak;\n\tcase TLV_VOTE_ASK_LATER:\n\tcase TLV_VOTE_WAIT_FOR_REPLY:\n\tcase TLV_VOTE_NO_CHANGE:\n\tcase TLV_VOTE_UNDEFINED:\n\t\t/*\n\t\t * Shouldn\'t happen\n\t\t */\n\t\tbreak;\n\t/*\n\t * Default is not defined intentionally. Compiler shows warning when\n\t * new tlv_vote is added.\n\t */\n\t}\n\tif (!case_processed) { // \u5982\u679c\u6ca1\u6709\u83b7\u53d6\u6b63\u786e\u7684\u6295\u7968\u7ed3\u679c\uff0c\u76f4\u63a5\u8fd4\u56de\n\t\tlog(LOG_CRIT, "qdevice_net_timer_cast_vote: Unhandled cast_vote_timer_vote %u",\n\t\t    instance->cast_vote_timer_vote);\n\t\texit(EXIT_FAILURE);\n\t}\n\t// \u5c06\u6295\u7968\u4fe1\u606f\u4f20\u5230corosync\uff0c\u5982\u679ccast_vote\u4e3a1\uff0c\u5219\u4f1a\u628aqdevice\u7684vote\u8ba1\u7b97\u5728\u5185\uff0c\u5426\u5219\u4e0d\u4f1a\u5305\u542bqdevice\u7684vote\n\tif (qdevice_votequorum_poll(instance->qdevice_instance_ptr, cast_vote) != 0) { \n\t\tinstance->disconnect_reason = QDEVICE_NET_DISCONNECT_REASON_CANT_SCHEDULE_VOTING_TIMER;\n\t\tinstance->schedule_disconnect = 1;\n\t\tinstance->cast_vote_timer = NULL;\n\t\treturn (0);\n\t}\n'})}),"\n",(0,_.jsx)(t.h3,{id:"qdevice\u91cd\u8981api",children:"qdevice\u91cd\u8981API"}),"\n",(0,_.jsxs)(t.blockquote,{children:["\n",(0,_.jsx)(t.p,{children:"votequorum_qdevice_register \u7528\u4e8e\u6ce8\u518c\u4e00\u4e2a\u65b0\u7684\u4ef2\u88c1\u8bbe\u5907\u3002 \u4ef2\u88c1\u8bbe\u5907\u662f\u5411\u5c0f\u578b\u96c6\u7fa4\u6dfb\u52a0\u6295\u7968\u7684\u5916\u90e8\u65b9\u5f0f\u3002 \u4ef2\u88c1\u8bbe\u5907\u5b9e\u9645\u4e0a\u662f\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e2a\u4f2a\u8282\u70b9\uff0c\u5b83\u6839\u636e\u4e00\u4e9b\u5916\u90e8\u8bbe\u5907\uff08\u901a\u5e38\u662f\u5171\u4eab\u78c1\u76d8\u5206\u533a\u6216\u7f51\u7edc\u8def\u7531\u5668\uff09\u63d0\u4f9b\u6295\u7968\u3002\n\u6b64\u8c03\u7528\u4f1a\u521b\u5efa\u8bbe\u5907\uff0c\u4f46\u4e0d\u4f1a\u5c06\u5176\u6807\u8bb0\u4e3a\u6d3b\u52a8\u7684\u3002 \u5fc5\u987b\u8c03\u7528 votequorum_qdevice_poll \u624d\u80fd\u5c06\u9009\u7968\u5305\u542b\u5728\u6cd5\u5b9a\u4eba\u6570\u8ba1\u7b97\u4e2d\u3002\nname \u662f\u5305\u542b\u4ef2\u88c1\u8bbe\u5907\u4fe1\u606f\u540d\u79f0\u7684\u5b57\u7b26\u4e32\u3002 \u5b83\u662f\u7b80\u5355\u7684\u7531 votequorum \u5b58\u50a8\uff0c\u7528\u4e8e corosync-quorumtool \u7684\u663e\u793a\uff0c\u6700\u591a\u53ef\u4ee5\u662f 254 \u4e2a\u5b57\u7b26\u3002\n\u4ef2\u88c1\u8bbe\u5907\u8d21\u732e\u7684\u7968\u6570\u5bf9\u4e8e votequorum \u662f\u5df2\u77e5\u7684\uff0c\u5b83\u662f\u5728 cmap quorum.device.votes \u4e2d\u8bbe\u7f6e\u7684\uff0c\u800c\u4e0d\u662f\u7531\u8bbe\u5907\u8bbe\u7f6e\u7684\u3002\n\u8bf7\u6ce8\u610f\uff0c\u4ef2\u88c1\u8bbe\u5907\u5b50\u7cfb\u7edf\uff08\u672a\u4f5c\u4e3a votequorum \u7684\u4e00\u90e8\u5206\u63d0\u4f9b\uff09\u8d1f\u8d23\u8ba9\u6240\u6709\u8282\u70b9\u4e86\u89e3\u4ef2\u88c1\u8bbe\u5907\u72b6\u6001\u3002"}),"\n"]}),"\n",(0,_.jsx)(t.pre,{children:(0,_.jsx)(t.code,{className:"language-c",children:"#include <corosync/votequorum.h>\nint votequorum_qdevice_register(votequorum_handle_t handle, const char * name);\n"})}),"\n",(0,_.jsxs)(t.blockquote,{children:["\n",(0,_.jsx)(t.p,{children:"votequorum_qdevice_poll \u7531\u4ef2\u88c1\u8bbe\u5907\u5b50\u7cfb\u7edf\uff08\u672a\u4f5c\u4e3a votequorum \u7684\u4e00\u90e8\u5206\u63d0\u4f9b\uff09\u8c03\u7528\uff0c\u4ee5\u544a\u77e5\u6295\u7968\u7cfb\u7edf\u4ef2\u88c1\u8bbe\u5907\u662f\u5426\u5b58\u5728/\u6d3b\u52a8\u3002 \u5982\u679c cast_vote \u4e3a 1\uff0c\u5219\u8bbe\u5907\u7684\u6295\u7968\u5305\u542b\u5728\u4ef2\u88c1\u8ba1\u7b97\u4e2d\uff0c\u5426\u5219\u4e0d\u5305\u542b\u3002 \u5f53\u524d\u7684 ring_id \u5fc5\u987b\u8bbe\u7f6e\uff08votequorum_notification_fn \u56de\u8c03\u88ab\u8c03\u7528\u65f6\u83b7\u53d6\uff09\u5426\u5219\u8f6e\u8be2\u88ab\u5ffd\u7565\u3002 \u5e94\u5b9a\u671f\u8c03\u7528\u6b64\u4f8b\u7a0b\uff0c\u4ee5\u786e\u4fdd\u8bbe\u5907\u72b6\u6001\u59cb\u7ec8\u4e3a votequorum \u6240\u77e5\u3002 \u5982\u679c\u5728\uff08\u9ed8\u8ba4\uff0910 \u79d2\uff08\u6216\u540c\u6b65\u9636\u6bb5\u4e3a 30 \u79d2\uff09\u5185\u672a\u8c03\u7528 votequorum_qdevice_poll\uff0c\u5219\u8be5\u8bbe\u5907\u5c06\u88ab\u89c6\u4e3a\u5df2\u6b7b\uff0c\u5e76\u5c06\u5176\u6295\u7968\u4ece\u96c6\u7fa4\u4e2d\u5220\u9664\u3002 \u8fd9\u4e0d\u4f1a\u53d6\u6d88\u6ce8\u518c\u8bbe\u5907\u3002 \u9ed8\u8ba4\u8f6e\u8be2\u65f6\u95f4\u53ef\u4ee5\u901a\u8fc7\u4e3a\u6b63\u5e38\u64cd\u4f5c\u8bbe\u7f6e cmap \u53d8\u91cf quorum.device.timeout \u6216\u4e3a\u540c\u6b65\u9636\u6bb5\u8bbe\u7f6e quorum.device.sync_timeout \u6765\u66f4\u6539\u3002"}),"\n"]}),"\n",(0,_.jsx)(t.pre,{children:(0,_.jsx)(t.code,{className:"language-c",children:"#include <corosync/votequorum.h>\nint votequorum_qdevice_poll(votequorum_handle_t handle, const char * name, unsigned int cast_vote, votequorum_ring_id_t ring_id);\n"})}),"\n",(0,_.jsx)(t.h2,{id:"corosync-qnetd",children:"corosync-qnetd"}),"\n",(0,_.jsx)(t.h3,{id:"\u4e3b\u6d41\u7a0b",children:"\u4e3b\u6d41\u7a0b"}),"\n",(0,_.jsx)(t.mermaid,{value:"graph TB\nqnetd_advanced_settings_init--\x3ecli_parse--\x3eqnetd_instance_init--\x3ePR_Listen--\x3eqnetd_algorithm_register_all--\x3eqnetd_run_main_loop"}),"\n",(0,_.jsx)(t.h3,{id:"\u63a5\u6536\u6d88\u606f",children:"\u63a5\u6536\u6d88\u606f"}),"\n",(0,_.jsx)(t.mermaid,{value:"graph TB\nqnetd_client_net_socket_poll_loop_read_cb--\x3eqnetd_client_net_read--\x3eqnetd_client_msg_received"}),"\n",(0,_.jsxs)(t.ul,{children:["\n",(0,_.jsxs)(t.li,{children:["\n",(0,_.jsx)(t.p,{children:"\u5904\u7406\u6295\u7968\u8bf7\u6c42\u4fe1\u606f"}),"\n",(0,_.jsx)(t.mermaid,{value:"graph TB\nqnetd_client_msg_received_ask_for_vote--\x3eqnetd_algorithm_ask_for_vote_received--\x3eask_for_vote_received--\x3eqnetd_algo_lms_ask_for_vote_received--\x3edo_lms_algorithm--\x3emsg_create_ask_for_vote_reply"}),"\n",(0,_.jsx)(t.h3,{id:"\u6d88\u606f",children:"\u6d88\u606f"}),"\n",(0,_.jsxs)(t.ul,{children:["\n",(0,_.jsx)(t.li,{children:"\u6d88\u606f\u7c7b\u578b"}),"\n"]}),"\n",(0,_.jsx)(t.pre,{children:(0,_.jsx)(t.code,{className:"language-c",children:"enum msg_type {\n\tMSG_TYPE_PREINIT = 0,\n\tMSG_TYPE_PREINIT_REPLY = 1,\n\tMSG_TYPE_STARTTLS = 2,\n\tMSG_TYPE_INIT = 3,\n\tMSG_TYPE_INIT_REPLY = 4,\n\tMSG_TYPE_SERVER_ERROR = 5,\n\tMSG_TYPE_SET_OPTION = 6,\n\tMSG_TYPE_SET_OPTION_REPLY = 7,\n\tMSG_TYPE_ECHO_REQUEST = 8,\n\tMSG_TYPE_ECHO_REPLY = 9,\n\tMSG_TYPE_NODE_LIST = 10,\n\tMSG_TYPE_NODE_LIST_REPLY = 11,\n\tMSG_TYPE_ASK_FOR_VOTE = 12,\n\tMSG_TYPE_ASK_FOR_VOTE_REPLY = 13,\n\tMSG_TYPE_VOTE_INFO = 14,\n\tMSG_TYPE_VOTE_INFO_REPLY = 15,\n\tMSG_TYPE_HEURISTICS_CHANGE = 16,\n\tMSG_TYPE_HEURISTICS_CHANGE_REPLY = 17,\n};\n"})}),"\n",(0,_.jsxs)(t.ul,{children:["\n",(0,_.jsx)(t.li,{children:"\u6d88\u606f\u683c\u5f0f"}),"\n"]}),"\n",(0,_.jsx)(t.pre,{children:(0,_.jsx)(t.code,{className:"language-c",children:"struct msg_decoded {\n\tenum msg_type type;\n\tuint8_t seq_number_set;\n\tuint32_t seq_number;\t/* Only valid if seq_number_set != 0 */\n\tsize_t cluster_name_len;\n\t/* Valid only if != NULL. Trailing \\0 is added but not counted in cluster_name_len */\n\tchar *cluster_name;\n\tuint8_t tls_supported_set;\n\tenum tlv_tls_supported tls_supported;\t/* Valid only if tls_supported_set != 0. */\n\tuint8_t tls_client_cert_required_set;\n\tuint8_t tls_client_cert_required;\t/* Valid only if tls_client_cert_required_set != 0 */\n\tsize_t no_supported_messages;\n\tenum msg_type *supported_messages;\t/* Valid only if != NULL */\n\tsize_t no_supported_options;\n\tenum tlv_opt_type *supported_options;\t/* Valid only if != NULL */\n\tuint8_t reply_error_code_set;\n\tenum tlv_reply_error_code reply_error_code;\t/* Valid only if reply_error_code_set != 0 */\n\tuint8_t server_maximum_request_size_set;\n\t/* Valid only if server_maximum_request_size_set != 0 */\n\tsize_t server_maximum_request_size;\n\tuint8_t server_maximum_reply_size_set;\n\tsize_t server_maximum_reply_size;\t/* Valid only if server_maximum_reply_size_set != 0 */\n\tuint8_t node_id_set;\n\tuint32_t node_id;\n\tsize_t no_supported_decision_algorithms;\n\t/* Valid only if != NULL */\n\tenum tlv_decision_algorithm_type *supported_decision_algorithms;\n\tuint8_t decision_algorithm_set;\n\t/* Valid only if decision_algorithm_set != 0 */\n\tenum tlv_decision_algorithm_type decision_algorithm;\n\tuint8_t heartbeat_interval_set;\n\tuint32_t heartbeat_interval;\t/* Valid only if heartbeat_interval_set != 0 */\n\tuint8_t ring_id_set;\n\tstruct tlv_ring_id ring_id;\t/* Valid only if ring_id_set != 0 */\n\tuint8_t config_version_set;\n\tuint64_t config_version;\t/* Valid only if config_version_set != 0 */\n\tuint32_t data_center_id;\t/* Valid only if != 0 */\n\tenum tlv_node_state node_state;\t/* Valid only if != TLV_NODE_STATE_NOT_SET */\n\tstruct node_list nodes;\t\t/* Valid only if node_list_is_empty(nodes) != 0 */\n\tuint8_t node_list_type_set;\n\tenum tlv_node_list_type node_list_type;\t/* Valid only if node_list_type_set != 0 */\n\tuint8_t vote_set;\n\tenum tlv_vote vote;\t/* Valid only if vote_set != 0 */\n\tuint8_t quorate_set;\n\tenum tlv_quorate quorate;\t/* Valid only if quorate_set != 0 */\n\tuint8_t tie_breaker_set;\n\tstruct tlv_tie_breaker tie_breaker;\n\tenum tlv_heuristics heuristics;\t/* Always valid but can be TLV_HEURISTICS_UNDEFINED */\n\tenum tlv_keep_active_partition_tie_breaker keep_active_partition_tie_breaker;\n\tuint8_t keep_active_partition_tie_breaker_set;\n};\n"})}),"\n",(0,_.jsx)(t.h3,{id:"lms\u7b97\u6cd5\u6267\u884c\u6d41\u7a0b",children:"lms\u7b97\u6cd5\u6267\u884c\u6d41\u7a0b"}),"\n",(0,_.jsx)(t.mermaid,{value:"graph TB\ndo_lms_algorithm--\x3e|\u5c06ring id\u52a0\u5165\u7f13\u5b58\u91cc|qnetd_algo_all_ring_ids_match--\x3e|\u521b\u5efa\u5206\u533a\u5e76\u8ba1\u7b97\u5206\u6570,\u542f\u53d1\u7b97\u6cd5\u901a\u8fc7\u5206\u6570\u52a01,\u8282\u70b9\u4e2a\u6570\u589e\u52a0\u5206\u6570\u52a01,\u540c\u65f6\u8fd4\u56de\u5206\u533a\u4e2a\u6570|qnetd_algo_create_partitions--\x3eqnetd_algo_dump_partitions"}),"\n",(0,_.jsx)(t.pre,{children:(0,_.jsx)(t.code,{className:"language-c",children:"int\nqnetd_algo_create_partitions(struct qnetd_client *client, partitions_list_t *partitions_list, const struct tlv_ring_id *ring_id)\n{\n \tstruct qnetd_client *other_client;\n\tint num_partitions = 0; // \u8ba1\u7b97\u5206\u533a\u6570\u91cf\n\n\tTAILQ_FOREACH(other_client, &client->cluster->client_list, cluster_entries) {\n\t\tstruct qnetd_algo_partition *partition;\n\n\t\tif (other_client->last_ring_id.seq == 0){\n\t\t\tcontinue; /* not initialised yet */\n\t\t}\n\t\tpartition = qnetd_algo_find_partition(partitions_list, &other_client->last_ring_id);\n\t\tif (!partition) { /// \u627e\u4e0d\u5230\u5df2\u7ecf\u5b58\u5728\u7684\u5206\u533a\uff0c\u91cd\u65b0\u5206\u914d\u4e00\u4e2a\u5206\u533a\n\t\t\tpartition = malloc(sizeof(struct qnetd_algo_partition));\n\t\t\tif (!partition) {\n\t\t\t\treturn (-1);\n\t\t\t}\n\t\t\tpartition->num_nodes = 0;\n\t\t\tpartition->score = 0;\n\t\t\tmemcpy(&partition->ring_id, &other_client->last_ring_id, sizeof(*ring_id));\n\t\t\tnum_partitions++;\n\t\t\tTAILQ_INSERT_TAIL(partitions_list, partition, entries);\n\t\t}\n\t\tpartition->num_nodes++; ///< \u5206\u533a\u8282\u70b9\u4e2a\u6570\u52a01\n\n\t\t/*\n\t\t * Score is computer similar way as in the ffsplit algorithm\n\t\t */\n\t\tpartition->score++; /// \u5206\u6570\u52a01\n\t\tif (other_client->last_heuristics == TLV_HEURISTICS_PASS) {/// \u5982\u679c\u542f\u53d1\u7b97\u6cd5\u901a\u8fc7\u4e86\uff0c\u5206\u6570\u52a01\n\t\t\tpartition->score++;\n\t\t} else if (other_client->last_heuristics == TLV_HEURISTICS_FAIL) { ///< \u5982\u679c\u542f\u53d1\u7b97\u6cd5\u6ca1\u6709\u901a\u8fc7\uff0c\u5206\u6570\u51cf1\n\t\t\tpartition->score--;\n\t\t}\n\n\t}\n\n\treturn (num_partitions);\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,_.jsxs)(t.ol,{children:["\n",(0,_.jsx)(t.li,{children:"qnet\u6536\u5230\u67d0\u4e2a\u8282\u70b9MSG_TYPE_ASK_FOR_VOTE\u6d88\u606f\u540e\uff0c\u4f1a\u8ba1\u7b97\u8be5\u8282\u70b9\u662f\u5426\u80fd\u83b7\u53d6\u5230\u6295\u7968\uff1b"}),"\n",(0,_.jsxs)(t.li,{children:["\u5f53\u914d\u7f6elms\u65f6\uff0c\u4f1a\u6839\u636elms\u7b97\u6cd5\u8ba1\u7b97\u6295\u7968\uff1b","\n",(0,_.jsxs)(t.ol,{children:["\n",(0,_.jsx)(t.li,{children:"\u4f1a\u6839\u636e\u8282\u70b9\u7684ring_id(\u7531node_id\u548cseq\u7ec4\u6210)\u63d2\u5165\u8282\u70b9\u4fe1\u606f\u5e76\u521b\u5efa\u5206\u533a\u63d2\u5165\u8282\u70b9\uff1b"}),"\n",(0,_.jsx)(t.li,{children:"\u6bcf\u4e2a\u5206\u533a\u90fd\u4f1a\u6709\u5b83\u7684\u5206\u6570\uff0c\u5206\u533a\u4e2d\u6bcf\u63d2\u5165\u4e00\u4e2a\u8282\u70b9\u5206\u6570\u52a01\uff0c\u542f\u53d1\u7b97\u6cd5\u901a\u8fc7\u5206\u6570\u52a01\uff0c\u542f\u53d1\u7b97\u6cd5\u6267\u884c\u5931\u8d25\u5206\u6570\u51cf1\uff1b"}),"\n",(0,_.jsx)(t.li,{children:"\u5982\u679c\u53ea\u6709\u4e00\u4e2a\u5206\u533a\uff0c\u90a3\u4e48\u8be5\u5206\u533a\u5185\u7684\u6240\u6709\u8282\u70b9\u90fd\u4f1a\u83b7\u5f97\u6295\u7968\uff1b"}),"\n",(0,_.jsx)(t.li,{children:"\u5982\u679c\u6709\u591a\u4e2a\u5206\u533a\uff0c\u5219\u4f1a\u9009\u51fa\u5f97\u5206\u6700\u9ad8\u7684\u90a3\u4e2a\u5206\u533a\uff0c\u8be5\u5206\u533a\u5185\u7684\u6240\u6709\u8282\u70b9\u90fd\u4f1a\u83b7\u5f97\u6295\u7968\uff1b"}),"\n",(0,_.jsx)(t.li,{children:"\u5982\u679c\u6709\u591a\u4e2a\u5206\u533a\u7684\u5206\u6570\u76f8\u540c\uff0c\u5219\u4f1a\u6bd4\u8f83\u5206\u533a\u7684\u8282\u70b9\u4e2a\u6570\uff0c\u5206\u533a\u8282\u70b9\u4e2a\u6570\u591a\u7684\u4f1a\u83b7\u5f97\u6295\u7968\uff1b"}),"\n",(0,_.jsx)(t.li,{children:"\u5982\u679c\u591a\u4e2a\u5206\u533a\u7684\u8282\u70b9\u4e2a\u6570\u4e5f\u76f8\u540c\uff0c\u5219\u4f1a\u9009\u62e9id\u6700\u5c0f\u7684\u90a3\u4e2a\u5206\u533a\uff0c\u8be5\u5206\u533a\u5185\u7684\u8282\u70b9\u90fd\u4f1a\u83b7\u5f97\u6295\u7968\uff1b"}),"\n"]}),"\n"]}),"\n",(0,_.jsx)(t.li,{children:"qnet\u8ba1\u7b97\u5b8c\u6295\u7968\u540e\u4f1a\u5c06\u6295\u7968\u7ed3\u679c\u901a\u8fc7\u7f51\u7edc\u53d1\u9001\u7ed9\u53d1\u8d77MSG_TYPE_ASK_FOR_VOTE\u8bf7\u6c42\u7684\u8282\u70b9\uff1b"}),"\n"]}),"\n",(0,_.jsxs)(t.ul,{children:["\n",(0,_.jsx)(t.li,{children:"\u5bf9\u4e8e\u4e24\u8282\u70b9\u96c6\u7fa4\u6765\u8bf4\uff0c\u82e5\u96c6\u7fa4\u53ea\u6709\u4e00\u4e2a\u5206\u533a\uff0c\u5219\u6240\u6709\u8282\u70b9\u90fd\u4f1a\u83b7\u5f97\u6295\u7968\uff0c\u4e0d\u8bba\u542f\u53d1\u7b97\u6cd5\u662f\u5426\u6267\u884c\u6210\u529f\uff1b"}),"\n",(0,_.jsx)(t.li,{children:"\u5bf9\u4e8e\u4e24\u8282\u70b9\u96c6\u7fa4\u6765\u8bf4\uff0c\u82e5\u8282\u70b9a\u548c\u8282\u70b9b\u76f8\u4e92\u9694\u79bb\uff0c\u4e14\u8282\u70b9a\u6267\u884c\u542f\u53d1\u7b97\u6cd5\u6210\u529f\uff0c\u8282\u70b9b\u6267\u884c\u542f\u53d1\u7b97\u6cd5\u5931\u8d25\uff0c\u5219\u8282\u70b9a\u6240\u5728\u7684\u5206\u533a\u5f972\u5206\uff080+1+1\uff09\uff0c\u8282\u70b9b\u6240\u5728\u7684\u5206\u533a\u5f970\u5206\uff080+1-1\uff09\uff0c\u5f97\u5206\u9ad8\u7684\u8282\u70b9a\u6240\u5728\u7684\u5206\u533a\u5c06\u83b7\u5f97\u6295\u7968\uff1b"}),"\n",(0,_.jsx)(t.li,{children:"\u5bf9\u4e8e\u4e24\u8282\u70b9\u96c6\u7fa4\u6765\u8bf4\uff0c\u82e5\u8282\u70b9a\u548c\u8282\u70b9b\u76f8\u4e92\u9694\u79bb\uff0c\u4e14\u8282\u70b9a\u548c\u8282\u70b9b\u5747\u6267\u884c\u542f\u53d1\u7b97\u6cd5\u6210\u529f\uff0c\u5219\u8282\u70b9a\u6240\u5728\u7684\u5206\u533a\u5f972\u5206\uff080+1+1\uff09\uff0c\u8282\u70b9b\u6240\u5728\u7684\u5206\u533a\u5f972\u5206\uff080+1+1\uff09\uff0c\u6b64\u65f6\u6bd4\u8f83\u8282\u70b9\u4e2a\u6570\uff0c\u4e24\u4e2a\u5206\u533a\u8282\u70b9\u4e2a\u6570\u5747\u4e3a1\uff0c\u9700\u8981\u8fdb\u4e00\u6b65\u6bd4\u8f83\u8282\u70b9a\u548c\u8282\u70b9b\u7684node_id\uff0cnode_id\u5c0f\u7684\u5c06\u83b7\u5f97\u6295\u7968\uff1b"}),"\n"]})]})}function a(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,_.jsx)(t,{...e,children:(0,_.jsx)(l,{...e})}):l(e)}}}]);