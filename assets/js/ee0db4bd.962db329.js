"use strict";(self.webpackChunkk_8_s_god=self.webpackChunkk_8_s_god||[]).push([[1217],{28453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>t});var i=r(96540);const s={},l=i.createContext(s);function a(e){const n=i.useContext(l);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(l.Provider,{value:n},e.children)}},64729:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"pgsql/replication/pg_walreceiver","title":"pg_walreceiver","description":"\u542f\u52a8\u6d41\u7a0b","source":"@site/docs/pgsql/replication/pg_walreceiver.md","sourceDirName":"pgsql/replication","slug":"/pgsql/replication/pg_walreceiver","permalink":"/blog/docs/pgsql/replication/pg_walreceiver","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/pgsql/replication/pg_walreceiver.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"pg_slot","permalink":"/blog/docs/pgsql/replication/pg_slot"},"next":{"title":"pg_walsender","permalink":"/blog/docs/pgsql/replication/pg_walsender"}}');var s=r(74848),l=r(28453);const a={},t="pg_walreceiver",c={},o=[{value:"\u542f\u52a8\u6d41\u7a0b",id:"\u542f\u52a8\u6d41\u7a0b",level:2},{value:"\u542f\u52a8receiver\u8fdb\u7a0b",id:"\u542f\u52a8receiver\u8fdb\u7a0b",level:3},{value:"\u8fde\u63a5\u4e3b\u5e93",id:"\u8fde\u63a5\u4e3b\u5e93",level:3},{value:"wal_receiver\u6574\u4f53\u6d41\u7a0b",id:"wal_receiver\u6574\u4f53\u6d41\u7a0b",level:2},{value:"wal\u6570\u636e\u63a5\u6536\u6d41\u7a0b",id:"wal\u6570\u636e\u63a5\u6536\u6d41\u7a0b",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"pg_walreceiver",children:"pg_walreceiver"})}),"\n",(0,s.jsx)(n.h2,{id:"\u542f\u52a8\u6d41\u7a0b",children:"\u542f\u52a8\u6d41\u7a0b"}),"\n",(0,s.jsx)(n.h3,{id:"\u542f\u52a8receiver\u8fdb\u7a0b",children:"\u542f\u52a8receiver\u8fdb\u7a0b"}),"\n",(0,s.jsx)(n.mermaid,{value:"graph TB\nmain--\x3ePostmasterMain--\x3eStartChildProcess--\x3efork_process--\x3eAuxiliaryProcessMain--\x3eWalReceiverMain"}),"\n",(0,s.jsx)(n.h3,{id:"\u8fde\u63a5\u4e3b\u5e93",children:"\u8fde\u63a5\u4e3b\u5e93"}),"\n",(0,s.jsx)(n.mermaid,{value:"graph TB\nWalReceiverMain--\x3ewalrcv_connect--\x3elibpqrcv_connect"}),"\n",(0,s.jsx)(n.h2,{id:"wal_receiver\u6574\u4f53\u6d41\u7a0b",children:"wal_receiver\u6574\u4f53\u6d41\u7a0b"}),"\n",(0,s.jsxs)(n.p,{children:["wal_receiver\u6574\u4f53\u6d41\u7a0b\u7531\u4e09\u5c42\u5faa\u73af\u7ec4\u6210\uff0c\u7b2c\u4e00\u5c42\u5faa\u73af\u4f7f\u7528launch\u673a\u5236\uff0c\u7b2c\u4e8c\u5c42\u548c\u7b2c\u4e09\u5c42\u5219\u4f7f\u7528",(0,s.jsx)(n.code,{children:"for(;;)"}),"\u5b9e\u73b0\u3002"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u7b2c\u4e00\u5c42\u5faa\u73af\u662fwal_receiver\u8fdb\u7a0b\u7684\u63a7\u5236\u5faa\u73af\uff0c\u8d1f\u8d23\u6302\u8d77\u548c\u76d1\u542csocket\u662f\u5426\u6709\u6570\u636e\u5230\u6765"}),"\n",(0,s.jsx)(n.li,{children:"\u7b2c\u4e8c\u5c42\u5faa\u73af\u662f\u6d41\u590d\u5236\u6d41\u7a0b\uff0c\u4ece\u4e00\u6b21\u6d41\u590d\u5236\u5f00\u59cb\u5230\u6d41\u590d\u5236\u7ed3\u675f\u6216\u6d41\u590d\u5236\u51fa\u73b0\u9519\u8bef"}),"\n",(0,s.jsx)(n.li,{children:"\u7b2c\u4e09\u5c42\u5faa\u73af\u662fwal\u6570\u636e\u548c\u5fc3\u8df3\u6570\u636e\u63a5\u6536\uff0c\u4e0d\u65ad\u7684\u4ecesocket\u7684buffer\u4e2d\u6536\u53d6\u6570\u636e\uff0c\u76f4\u5230buffer\u4e2d\u6ca1\u6709\u6570\u636e"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"wal\u6570\u636e\u63a5\u6536\u6d41\u7a0b",children:"wal\u6570\u636e\u63a5\u6536\u6d41\u7a0b"}),"\n",(0,s.jsx)(n.mermaid,{value:"graph TB\nloop--\x3ewalrcv_receive--\x3eXLogWalRcvProcessMsg--\x3eProcessWalSndrMessage--\x3e|\u6536\u5230wal\u6570\u636e|XLogWalRcvWrite--\x3epg_pwrite--\x3eloop\nProcessWalSndrMessage--\x3e|\u6536\u5230\u5fc3\u8df3|XLogWalRcvSendReply--\x3eloop"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["wal\u6570\u636e\u63a5\u6536\u5728walreceiver\u7684\u7b2c\u4e09\u5c42\u5faa\u73af\uff0c\u901a\u8fc7\u5faa\u73af\u8c03\u7528",(0,s.jsx)(n.code,{children:"walrcv_receive"}),"\u6536\u53d6\u6570\u636e\uff0c\u5f53\u8fd4\u56de\u7684\u6570\u636e\u957f\u5ea6\u5c0f\u4e8e\u7b49\u4e8e0\u65f6\u9000\u51fa\uff1b\u5176\u4e2d\u7b49\u4e8e0\u65f6\u8868\u793a\u6ca1\u6709\u6570\u636e\uff0c\u5c0f\u4e8e0\u8868\u793a\u6536\u5305\u9047\u5230\u9519\u8bef\uff1b"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:'                    for (;;)\n                    {\n                        if (len > 0)\n                        {\n                            /*\n                             * Something was received from primary, so reset\n                             * timeout\n                             */\n                            last_recv_timestamp = GetCurrentTimestamp();\n                            ping_sent = false;\n                            XLogWalRcvProcessMsg(buf[0], &buf[1], len - 1,\n                                                 startpointTLI);\n                        }\n                        else if (len == 0)\n                            break;\n                        else if (len < 0)\n                        {\n                            ereport(LOG,\n                                    (errmsg("replication terminated by primary server"),\n                                     errdetail("End of WAL reached on timeline %u at %X/%X.",\n                                               startpointTLI,\n                                               LSN_FORMAT_ARGS(LogstreamResult.Write))));\n                            endofwal = true;\n                            break;\n                        }\n                        len = walrcv_receive(wrconn, &buf, &wait_fd);\n                    }\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"\u5f53\u6536\u5230\u6570\u636e\u540e\uff0c\u4f1a\u6839\u636e\u62a5\u6587\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u533a\u5206wal\u6570\u636e\u548c\u5fc3\u8df3\uff0c\u5e76\u8fdb\u884c\u533a\u522b\u5904\u7406\uff1b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:'    switch (type)\n    {\n        case \'w\':                /* WAL records */\n            {\n                /* copy message to StringInfo */\n                hdrlen = sizeof(int64) + sizeof(int64) + sizeof(int64);\n                if (len < hdrlen)\n                    ereport(ERROR,\n                            (errcode(ERRCODE_PROTOCOL_VIOLATION),\n                             errmsg_internal("invalid WAL message received from primary")));\n                appendBinaryStringInfo(&incoming_message, buf, hdrlen);\n\n                /* read the fields */\n                dataStart = pq_getmsgint64(&incoming_message);\n                walEnd = pq_getmsgint64(&incoming_message);\n                sendTime = pq_getmsgint64(&incoming_message);\n                ProcessWalSndrMessage(walEnd, sendTime);\n\n                buf += hdrlen;\n                len -= hdrlen;\n                XLogWalRcvWrite(buf, len, dataStart, tli);\n                break;\n            }\n        case \'k\':                /* Keepalive */\n            {\n                /* copy message to StringInfo */\n                hdrlen = sizeof(int64) + sizeof(int64) + sizeof(char);\n                if (len != hdrlen)\n                    ereport(ERROR,\n                            (errcode(ERRCODE_PROTOCOL_VIOLATION),\n                             errmsg_internal("invalid keepalive message received from primary")));\n                appendBinaryStringInfo(&incoming_message, buf, hdrlen);\n\n                /* read the fields */\n                walEnd = pq_getmsgint64(&incoming_message);\n                sendTime = pq_getmsgint64(&incoming_message);\n                replyRequested = pq_getmsgbyte(&incoming_message);\n\n                ProcessWalSndrMessage(walEnd, sendTime);\n\n                /* If the primary requested a reply, send one immediately */\n                if (replyRequested)\n                    XLogWalRcvSendReply(true, false);\n                break;\n            }\n        default:\n            ereport(ERROR,\n                    (errcode(ERRCODE_PROTOCOL_VIOLATION),\n                     errmsg_internal("invalid replication message type %d",\n                                     type)));\n    }\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u5982\u679c\u662fwal\u62a5\u6587\uff0c\u5219\u8fdb\u884c\u5199\u5165\uff1b\u5982\u679c\u662f\u5fc3\u8df3\u62a5\u6587\u9700\u8981\u8fdb\u4e00\u6b65\u8bfb\u53d6\u62a5\u6587\u7684\u6700\u540e\u4e00\u4e2a\u5b57\u8282\u662f\u5426\u4e3a1\uff0c\u4e3a1\u8868\u793a\u9700\u8981\u56de\u590d\u5fc3\u8df3\u62a5\u6587\u3002"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"\u5f53\u4e00\u6b21\u6570\u636e\u6536\u53d6\u7ed3\u675f\u540e\uff08socket\u7684buffer\u4e2d\u6ca1\u6709\u6570\u636e\uff09\uff0c\u6b64\u65f6walreceiver\u4e5f\u9700\u8981\u8fdb\u884c\u56de\u590d\uff0c\u901a\u77e5walsender\u6536\u5230\u4e86\u6570\u636e\uff1b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"                    /* Let the primary know that we received some data. */\n                    XLogWalRcvSendReply(false, false);\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"\u540c\u65f6\u5982\u679c\u5199\u5165\u4e86\u6570\u636e\uff0c\u9700\u8981\u5c06\u6570\u636eflush\u5230\u78c1\u76d8"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"                    /*\n                     * If we've written some records, flush them to disk and\n                     * let the startup process and primary server know about\n                     * them.\n                     */\n                    XLogWalRcvFlush(false, startpointTLI);\n"})}),"\n"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);